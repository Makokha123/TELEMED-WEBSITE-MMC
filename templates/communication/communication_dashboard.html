{% extends "base.html" %}

{% block title %}Consultation - MAKOKHA MEDICAL CENTRE{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background: linear-gradient(135deg, #00a884 0%, #1e2a3a 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .whatsapp-container {
        display: flex;
        height: 90vh;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 5px 40px 16px rgba(82, 98, 130, 0.1);
    }

    /* Left Sidebar - Appointments List */
    .appointments-sidebar {
        width: 380px;
        background: #f0f2f5;
        border-right: 1px solid #e5e5e5;
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 20px 16px;
        background: #f0f2f5;
        border-bottom: 1px solid #e5e5e5;
    }

    .sidebar-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .sidebar-header-top h5 {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        color: #111b21;
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .profile-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-avatar.initials {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .online-indicator {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 14px;
        height: 14px;
        background: #31a24c;
        border: 2px solid white;
        border-radius: 50%;
    }

    .online-indicator.offline {
        background: #a0a0a0;
    }

    .sidebar-actions {
        display: flex;
        gap: 8px;
    }

    .sidebar-action-btn {
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #54656f;
        font-size: 20px;
        transition: background-color 0.2s;
    }

    .sidebar-action-btn:hover {
        background-color: #e9ecef;
    }

    .search-container {
        padding: 8px 12px;
    }

    .search-box {
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 24px;
        padding: 10px 16px;
        width: 100%;
        font-size: 14px;
        color: #111b21;
    }

    .search-box::placeholder {
        color: #999;
    }

    .appointments-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        background: white;
    }

    .appointments-list::-webkit-scrollbar {
        width: 6px;
    }

    .appointments-list::-webkit-scrollbar-track {
        background: transparent;
    }

    .appointments-list::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    .appointment-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f5f5f5;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    .appointment-item:hover {
        background-color: #f5f5f5;
    }

    .appointment-item.active {
        background-color: #e7f3ff;
    }

    .appointment-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
    }

    .appointment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .appointment-avatar.initials {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
    }

    .appointment-content {
        flex: 1;
        min-width: 0;
    }

    .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .appointment-name {
        font-weight: 600;
        color: #111b21;
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .appointment-time {
        font-size: 12px;
        color: #999;
        flex-shrink: 0;
    }

    .appointment-preview {
        font-size: 13px;
        color: #667781;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .unread-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #25d366;
        color: white;
        font-size: 12px;
        font-weight: 600;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 4px;
        display: inline-block;
    }

    .status-indicator.online {
        background: #31a24c;
    }

    .status-indicator.offline {
        background: #a0a0a0;
    }

    /* Right Chat Area */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #efeae2;
        position: relative;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2300a884' fill-opacity='0.04' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    .chat-header {
        padding: 10px 16px;
        background: #f0f2f5;
        border-bottom: 1px solid #e5e5e5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 60px;
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        min-width: 0;
    }

    .chat-header-info {
        min-width: 0;
    }

    .chat-header-name {
        font-weight: 600;
        color: #111b21;
        font-size: 16px;
        margin: 0;
    }

    .chat-header-status {
        font-size: 13px;
        color: #667781;
        margin: 0;
    }

    .chat-header-actions {
        display: flex;
        gap: 10px;
    }

    .chat-action-btn {
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #54656f;
        font-size: 20px;
        transition: background-color 0.2s;
    }

    .chat-action-btn:hover {
        background-color: #e9ecef;
    }

    /* Chat Messages Area */
    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    /* Message Bubbles */
    .message-wrapper {
        display: flex;
        margin-bottom: 8px;
        max-width: 100%;
    }

    .message-wrapper.sent {
        justify-content: flex-end;
    }

    .message-wrapper.received {
        justify-content: flex-start;
    }

    .message-container {
        max-width: 65%;
        display: flex;
        flex-direction: column;
    }

    .message-bubble {
        padding: 8px 12px;
        border-radius: 7.5px;
        font-size: 14.2px;
        line-height: 19px;
        word-wrap: break-word;
        position: relative;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }

    .message-bubble.sent {
        background: #d9fdd3;
        color: #111b21;
        border-radius: 7.5px 7.5px 0 7.5px;
        margin-left: auto;
        border: 1px solid #d1f7c4;
    }

    .message-bubble.received {
        background: white;
        color: #111b21;
        border-radius: 7.5px 7.5px 7.5px 0;
        margin-right: auto;
        border: 1px solid #e9edef;
    }

    .message-time {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
        margin-top: 2px;
        font-size: 11px;
        color: #667781;
        padding: 0 4px;
    }

    .message-status {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .tick {
        font-size: 14px;
        line-height: 1;
    }

    .tick.single {
        color: #667781;
    }

    .tick.double.grey {
        color: #667781;
    }

    .tick.double.blue {
        color: #53bdeb;
    }

    /* Message Content Types */
    .message-text {
        white-space: pre-wrap;
        word-break: break-word;
    }

    .message-file {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 5px;
        margin-top: 4px;
    }

    .message-file i {
        font-size: 24px;
        color: #54656f;
    }

    .message-file a {
        color: #007bff;
        text-decoration: none;
        font-weight: 500;
    }

    .message-file a:hover {
        text-decoration: underline;
    }

    .voice-message {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 5px;
    }

    .voice-message i {
        font-size: 20px;
        color: #54656f;
        cursor: pointer;
    }

    .voice-waveform {
        flex: 1;
        height: 20px;
        background: linear-gradient(90deg, #54656f 0%, #54656f 50%, transparent 50%);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }

    .voice-duration {
        font-size: 12px;
        color: #54656f;
        font-weight: 500;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: white;
        border-radius: 7.5px 7.5px 7.5px 0;
        width: fit-content;
        border: 1px solid #e9edef;
        margin-bottom: 8px;
    }

    .typing-text {
        font-size: 12px;
        color: #667781;
        font-style: italic;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 6px;
        height: 6px;
        background: #667781;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    /* Chat Input Area */
    .chat-input-area {
        padding: 10px 16px;
        background: #f0f2f5;
        border-top: 1px solid #e5e5e5;
        display: flex;
        gap: 10px;
        align-items: center;
        min-height: 62px;
    }

    .input-action-btn {
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #54656f;
        font-size: 22px;
        transition: background-color 0.2s;
    }

    .input-action-btn:hover {
        background-color: #e9ecef;
    }

    .input-action-btn.recording {
        color: #f44336;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .message-input-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        background: white;
        border-radius: 24px;
        padding: 5px 12px;
        border: 1px solid #e5e5e5;
    }

    .message-input {
        flex: 1;
        border: none;
        padding: 10px 8px;
        font-size: 15px;
        font-family: inherit;
        resize: none;
        max-height: 100px;
        outline: none;
        background: transparent;
        color: #111b21;
    }

    .message-input::placeholder {
        color: #999;
    }

    .input-emoji-btn {
        background: none;
        border: none;
        color: #54656f;
        font-size: 22px;
        cursor: pointer;
        padding: 0 8px;
    }

    .send-btn {
        background: #25d366;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    .send-btn:hover {
        background: #1da851;
    }

    .send-btn:disabled {
        background: #a0a0a0;
        cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #667781;
        gap: 16px;
        text-align: center;
        padding: 40px;
    }

    .empty-state-icon {
        font-size: 80px;
        color: #ddd;
    }

    .empty-state-text {
        font-size: 16px;
        font-weight: 500;
        color: #667781;
    }

    .empty-state-subtext {
        font-size: 14px;
        color: #999;
    }

    /* Recording UI */
    .recording-ui {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 16px;
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
    }

    .recording-timer {
        font-size: 14px;
        font-weight: 600;
        color: #f44336;
    }

    .recording-wave {
        flex: 1;
        height: 30px;
        background: linear-gradient(90deg, #f44336 0%, #f44336 50%, transparent 50%);
        border-radius: 15px;
        position: relative;
        overflow: hidden;
    }

    .recording-actions {
        display: flex;
        gap: 8px;
    }

    .recording-action-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: #54656f;
        font-size: 18px;
    }

    .recording-action-btn.send {
        color: #25d366;
    }

    .recording-action-btn.cancel {
        color: #f44336;
    }

    /* Payment Overlay */
    .payment-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 40px;
        text-align: center;
    }

    .payment-icon {
        font-size: 64px;
        color: #ffc107;
        margin-bottom: 20px;
    }

    .payment-message {
        max-width: 400px;
    }

    .payment-message h4 {
        color: #333;
        margin-bottom: 12px;
    }

    .payment-message p {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
    }

    /* Date Separator */
    .date-separator {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 16px 0;
    }

    .date-label {
        background: rgba(0, 0, 0, 0.1);
        padding: 4px 12px;
        border-radius: 14px;
        font-size: 12px;
        color: #667781;
        font-weight: 500;
    }

    /* Loading Animation */
    .loading-messages {
        display: flex;
        justify-content: center;
        padding: 20px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #25d366;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .whatsapp-container {
            height: calc(100vh - 40px);
        }
        
        .appointments-sidebar {
            width: 100%;
        }
        
        .chat-area {
            display: none;
        }
        
        .chat-area.active {
            display: flex;
        }
        
        .back-to-list {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="whatsapp-container">
    <!-- Left Sidebar - Appointments List -->
    <div class="appointments-sidebar" id="appointmentsSidebar">
        <div class="sidebar-header">
            <div class="sidebar-header-top">
                <h5>Messages</h5>
                <div class="sidebar-actions">
                    <div class="user-profile">
                        <div class="profile-avatar" id="userProfileAvatar">
                            <!-- Profile picture will be loaded here -->
                        </div>
                    </div>
                    <button class="sidebar-action-btn" title="Status">
                        <i class="fas fa-circle"></i>
                    </button>
                    <button class="sidebar-action-btn" title="New chat">
                        <i class="fas fa-comment-medical"></i>
                    </button>
                    <button class="sidebar-action-btn" title="Menu">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
            <div class="search-container">
                <input type="text" class="search-box" id="searchAppointments" placeholder="Search or start new chat">
            </div>
        </div>

        <div class="appointments-list" id="appointmentsList">
            <!-- Appointments will be loaded here -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="empty-state-text">No appointments yet</div>
                <div class="empty-state-subtext">Your consultation messages will appear here</div>
            </div>
        </div>
    </div>

        <!-- Insert Call Logs Partial -->
        <div style="position: absolute; top: 20px; right: 20px; width: 360px; z-index: 30;">
            {% include 'communication/_call_logs_partial.html' %}
        </div>

    <!-- Right Chat Area -->
    <div class="chat-area" id="chatArea">
        <!-- Chat Header -->
        <div class="chat-header" id="chatHeader">
            <div class="chat-header-left">
                <div class="back-to-list" id="backToList" style="display: none;">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="profile-avatar" id="chatAvatar">
                    <!-- Profile picture will be loaded here -->
                </div>
                <div class="chat-header-info">
                    <h6 class="chat-header-name" id="chatHeaderName">Select an appointment</h6>
                    <p class="chat-header-status" id="chatHeaderStatus">Start a conversation</p>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="chat-action-btn" id="openCallLogsHeaderBtn" title="Call logs" data-bs-toggle="modal" data-bs-target="#callLogsModal" style="margin-right:6px; background: linear-gradient(135deg,#198754 0%,#157347 100%); color: #fff; border: none;">
                    <i class="fas fa-list"></i>
                </button>
                <button class="chat-action-btn" id="voiceCallBtn" title="Voice call">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="chat-action-btn" id="videoCallBtn" title="Video call">
                    <i class="fas fa-video"></i>
                </button>
                <button class="chat-action-btn" id="infoBtn" title="Appointment info">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <div class="empty-state-text">Select an appointment to start messaging</div>
                <div class="empty-state-subtext">Send messages, voice notes, and files securely</div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span class="typing-text" id="typingUser">Someone is typing...</span>
        </div>

        <!-- Message Input Area -->
        <div class="chat-input-area" id="chatInputArea">
            <button class="input-action-btn" id="emojiBtn" title="Emoji">
                <i class="far fa-smile"></i>
            </button>
            
            <button class="input-action-btn" id="attachBtn" title="Attach file">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt,.xlsx,.mp3,.wav,.mp4">
            
            <div class="message-input-wrapper">
                <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." disabled>
                <button class="input-emoji-btn" id="emojiPickerBtn">
                    <i class="far fa-smile"></i>
                </button>
            </div>
            
            <button class="input-action-btn" id="voiceRecordBtn" title="Record voice note">
                <i class="fas fa-microphone"></i>
            </button>
            
            <button class="send-btn" id="sendMessageBtn" title="Send message" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

        <!-- Recording UI -->
        <div class="recording-ui" id="recordingUI" style="display: none;">
            <div class="recording-timer" id="recordingTimer">00:00</div>
            <div class="recording-wave" id="recordingWave"></div>
            <div class="recording-actions">
                <button class="recording-action-btn cancel" id="cancelRecordingBtn" title="Cancel">
                    <i class="fas fa-times"></i>
                </button>
                <button class="recording-action-btn send" id="sendRecordingBtn" title="Send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Payment Overlay -->
        <div class="payment-overlay" id="paymentOverlay" style="display: none;">
            <div class="payment-icon">
                <i class="fas fa-lock"></i>
            </div>
            <div class="payment-message">
                <h4>Payment Required</h4>
                <p>Please complete your payment to unlock messaging features for this consultation.</p>
                <button class="btn btn-primary" id="goToPaymentBtn">
                    <i class="fas fa-credit-card me-2"></i>
                    Complete Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden elements for data -->
<input type="hidden" id="currentAppointmentId" value="{{ appointment.id if appointment else '' }}">
<input type="hidden" id="currentUserId" value="{{ current_user.id }}">
<input type="hidden" id="currentUserRole" value="{{ current_user.role }}">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

<!-- Audio element for voice messages -->
<audio id="voicePlayer" style="display: none;"></audio>
{% endblock %}

{% block extra_js %}
<!-- Updated emoji picker import with fallback -->
<script>
// Try to load emoji picker dynamically with error handling
function loadEmojiPicker() {
    const script = document.createElement('script');
    script.type = 'module';
    script.innerHTML = `
        try {
            import('https://cdn.jsdelivr.net/npm/emoji-picker-element@latest/dist/index.js')
                .then(() => {
                    console.log('Emoji picker loaded successfully');
                    // Setup emoji picker after it's loaded
                    if (typeof setupEmojiPicker === 'function') {
                        setupEmojiPicker();
                    }
                })
                .catch(error => {
                    console.warn('Emoji picker failed to load, continuing without it:', error);
                });
        } catch (e) {
            console.warn('Emoji picker import failed:', e);
        }
    `;
    document.head.appendChild(script);
}
</script>

<script>
// Safe storage utility to handle Tracking Prevention
const safeStorage = {
    getItem: function(key) {
        try {
            return sessionStorage.getItem(key);
        } catch (e) {
            console.warn('sessionStorage blocked by tracking prevention, using fallback');
            return window[`__storage_${key}`] || null;
        }
    },
    setItem: function(key, value) {
        try {
            sessionStorage.setItem(key, value);
        } catch (e) {
            console.warn('sessionStorage blocked, using fallback storage');
            window[`__storage_${key}`] = value;
        }
    },
    removeItem: function(key) {
        try {
            sessionStorage.removeItem(key);
        } catch (e) {
            delete window[`__storage_${key}`];
        }
    }
};

// Safely get CSRF token and user data
function getCsrfToken() {
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    return csrfInput ? csrfInput.value : '';
}

function getCurrentUserId() {
    const userIdElement = document.getElementById('currentUserId');
    return userIdElement ? parseInt(userIdElement.value) : null;
}

function getCurrentUserRole() {
    const roleElement = document.getElementById('currentUserRole');
    return roleElement ? roleElement.value : null;
}

const csrfToken = getCsrfToken();
const currentUserId = getCurrentUserId();
const currentUserRole = getCurrentUserRole();

// Validate required data
if (!currentUserId) {
    console.error('Current user ID not found');
}

if (!currentUserRole) {
    console.error('Current user role not found');
}

// Global state
let selectedAppointmentId = null;
let selectedDoctorId = null;
let selectedDoctorData = null;
let selectedAppointmentData = null;
let isRecording = false;
let recordingStartTime = null;
let recordingTimer = null;
let mediaRecorder = null;
let recordedChunks = [];
let isTyping = false;
let typingTimeout = null;
let paymentStatus = 'pending';

// Initialize with safety checks
document.addEventListener('DOMContentLoaded', function() {
    console.log('Communication page initializing...');
    
    if (!currentUserId || !currentUserRole) {
        console.error('Missing user data, cannot initialize');
        showErrorMessage('User data missing. Please refresh the page.');
        return;
    }
    
    loadUserProfilePicture();
    loadDoctors();
    setupEventListeners();
    setupSocketIO();
    
    // Load emoji picker after a short delay
    setTimeout(loadEmojiPicker, 500);
});

// Load patient's profile picture with better error handling
function loadUserProfilePicture() {
    if (!currentUserId) {
        console.error('Cannot load profile picture: user ID missing');
        return;
    }
    
    const profileAvatar = document.getElementById('userProfileAvatar');
    if (!profileAvatar) {
        console.error('Profile avatar element not found');
        return;
    }
    
    // Show loading state
    profileAvatar.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px;"></div>';
    
    // Try multiple endpoints
    const tryLoadProfile = async () => {
        const endpoints = [
            `/api/user/${currentUserId}/profile`,
            `/profile_picture/${currentUserId}`,
            `/api/user/${currentUserId}/basic-info`
        ];
        
        for (const endpoint of endpoints) {
            try {
                console.log(`Trying endpoint: ${endpoint}`);
                const response = await fetch(endpoint);
                if (response.ok) {
                    if (endpoint.includes('/api/')) {
                        const data = await response.json();
                        if (data.profile_picture_url) {
                            return { type: 'image', url: data.profile_picture_url };
                        } else if (data.name) {
                            return { type: 'initials', name: data.name };
                        }
                    } else {
                        // Direct profile picture endpoint
                        return { type: 'image', url: endpoint };
                    }
                }
            } catch (error) {
                console.log(`Failed to load from ${endpoint}:`, error);
            }
        }
        return null;
    };
    
    tryLoadProfile().then(result => {
        if (result) {
            if (result.type === 'image' && result.url) {
                profileAvatar.innerHTML = `<img src="${result.url}" alt="Profile" 
                    onerror="this.onerror=null; this.parentElement.innerHTML='${getInitials(result.name || 'PT')}'; this.parentElement.classList.add('initials');">`;
                profileAvatar.classList.remove('initials');
            } else {
                const initials = getInitials(result.name || 'PT');
                profileAvatar.textContent = initials;
                profileAvatar.classList.add('initials');
            }
        } else {
            // Fallback
            profileAvatar.textContent = 'PT';
            profileAvatar.classList.add('initials');
        }
    }).catch(error => {
        console.error('Error loading profile picture:', error);
        profileAvatar.textContent = 'PT';
        profileAvatar.classList.add('initials');
    });
}

// Load doctors with appointments - with better error handling
function loadDoctors() {
    console.log('Loading doctors...');
    
    const list = document.getElementById('appointmentsList');
    if (!list) {
        console.error('Appointments list element not found');
        return;
    }
    
    // Show loading state
    list.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-spinner fa-spin"></i></div>
            <div class="empty-state-text">Loading doctors...</div>
        </div>
    `;
    
    fetch('/api/patient/appointments')
        .then(response => {
            if (!response.ok) {
                if (response.status === 500) {
                    throw new Error('Server error loading appointments');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Appointments data received:', data);
            
            list.innerHTML = '';
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-user-md"></i></div>
                        <div class="empty-state-text">No doctors yet</div>
                        <div class="empty-state-subtext">Your doctor consultations will appear here</div>
                    </div>
                `;
                return;
            }

            // Sort appointments by appointment date (descending - closest upcoming first)
            const sortedAppointments = [...data].sort((a, b) => {
                const dateA = new Date(a.appointment_date || 0);
                const dateB = new Date(b.appointment_date || 0);
                return dateB - dateA; // Descending order (newest first)
            });

            // Create appointment items - each appointment separately
            sortedAppointments.forEach(appointmentData => {
                if (!appointmentData || typeof appointmentData !== 'object') {
                    console.warn('Invalid appointment data:', appointmentData);
                    return;
                }
                
                const doctor = appointmentData.doctor;
                if (!doctor) {
                    console.warn('Appointment data missing doctor:', appointmentData);
                    return;
                }
                
                const item = createDoctorItem(doctor, appointmentData);
                if (item) {
                    list.appendChild(item);
                }
            });
        })
        .catch(error => {
            console.error('Error loading doctors:', error);
            if (list) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="empty-state-text">Error loading doctors</div>
                        <div class="empty-state-subtext">Please try refreshing the page</div>
                        <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                `;
            }
        });
}

// Create appointment item with full details
function createDoctorItem(doctor, appointmentData) {
    try {
        const div = document.createElement('div');
        div.className = 'appointment-item';
        
        // Get doctor ID from appointmentData (which is the single appointment record)
        const appointmentId = appointmentData?.appointment_id;
        const doctorId = doctor?.id;
        if (!appointmentId || !doctorId) {
            console.error('Appointment ID or Doctor ID is missing:', appointmentData);
            return null;
        }
        
        div.dataset.appointmentId = appointmentId;
        div.dataset.doctorId = doctorId;
        div.dataset.paymentStatus = appointmentData?.payment_status || 'pending';
        
        // Safely get doctor name
        const firstName = doctor?.first_name || '';
        const lastName = doctor?.last_name || '';
        const name = `Dr. ${firstName} ${lastName}`.trim();
        const avatarText = getInitials(name);
        
        // Safely get profile picture
        const profilePictureUrl = doctor?.profile_picture_url || 
                                 appointmentData?.doctor?.profile_picture_url;
        
        // Safely get online status
        const isOnline = doctor?.is_online || false;
        
        // Safely get appointment details
        const appointmentDate = appointmentData?.appointment_date ? new Date(appointmentData.appointment_date) : null;
        const lastMessageTime = appointmentData?.last_message_time || '';
        const lastMessage = appointmentData?.last_message || 'No messages yet';
        const specialization = doctor?.specialization || 'General Practitioner';
        const paymentStatus = appointmentData?.payment_status || 'pending';
        const unreadCount = appointmentData?.unread_count || 0;
        const consultationType = appointmentData?.consultation_type || 'Consultation';
        const appointmentStatus = appointmentData?.status || '';
        
        // Format appointment date for display
        let appointmentDateDisplay = '';
        if (appointmentDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (appointmentDate.toDateString() === today.toDateString()) {
                appointmentDateDisplay = 'Today ' + appointmentData.appointment_time;
            } else if (appointmentDate.toDateString() === tomorrow.toDateString()) {
                appointmentDateDisplay = 'Tomorrow ' + appointmentData.appointment_time;
            } else {
                appointmentDateDisplay = appointmentDate.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + appointmentData.appointment_time;
            }
        }
        
        div.innerHTML = `
            <div class="appointment-avatar ${profilePictureUrl ? '' : 'initials'}" 
                 data-profile-picture="${profilePictureUrl || ''}">
                ${profilePictureUrl ? `<img src="${profilePictureUrl}" alt="${name}" onerror="handleProfilePictureError(this)">` : avatarText}
                ${isOnline ? '<div class="online-indicator"></div>' : '<div class="online-indicator offline"></div>'}
            </div>
            <div class="appointment-content">
                <div class="appointment-header">
                    <span class="appointment-name">${escapeHtml(name)}</span>
                    <span class="appointment-time">${escapeHtml(lastMessageTime)}</span>
                </div>
                <div class="appointment-preview">${escapeHtml(lastMessage)}</div>
                <div class="appointment-details">
                    <small class="text-muted">
                        ${escapeHtml(specialization)} • ${escapeHtml(appointmentDateDisplay)}
                        <span class="payment-badge ms-2 ${paymentStatus === 'paid' ? 'paid' : 'pending'}">
                            ${paymentStatus === 'paid' ? '✓ Paid' : 'Payment Pending'}
                        </span>
                    </small>
                </div>
            </div>
            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
        `;
        
        // Load profile picture if available
        if (profilePictureUrl) {
            setTimeout(() => {
                const avatar = div.querySelector('.appointment-avatar');
                if (avatar && avatar.dataset.profilePicture) {
                    const img = document.createElement('img');
                    img.src = avatar.dataset.profilePicture;
                    img.alt = name;
                    img.onload = () => {
                        if (avatar) {
                            avatar.innerHTML = '';
                            avatar.appendChild(img);
                            const indicator = document.createElement('div');
                            indicator.className = isOnline ? 'online-indicator' : 'online-indicator offline';
                            avatar.appendChild(indicator);
                        }
                    };
                    img.onerror = () => {
                        if (avatar) {
                            avatar.textContent = avatarText;
                            avatar.classList.add('initials');
                            const indicator = document.createElement('div');
                            indicator.className = isOnline ? 'online-indicator' : 'online-indicator offline';
                            avatar.appendChild(indicator);
                        }
                    };
                }
            }, 100);
        }
        
        div.addEventListener('click', () => {
            if (appointmentId) {
                selectAppointment(appointmentId, doctor, appointmentData);
            }
        });
        return div;
    } catch (error) {
        console.error('Error creating appointment item:', error);
        return null;
    }
}

// Handle profile picture error
function handleProfilePictureError(imgElement) {
    const avatar = imgElement.parentElement;
    if (avatar && avatar.classList.contains('appointment-avatar')) {
        const name = imgElement.alt || 'Dr';
        const initials = getInitials(name);
        avatar.innerHTML = initials;
        avatar.classList.add('initials');
    }
}

// Select appointment
function selectAppointment(appointmentId, doctorData, appointmentData) {
    console.log('Selecting appointment:', appointmentId);
    
    selectedDoctorId = doctorData?.id;
    selectedDoctorData = doctorData;
    selectedAppointmentId = appointmentId;
    
    // Update selected state
    document.querySelectorAll('.appointment-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.appointmentId === appointmentId.toString()) {
            item.classList.add('active');
            paymentStatus = item.dataset.paymentStatus || 'pending';
        }
    });
    
    // Update UI for mobile
    if (window.innerWidth <= 768) {
        const appointmentsSidebar = document.getElementById('appointmentsSidebar');
        const chatArea = document.getElementById('chatArea');
        const backToList = document.getElementById('backToList');
        
        if (appointmentsSidebar) appointmentsSidebar.style.display = 'none';
        if (chatArea) chatArea.style.display = 'flex';
        if (backToList) backToList.style.display = 'flex';
    }
    
    // Load appointment details
    loadAppointmentDetails(appointmentId);
}

function loadAppointmentDetails(appointmentId) {
                console.error('Error getting latest appointment:', error);
                showNoAppointmentMessage();
            
    
}

// Load appointment details
function loadAppointmentDetails(appointmentId) {
    console.log('Loading appointment details:', appointmentId);
    
    fetch(`/api/appointment/${appointmentId}/details`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to load appointment details: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Update chat header
            const chatHeaderName = document.getElementById('chatHeaderName');
            const chatHeaderStatus = document.getElementById('chatHeaderStatus');
            const chatAvatar = document.getElementById('chatAvatar');
            
            if (!chatHeaderName || !chatHeaderStatus || !chatAvatar) {
                console.error('Chat header elements not found');
                return;
            }
            
            const firstName = data.doctor_first_name || '';
            const lastName = data.doctor_last_name || '';
            const name = `Dr. ${firstName} ${lastName}`.trim();
            const avatarText = getInitials(name);
            const isOnline = data.doctor_online || false;
            const consultationType = data.consultation_type || 'Consultation';
            
            chatHeaderName.textContent = name;
            chatHeaderStatus.innerHTML = `
                <span class="status-indicator ${isOnline ? 'online' : 'offline'}"></span>
                ${isOnline ? 'Online' : 'Offline'} • ${escapeHtml(consultationType)}
            `;
            
            // Load profile picture
            if (data.doctor_profile_picture) {
                chatAvatar.innerHTML = `<img src="${data.doctor_profile_picture}" alt="${name}" onerror="handleChatAvatarError(this)">`;
                chatAvatar.classList.remove('initials');
            } else {
                chatAvatar.textContent = avatarText;
                chatAvatar.classList.add('initials');
            }
            
            // Check payment status
            checkPaymentStatus(appointmentId);
            
            // Load messages
            loadMessages(appointmentId);
            
            // Enable input
            const messageInput = document.getElementById('messageInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            
            if (messageInput) messageInput.disabled = false;
            if (sendMessageBtn) sendMessageBtn.disabled = false;
            
            // Join socket room
            if (typeof socket !== 'undefined' && socket.connected) {
                socket.emit('join_appointment', { appointment_id: appointmentId });
            }
        })
        .catch(error => {
            console.error('Error loading appointment details:', error);
            showErrorMessage('Failed to load appointment details. Please try again.');
        });
}

// Handle chat avatar error
function handleChatAvatarError(imgElement) {
    const avatar = imgElement.parentElement;
    if (avatar && avatar.id === 'chatAvatar') {
        const chatHeaderName = document.getElementById('chatHeaderName');
        const name = chatHeaderName ? chatHeaderName.textContent : 'Dr';
        const initials = getInitials(name);
        avatar.innerHTML = initials;
        avatar.classList.add('initials');
    }
}

// Show error message
function showErrorMessage(message) {
    const messagesArea = document.getElementById('chatMessages');
    if (messagesArea) {
        messagesArea.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="empty-state-text">Error</div>
                <div class="empty-state-subtext">${escapeHtml(message)}</div>
                <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
            </div>
        `;
    }
}

// Check payment status
function checkPaymentStatus(appointmentId) {
    fetch(`/api/appointment/${appointmentId}/payment-status`)
        .then(response => response.json())
        .then(data => {
            paymentStatus = data.payment_status || 'pending';
            
            const paymentOverlay = document.getElementById('paymentOverlay');
            const messageInput = document.getElementById('messageInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const attachBtn = document.getElementById('attachBtn');
            const voiceRecordBtn = document.getElementById('voiceRecordBtn');
            const voiceCallBtn = document.getElementById('voiceCallBtn');
            const videoCallBtn = document.getElementById('videoCallBtn');
            
            if (data.payment_required && paymentStatus !== 'paid') {
                if (paymentOverlay) paymentOverlay.style.display = 'flex';
                if (messageInput) messageInput.disabled = true;
                if (sendMessageBtn) sendMessageBtn.disabled = true;
                if (attachBtn) attachBtn.disabled = true;
                if (voiceRecordBtn) voiceRecordBtn.disabled = true;
                if (voiceCallBtn) voiceCallBtn.disabled = true;
                if (videoCallBtn) videoCallBtn.disabled = true;
                
                // Set payment URL
                const goToPaymentBtn = document.getElementById('goToPaymentBtn');
                if (goToPaymentBtn) {
                    goToPaymentBtn.onclick = () => {
                        window.open(data.payment_url || `/payment/appointment/${appointmentId}`, '_blank');
                    };
                }
            } else {
                if (paymentOverlay) paymentOverlay.style.display = 'none';
                if (messageInput) messageInput.disabled = false;
                if (sendMessageBtn) sendMessageBtn.disabled = false;
                if (attachBtn) attachBtn.disabled = false;
                if (voiceRecordBtn) voiceRecordBtn.disabled = false;
                if (voiceCallBtn) voiceCallBtn.disabled = false;
                if (videoCallBtn) videoCallBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
}

// Load messages with WhatsApp-style formatting
function loadMessages(appointmentId) {
    const messagesArea = document.getElementById('chatMessages');
    if (!messagesArea) {
        console.error('Messages area not found');
        return;
    }
    
    messagesArea.innerHTML = '<div class="loading-messages"><div class="loading-spinner"></div></div>';
    
    fetch(`/api/appointment/${appointmentId}/messages`)
        .then(response => response.json())
        .then(data => {
            messagesArea.innerHTML = '';
            
            if (!data.messages || data.messages.length === 0) {
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-comment-dots"></i></div>
                        <div class="empty-state-text">No messages yet</div>
                        <div class="empty-state-subtext">Send a message to start the conversation</div>
                    </div>
                `;
                return;
            }
            
            let currentDate = null;
            
            data.messages.forEach(message => {
                const messageDate = new Date(message.timestamp);
                const messageDay = messageDate.toDateString();
                
                // Add date separator if new day
                if (currentDate !== messageDay) {
                    currentDate = messageDay;
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'date-separator';
                    dateSeparator.innerHTML = `<span class="date-label">${formatDate(messageDate)}</span>`;
                    messagesArea.appendChild(dateSeparator);
                }
                
                // Create message element
                const messageElement = createMessageElement(message);
                messagesArea.appendChild(messageElement);
            });
            
            // Scroll to bottom
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Mark messages as read
            markMessagesAsRead(appointmentId);
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            messagesArea.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="empty-state-text">Error loading messages</div>
                    <div class="empty-state-subtext">${escapeHtml(error.message || 'Unknown error')}</div>
                </div>
            `;
        });
}

// Create message element with WhatsApp styling
function createMessageElement(message) {
    const isSent = message.sender_id === currentUserId;
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    wrapper.setAttribute('data-message-id', message.id);
    
    const container = document.createElement('div');
    container.className = 'message-container';
    
    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
    
    // Message content based on type
    if (message.message_type === 'text') {
        bubble.innerHTML = `<div class="message-text">${escapeHtml(message.content || '')}</div>`;
    } else if (message.message_type === 'voice_note') {
        bubble.innerHTML = createVoiceMessageHTML(message);
    } else if (message.message_type === 'document' || message.message_type === 'image') {
        bubble.innerHTML = createFileMessageHTML(message);
    } else {
        bubble.innerHTML = `<div class="message-text">${escapeHtml(message.content || '')}</div>`;
    }
    
    // Message time and status
    const timeElement = document.createElement('div');
    timeElement.className = 'message-time';
    timeElement.setAttribute('data-timestamp', message.timestamp);
    timeElement.setAttribute('data-timestamp-format', 'timeonly');
    
    // Use LocalTime utility for formatting
    const timeString = window.LocalTime ? window.LocalTime.formatToLocalTime(message.timestamp, 'timeonly') : new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    let statusHTML = '';
    if (isSent) {
        statusHTML = getMessageStatusHTML(message.message_status || 'sent');
    }
    
    timeElement.innerHTML = `${timeString} ${statusHTML}`;
    
    container.appendChild(bubble);
    container.appendChild(timeElement);
    wrapper.appendChild(container);
    
    return wrapper;
}

// Create voice message HTML
function createVoiceMessageHTML(message) {
    const duration = message.duration || '0:00';
    const fileUrl = message.file_url || '';
    return `
        <div class="voice-message">
            <i class="fas fa-play-circle play-voice" data-url="${escapeHtml(fileUrl)}"></i>
            <div class="voice-waveform"></div>
            <span class="voice-duration">${escapeHtml(duration)}</span>
        </div>
    `;
}

// Create file message HTML
function createFileMessageHTML(message) {
    const fileName = message.file_name || 'File';
    const fileSize = message.file_size ? formatFileSize(message.file_size) : '';
    const isImage = message.message_type === 'image';
    const fileUrl = message.file_url || '#';
    
    if (isImage) {
        return `
            <div class="message-file">
                <img src="${escapeHtml(fileUrl)}" alt="${escapeHtml(fileName)}" style="max-width: 200px; border-radius: 5px;" onerror="this.style.display='none'">
                <div>
                    <div><strong>${escapeHtml(fileName)}</strong></div>
                    ${fileSize ? `<div><small>${escapeHtml(fileSize)}</small></div>` : ''}
                </div>
            </div>
        `;
    } else {
        return `
            <div class="message-file">
                <i class="fas fa-file"></i>
                <div>
                    <div><a href="${escapeHtml(fileUrl)}" target="_blank">${escapeHtml(fileName)}</a></div>
                    ${fileSize ? `<div><small>${escapeHtml(fileSize)}</small></div>` : ''}
                </div>
            </div>
        `;
    }
}

// Get message status HTML (WhatsApp-style ticks)
function getMessageStatusHTML(status) {
    switch(status) {
        case 'sending':
            return '<span class="tick single" style="opacity: 0.5;">✓</span>';
        case 'sent':
            return '<span class="tick single">✓</span>';
        case 'delivered':
            return '<span class="tick double grey">✓✓</span>';
        case 'read':
            return '<span class="tick double blue">✓✓</span>';
        case 'failed':
            return '<span class="tick single" style="color: red;">✗</span>';
        default:
            return '<span class="tick single">✓</span>';
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Format date for separator
function formatDate(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) {
        return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
    } else {
        return date.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
    }
}

// Show no appointment message
function showNoAppointmentMessage() {
    const messagesArea = document.getElementById('chatMessages');
    if (!messagesArea) return;
    
    messagesArea.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-calendar-plus"></i></div>
            <div class="empty-state-text">No active consultation</div>
            <div class="empty-state-subtext">Book an appointment with this doctor</div>
            <button class="btn btn-primary mt-3" id="bookAppointmentBtn">
                <i class="fas fa-calendar me-2"></i>Book Appointment
            </button>
        </div>
    `;
    
    const bookAppointmentBtn = document.getElementById('bookAppointmentBtn');
    if (bookAppointmentBtn) {
        bookAppointmentBtn.addEventListener('click', bookAppointment);
    }
}

// Book appointment
function bookAppointment() {
    if (!selectedDoctorId) return;
    
    window.location.href = `/patient/appointment?doctor_id=${selectedDoctorId}`;
}

// Setup event listeners with patient-specific features
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Send message
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const messageInput = document.getElementById('messageInput');
    
    if (sendMessageBtn && messageInput) {
        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Typing indicator
        messageInput.addEventListener('input', function(e) {
            if (!selectedAppointmentId) return;
            
            // Send typing indicator
            if (!isTyping) {
                isTyping = true;
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('typing', {
                        appointment_id: selectedAppointmentId
                    });
                }
            }
            
            // Clear existing timeout
            clearTimeout(typingTimeout);
            
            // Set timeout to stop typing indicator
            typingTimeout = setTimeout(() => {
                isTyping = false;
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit('stop_typing', {
                        appointment_id: selectedAppointmentId
                    });
                }
            }, 1000);
        });
    }
    
    // Voice recording
    const voiceRecordBtn = document.getElementById('voiceRecordBtn');
    const cancelRecordingBtn = document.getElementById('cancelRecordingBtn');
    const sendRecordingBtn = document.getElementById('sendRecordingBtn');
    
    if (voiceRecordBtn) voiceRecordBtn.addEventListener('click', toggleRecording);
    if (cancelRecordingBtn) cancelRecordingBtn.addEventListener('click', cancelRecording);
    if (sendRecordingBtn) sendRecordingBtn.addEventListener('click', sendRecording);
    
    // File attachment
    const attachBtn = document.getElementById('attachBtn');
    const fileInput = document.getElementById('fileInput');
    
    if (attachBtn) {
        attachBtn.addEventListener('click', () => {
            if (fileInput) fileInput.click();
        });
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', handleFileUpload);
    }
    
    // Voice call
    const voiceCallBtn = document.getElementById('voiceCallBtn');
    if (voiceCallBtn) voiceCallBtn.addEventListener('click', initiateVoiceCall);
    
    // Video call
    const videoCallBtn = document.getElementById('videoCallBtn');
    if (videoCallBtn) videoCallBtn.addEventListener('click', initiateVideoCall);
    
    // Back to list (mobile)
    const backToList = document.getElementById('backToList');
    if (backToList) {
        backToList.addEventListener('click', () => {
            const appointmentsSidebar = document.getElementById('appointmentsSidebar');
            const chatArea = document.getElementById('chatArea');
            
            if (appointmentsSidebar) appointmentsSidebar.style.display = 'flex';
            if (chatArea) chatArea.style.display = 'none';
            backToList.style.display = 'none';
        });
    }
    
    // Search - FIXED: searchDoctors instead of searchAppointments
    const searchDoctors = document.getElementById('searchDoctors');
    if (searchDoctors) {
        searchDoctors.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.appointment-item').forEach(item => {
                const nameElement = item.querySelector('.appointment-name');
                if (nameElement) {
                    const name = nameElement.textContent.toLowerCase();
                    item.style.display = name.includes(query) ? 'flex' : 'none';
                }
            });
        });
    }
    
    // Add patient-specific event listeners
    const infoBtn = document.getElementById('infoBtn');
    if (infoBtn) {
        infoBtn.addEventListener('click', showDoctorInfo);
    }
    
    // Play voice messages
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('play-voice')) {
            const audioUrl = e.target.dataset.url;
            if (audioUrl) {
                const player = document.getElementById('voicePlayer');
                if (player) {
                    player.src = audioUrl;
                    player.play().catch(error => {
                        console.error('Error playing voice message:', error);
                    });
                }
            }
        }
    });
    
    // Payment buttons
    const goToPaymentBtn = document.getElementById('goToPaymentBtn');
    const checkPaymentStatusBtn = document.getElementById('checkPaymentStatusBtn');
    
    if (goToPaymentBtn) {
        goToPaymentBtn.addEventListener('click', function() {
            if (selectedAppointmentId) {
                window.open(`/payment/appointment/${selectedAppointmentId}`, '_blank');
            }
        });
    }
    
    if (checkPaymentStatusBtn) {
        checkPaymentStatusBtn.addEventListener('click', function() {
            if (selectedAppointmentId) {
                checkPaymentStatus(selectedAppointmentId);
            }
        });
    }
    
    console.log('Event listeners setup complete');
}

// Show doctor info
function showDoctorInfo() {
    if (!selectedDoctorId) {
        alert('Please select a doctor first');
        return;
    }
    
    window.location.href = `/doctor/${selectedDoctorId}`;
}

// Setup emoji picker
function setupEmojiPicker() {
    try {
        const chatArea = document.getElementById('chatArea');
        if (!chatArea) {
            console.warn('Chat area not found for emoji picker');
            return;
        }
        
        const picker = document.createElement('emoji-picker');
        picker.style.position = 'absolute';
        picker.style.bottom = '70px';
        picker.style.right = '20px';
        picker.style.zIndex = '1000';
        picker.style.display = 'none';
        chatArea.appendChild(picker);
        
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPickerBtn = document.getElementById('emojiPickerBtn');
        
        if (emojiBtn) {
            emojiBtn.addEventListener('click', function() {
                picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
            });
        }
        
        if (emojiPickerBtn) {
            emojiPickerBtn.addEventListener('click', function() {
                picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
            });
        }
        
        picker.addEventListener('emoji-click', event => {
            const input = document.getElementById('messageInput');
            if (input) {
                input.value += event.detail.unicode;
                input.focus();
                picker.style.display = 'none';
            }
        });
        
        // Close picker when clicking outside
        document.addEventListener('click', function(e) {
            if (!picker.contains(e.target) && 
                e.target.id !== 'emojiBtn' && 
                e.target.id !== 'emojiPickerBtn' &&
                !e.target.closest('#emojiBtn') &&
                !e.target.closest('#emojiPickerBtn')) {
                picker.style.display = 'none';
            }
        });
        
        console.log('Emoji picker setup complete');
    } catch (error) {
        console.warn('Failed to setup emoji picker:', error);
    }
}

// Send message
function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input ? input.value.trim() : '';
    
    if (!content || !selectedAppointmentId) {
        console.warn('Cannot send message: missing content or appointment ID');
        return;
    }
    
    // Clear input immediately (UX improvement)
    if (input) input.value = '';
    
    // Clear typing indicator
    clearTimeout(typingTimeout);
    isTyping = false;
    if (typeof socket !== 'undefined' && socket.connected) {
        socket.emit('stop_typing', { appointment_id: selectedAppointmentId });
    }
    
    // Create temporary message for optimistic UI update
    const tempMessageId = 'temp_' + Date.now();
    const messageData = {
        id: tempMessageId,
        sender_id: currentUserId,
        content: content,
        message_type: 'text',
        timestamp: new Date().toISOString(),
        message_status: 'sending'
    };
    
    // Add message to UI immediately with sending status
    addMessageToUI(messageData);
    
    // Send via Socket.IO (primary method)
    if (typeof socket !== 'undefined' && socket.connected) {
        socket.emit('send_message', {
            appointment_id: selectedAppointmentId,
            content: content,
            message_type: 'text'
        }, function(response) {
            // Handle server acknowledgement
            if (response && response.success) {
                // Update temp message with real ID
                const tempMsg = document.querySelector(`[data-message-id="${tempMessageId}"]`);
                if (tempMsg) {
                    tempMsg.setAttribute('data-message-id', response.message_id);
                }
            }
        });
    } else {
        // Fallback to HTTP if Socket.IO not available
        console.warn('Socket.IO not connected, using HTTP fallback');
        fetch('/api/send-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                appointment_id: selectedAppointmentId,
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update temp message with real ID
                const tempMsg = document.querySelector(`[data-message-id="${tempMessageId}"]`);
                if (tempMsg) {
                    tempMsg.setAttribute('data-message-id', data.message_id);
                    updateMessageStatus(data.message_id, 'sent');
                }
            } else {
                console.error('Failed to send message:', data.error);
                updateMessageStatus(tempMessageId, 'failed');
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            updateMessageStatus(tempMessageId, 'failed');
        });
    }
}

// Toggle voice recording
function toggleRecording() {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecording();
    }
}

// Start voice recording
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();
        
        // Update UI
        const voiceRecordBtn = document.getElementById('voiceRecordBtn');
        const chatInputArea = document.getElementById('chatInputArea');
        const recordingUI = document.getElementById('recordingUI');
        
        if (voiceRecordBtn) voiceRecordBtn.classList.add('recording');
        if (chatInputArea) chatInputArea.style.display = 'none';
        if (recordingUI) recordingUI.style.display = 'flex';
        
        // Start timer
        updateRecordingTimer();
        recordingTimer = setInterval(updateRecordingTimer, 1000);
        
    } catch (error) {
        console.error('Error starting recording:', error);
        alert('Unable to access microphone. Please check permissions.');
    }
}

// Stop recording
function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        clearInterval(recordingTimer);
        
        // Update UI
        const voiceRecordBtn = document.getElementById('voiceRecordBtn');
        if (voiceRecordBtn) voiceRecordBtn.classList.remove('recording');
    }
}

// Cancel recording
function cancelRecording() {
    stopRecording();
    
    // Reset UI
    const chatInputArea = document.getElementById('chatInputArea');
    const recordingUI = document.getElementById('recordingUI');
    const recordingTimerElement = document.getElementById('recordingTimer');
    
    if (chatInputArea) chatInputArea.style.display = 'flex';
    if (recordingUI) recordingUI.style.display = 'none';
    if (recordingTimerElement) recordingTimerElement.textContent = '00:00';
}

// Send recording
function sendRecording() {
    if (recordedChunks.length === 0 || !selectedAppointmentId) {
        cancelRecording();
        return;
    }
    
    const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
    const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
    
    // Create form data
    const formData = new FormData();
    formData.append('appointment_id', selectedAppointmentId);
    formData.append('audio', audioBlob, 'voice-note.webm');
    formData.append('duration', duration);
    
    // Send to server
    fetch('/api/send-voice-note', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add voice message to UI
            const messageData = {
                id: data.message_id,
                sender_id: currentUserId,
                content: 'Voice message',
                message_type: 'voice_note',
                timestamp: new Date().toISOString(),
                message_status: 'sent',
                duration: formatDuration(duration),
                file_url: data.file_url
            };
            
            addMessageToUI(messageData);
        }
    })
    .catch(error => {
        console.error('Error sending voice note:', error);
        alert('Error sending voice note');
    })
    .finally(() => {
        cancelRecording();
    });
}

// Update recording timer
function updateRecordingTimer() {
    if (!recordingStartTime) return;
    
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    const recordingTimerElement = document.getElementById('recordingTimer');
    if (recordingTimerElement) {
        recordingTimerElement.textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// Format duration
function formatDuration(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// Handle file upload
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file || !selectedAppointmentId) return;
    
    // Validate file size (max 50MB)
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('File size exceeds 50MB limit. Please choose a smaller file.');
        event.target.value = '';
        return;
    }
    
    // Determine file type
    const fileType = file.type.startsWith('image/') ? 'image' : 'document';
    
    // Show upload progress feedback - no temp message, just indicate uploading via status
    const uploadId = 'upload_' + Date.now();
    
    // Upload file
    const formData = new FormData();
    formData.append('appointment_id', selectedAppointmentId);
    formData.append('file', file);
    
    fetch('/api/upload-file', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // File uploaded successfully
            // The backend already created the message and broadcast via Socket.IO
            // Just ensure the message appears with correct file_url
            console.log('File uploaded successfully:', data.message_id);
        } else {
            // Show error to user
            console.error('Upload failed:', data.error);
            alert('Failed to upload file: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error uploading file:', error);
        alert('Error uploading file: ' + error.message);
    });
    
    // Clear file input
    event.target.value = '';
}

// Initiate voice call
function initiateVoiceCall() {
    if (!selectedAppointmentId) {
        alert('Please select an appointment first');
        return;
    }
    
    if (typeof socket !== 'undefined' && socket.connected) {
        socket.emit('initiate_voice_call', {
            appointment_id: selectedAppointmentId
        });
    } else {
        alert('Connection not available. Please refresh the page.');
    }
}

// Initiate video call
function initiateVideoCall() {
    if (!selectedAppointmentId) {
        alert('Please select an appointment first');
        return;
    }
    
    if (typeof socket !== 'undefined' && socket.connected) {
        socket.emit('initiate_video_call', {
            appointment_id: selectedAppointmentId
        });
    } else {
        alert('Connection not available. Please refresh the page.');
    }
}

// Add message to UI
function addMessageToUI(messageData) {
    const messagesArea = document.getElementById('chatMessages');
    if (!messagesArea) return;
    
    // Remove empty state if present
    const emptyState = messagesArea.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const messageElement = createMessageElement(messageData);
    messagesArea.appendChild(messageElement);
    
    // Scroll to bottom
    messagesArea.scrollTop = messagesArea.scrollHeight;
    
    // Update last message in sidebar
    updateSidebarPreview(messageData);
}

// Update sidebar preview
function updateSidebarPreview(messageData) {
    if (!selectedAppointmentId || !selectedDoctorId) return;
    
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === selectedDoctorId.toString()) {
            const preview = item.querySelector('.appointment-preview');
            if (preview) {
                let previewText = '';
                if (messageData.message_type === 'text') {
                    previewText = messageData.content || '';
                } else if (messageData.message_type === 'voice_note') {
                    previewText = '🎤 Voice message';
                } else if (messageData.message_type === 'image') {
                    previewText = '📷 Photo';
                } else if (messageData.message_type === 'document') {
                    previewText = '📄 ' + (messageData.file_name || 'Document');
                }
                preview.textContent = previewText;
                
                // Update time
                const timeElement = item.querySelector('.appointment-time');
                if (timeElement) {
                    const now = new Date();
                    timeElement.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }
        }
    });
}

// Setup Socket.IO with patient-specific handlers
function setupSocketIO() {
    // Check if socket is already defined globally
    if (typeof io === 'undefined') {
        console.warn('Socket.IO library not loaded, will retry...');
        
        // Try again after a delay
        setTimeout(() => {
            if (typeof io !== 'undefined') {
                initializeSocket();
            } else {
                console.error('Socket.IO still not available after retry');
            }
        }, 1000);
        return;
    }
    
    initializeSocket();
}

function initializeSocket() {
    try {
        // Initialize socket with reconnection options
        window.socket = io({
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            timeout: 10000,
            transports: ['polling', 'websocket']
        });
        var socket = window.socket;
        
        socket.on('connect', function() {
            console.log('Connected to Socket.IO server');
            
            // Join any existing appointment room
            if (selectedAppointmentId) {
                socket.emit('join_appointment', { appointment_id: selectedAppointmentId });
            }
        });
        
        // Handle incoming messages
        socket.on('message_received', function(data) {
            if (data.appointment_id === selectedAppointmentId) {
                // Check if this message was already added via optimistic UI (sent by current user)
                if (data.sender_id === currentUserId) {
                    // This is our own message - update the temp message with real data
                    const messagesArea = document.getElementById('chatMessages');
                    if (messagesArea) {
                        const tempMessages = messagesArea.querySelectorAll('[data-message-id^="temp_"]');
                        if (tempMessages.length > 0) {
                            // Get the last temp message (most recent)
                            const lastTempMsg = tempMessages[tempMessages.length - 1];
                            lastTempMsg.setAttribute('data-message-id', data.id);
                            // Update status indicators
                            const timeElement = lastTempMsg.querySelector('.message-time');
                            if (timeElement) {
                                const statusHTML = getMessageStatusHTML(data.message_status || 'sent');
                                timeElement.innerHTML = timeElement.innerHTML.replace(/<span class="tick[^>]*>[^<]*<\/span>|<span style="color[^>]*>[^<]*<\/span>/, statusHTML);
                            }
                        }
                    }
                } else {
                    // This is a message from someone else - add it to UI
                    addMessageToUI(data);
                }
                
                // Mark as delivered if from other user
                if (data.sender_id !== currentUserId) {
                    socket.emit('message_delivered', {
                        message_id: data.id,
                        appointment_id: data.appointment_id
                    });
                }
            } else {
                // Update unread count for other appointments
                updateUnreadCount(data.appointment_id);
            }
        });
        
        // Handle message status updates
        socket.on('message_status_updated', function(data) {
            updateMessageStatus(data.message_id, data.status);
        });
        
        // Handle typing indicators
        socket.on('user_typing', function(data) {
            if (data.appointment_id === selectedAppointmentId && data.user_id !== currentUserId) {
                showTypingIndicator(data.user_name || 'Doctor');
            }
        });
        
        socket.on('user_stop_typing', function(data) {
            if (data.appointment_id === selectedAppointmentId) {
                hideTypingIndicator();
            }
        });
        
        // Handle calls
        socket.on('incoming_voice_call', function(data) {
            handleIncomingCall(data, 'voice');
        });
        
        socket.on('incoming_video_call', function(data) {
            handleIncomingCall(data, 'video');
        });
        
        // Add patient-specific handlers
        socket.on('doctor_online', function(data) {
            updateDoctorOnlineStatus(data.doctor_id, true);
        });
        
        socket.on('doctor_offline', function(data) {
            updateDoctorOnlineStatus(data.doctor_id, false);
        });
        
        // Listen for payment status updates
        socket.on('payment_status_updated', function(data) {
            if (data.appointment_id === selectedAppointmentId) {
                paymentStatus = data.status;
                checkPaymentStatus(selectedAppointmentId);
                
                // Update payment badge in sidebar
                updatePaymentBadge(data.status);
            }
        });
        
        // Handle connection errors
        socket.on('connect_error', function(error) {
            console.error('Socket.IO connection error:', error);
        });
        
        // Handle disconnection
        socket.on('disconnect', function() {
            console.log('Disconnected from Socket.IO server');
        });
        
        console.log('Socket.IO setup complete');
        
    } catch (error) {
        console.error('Error initializing Socket.IO:', error);
    }
}

// Mark messages as read
function markMessagesAsRead(appointmentId) {
    if (typeof socket !== 'undefined' && socket.connected) {
        socket.emit('message_read', {
            appointment_id: appointmentId
        });
    }
    
    // Update unread count in sidebar
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === selectedDoctorId?.toString()) {
            const badge = item.querySelector('.unread-badge');
            if (badge) {
                badge.remove();
            }
        }
    });
}

// Show typing indicator
function showTypingIndicator(userName) {
    const indicator = document.getElementById('typingIndicator');
    const typingUser = document.getElementById('typingUser');
    
    if (indicator && typingUser) {
        typingUser.textContent = `${userName} is typing...`;
        indicator.style.display = 'flex';
        
        // Auto-hide after 3 seconds
        setTimeout(hideTypingIndicator, 3000);
    }
}

// Hide typing indicator
function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

// Update message status
function updateMessageStatus(messageId, status) {
    // Find the specific message by ID
    const messageWrapper = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageWrapper) {
        const timeElement = messageWrapper.querySelector('.message-time');
        if (timeElement) {
            const statusHTML = getMessageStatusHTML(status);
            const currentHTML = timeElement.innerHTML;
            // Remove existing status and add new one
            const newHTML = currentHTML.replace(/<span class="tick[^>]*>[^<]*<\/span>|<span style="color[^>]*>[^<]*<\/span>/, statusHTML);
            timeElement.innerHTML = newHTML;
        }
    }
}

// Update unread count
function updateUnreadCount(appointmentId) {
    // Find the doctor for this appointment and update their unread count
    // This is a simplified implementation
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === selectedDoctorId?.toString()) {
            let badge = item.querySelector('.unread-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'unread-badge';
                badge.textContent = '1';
                item.appendChild(badge);
            } else {
                const count = parseInt(badge.textContent) + 1;
                badge.textContent = count;
            }
        }
    });
}

// Handle incoming call
function handleIncomingCall(data, callType) {
    // Use in-page overlays (no new window)
    const info = {
        id: data.id || data.call_id || data.callId,
        caller: data.caller || data.caller_id || data.from,
        callee: data.callee || data.callee_id || data.to,
        appointment_id: data.appointment_id || data.appointmentId,
        caller_name: data.caller_name || data.callerName || 'Caller',
        caller_role: data.caller_role || data.callerRole || 'Healthcare Provider',
        caller_profile_picture: data.caller_profile_picture || data.caller_profile_picture_url || null
    };

    if (callType === 'video') {
        try { showIncomingVideoOverlay(info); } catch (e) { console.error('showIncomingVideoOverlay failed', e); }
    } else {
        try { showIncomingVideoOverlay(info); } catch (e) { console.error('showIncomingVideoOverlay failed', e); }
    }

    // The overlay functions emit accept/reject/end events themselves; no setupIncomingCallHandlers needed.
}

function setupIncomingCallHandlers(data, callType) {
    // Listen for accept/reject from incoming call window
    const checkCallResponse = setInterval(() => {
        const callResponse = safeStorage.getItem('callResponse');
        
        if (callResponse) {
            clearInterval(checkCallResponse);
            
            if (callResponse === 'accepted') {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit(`accept_${callType}_call`, {
                        appointment_id: data.appointment_id
                    });
                }
                
                // Redirect based on call type
                setTimeout(() => {
                    if (callType === 'video') {
                        window.location.href = `/video-call/${data.appointment_id}`;
                    } else if (callType === 'voice') {
                        window.location.href = `/communication/${data.appointment_id}`;
                    }
                }, 500);
            } else if (callResponse === 'rejected') {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit(`reject_${callType}_call`, {
                        appointment_id: data.appointment_id
                    });
                }
            }
            
            safeStorage.removeItem('callResponse');
        }
    }, 100);
    
    // Timeout after 70 seconds (longer than call timeout)
    setTimeout(() => {
        clearInterval(checkCallResponse);
    }, 70000);
    
    // Timeout after 60 seconds
    setTimeout(() => {
        clearInterval(checkCallResponse);
        if (!safeStorage.getItem('callResponse')) {
            if (typeof socket !== 'undefined' && socket.connected) {
                socket.emit(`reject_${callType}_call`, {
                    appointment_id: data.appointment_id,
                    reason: 'timeout'
                });
            }
            safeStorage.removeItem('incomingCallData');
        }
    }, 60000);
}

// Update doctor online status
function updateDoctorOnlineStatus(doctorId, isOnline) {
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === doctorId.toString()) {
            const indicator = item.querySelector('.online-indicator');
            if (indicator) {
                indicator.className = isOnline ? 'online-indicator' : 'online-indicator offline';
            }
        }
    });
    
    // Update chat header if this is the current doctor
    if (selectedDoctorId === doctorId) {
        const statusElement = document.getElementById('chatHeaderStatus');
        if (statusElement) {
            const currentText = statusElement.textContent;
            const newText = currentText.replace(/Online|Offline/, isOnline ? 'Online' : 'Offline');
            statusElement.textContent = newText;
        }
    }
}

// Update payment badge
function updatePaymentBadge(status) {
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === selectedDoctorId?.toString()) {
            const paymentBadge = item.querySelector('.payment-badge');
            if (paymentBadge) {
                if (status === 'paid') {
                    paymentBadge.className = 'payment-badge ms-2 paid';
                    paymentBadge.textContent = '✓ Paid';
                } else {
                    paymentBadge.className = 'payment-badge ms-2 pending';
                    paymentBadge.textContent = 'Payment Pending';
                }
            }
        }
    });
}

// Helper functions
function getInitials(name) {
    if (!name) return 'PT';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize on DOM load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, initializing communication...');
    });
}
</script>
{% endblock %}