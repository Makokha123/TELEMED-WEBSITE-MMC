{% extends "base.html" %}

{% block title %}Documents - MAKOKHA MEDICAL CENTRE{% endblock %}

{% block extra_css %}
<style>
    .documents-container {
        min-height: 70vh;
    }
    .document-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    .document-card:hover {
        transform: translateY(-2px);
    }
    .document-icon {
        font-size: 2.5em;
        margin-bottom: 15px;
    }
    .file-type-pdf { color: #e74c3c; }
    .file-type-image { color: #3498db; }
    .file-type-word { color: #2c5aa0; }
    .file-type-excel { color: #217346; }
    .file-type-generic { color: #7f8c8d; }
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 40px 20px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .upload-area:hover {
        border-color: #007bff;
        background: #e7f3ff;
    }
    .upload-area.dragover {
        border-color: #007bff;
        background: #d1ecf1;
    }
    .document-preview {
        max-height: 200px;
        object-fit: cover;
        border-radius: 5px;
    }
    .file-size {
        font-size: 0.8em;
        color: #6c757d;
    }
    .action-buttons .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .document-categories {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2"><i class="fas fa-file-medical me-2"></i>Medical Documents</h1>
                    <p class="text-muted">Manage and share medical documents with healthcare providers</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-upload me-2"></i>Upload Document
                    </button>
                    <button class="btn btn-primary" onclick="createNewFolder()">
                        <i class="fas fa-folder-plus me-2"></i>New Folder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar - Document Categories -->
        <div class="col-lg-3 mb-4">
            <div class="document-categories">
                <h5 class="mb-3">Categories</h5>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action active">
                        <i class="fas fa-folder me-2"></i>All Documents
                        <span class="badge bg-primary float-end">24</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="fas fa-file-prescription me-2"></i>Prescriptions
                        <span class="badge bg-success float-end">8</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="fas fa-file-medical me-2"></i>Medical Reports
                        <span class="badge bg-info float-end">6</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="fas fa-x-ray me-2"></i>Lab Results
                        <span class="badge bg-warning float-end">5</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="fas fa-id-card me-2"></i>Insurance
                        <span class="badge bg-secondary float-end">3</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <i class="fas fa-history me-2"></i>Medical History
                        <span class="badge bg-dark float-end">2</span>
                    </a>
                </div>

                <hr class="my-4">

                <h6 class="mb-3">Storage</h6>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>15.2 GB of 20 GB used</small>
                        <small>76%</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: 76%"></div>
                    </div>
                </div>

                <div class="mt-4">
                    <h6>Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="shareDocuments()">
                            <i class="fas fa-share me-1"></i>Share Multiple
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="downloadAll()">
                            <i class="fas fa-download me-1"></i>Download All
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content - Documents Grid -->
        <div class="col-lg-9">
            <!-- Search and Filters -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" placeholder="Search documents...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select">
                        <option>All File Types</option>
                        <option>PDF</option>
                        <option>Images</option>
                        <option>Word</option>
                        <option>Excel</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select">
                        <option>Sort by Date</option>
                        <option>Sort by Name</option>
                        <option>Sort by Size</option>
                        <option>Sort by Type</option>
                    </select>
                </div>
            </div>

            <!-- Documents Grid -->
            <div class="row" id="documentsGrid">
                <!-- Document Card 1 -->
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card document-card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-file-pdf document-icon file-type-pdf"></i>
                            <h6 class="card-title">Blood Test Results</h6>
                            <p class="text-muted small mb-2">Lab Report • PDF</p>
                            <p class="file-size">2.4 MB</p>
                            <div class="mb-2">
                                <span class="badge bg-success">Lab Results</span>
                            </div>
                            <small class="text-muted">Uploaded: Jan 15, 2024</small>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100 action-buttons">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewDocument(1)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="downloadDocument(1)">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="shareDocument(1)">
                                    <i class="fas fa-share"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteDocument(1)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Card 2 -->
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card document-card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-file-prescription document-icon file-type-word"></i>
                            <h6 class="card-title">Medication Prescription</h6>
                            <p class="text-muted small mb-2">Doctor's Note • DOCX</p>
                            <p class="file-size">1.1 MB</p>
                            <div class="mb-2">
                                <span class="badge bg-primary">Prescription</span>
                            </div>
                            <small class="text-muted">Uploaded: Jan 12, 2024</small>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100 action-buttons">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewDocument(2)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="downloadDocument(2)">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="shareDocument(2)">
                                    <i class="fas fa-share"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteDocument(2)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Card 3 -->
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card document-card h-100">
                        <div class="card-body text-center">
                            <img src="https://via.placeholder.com/150" class="document-preview w-100 mb-2" alt="X-Ray Scan">
                            <h6 class="card-title">Chest X-Ray</h6>
                            <p class="text-muted small mb-2">Medical Image • JPG</p>
                            <p class="file-size">4.7 MB</p>
                            <div class="mb-2">
                                <span class="badge bg-info">Medical Reports</span>
                            </div>
                            <small class="text-muted">Uploaded: Jan 10, 2024</small>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100 action-buttons">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewDocument(3)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="downloadDocument(3)">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="shareDocument(3)">
                                    <i class="fas fa-share"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteDocument(3)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Card 4 -->
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                    <div class="card document-card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-file-excel document-icon file-type-excel"></i>
                            <h6 class="card-title">Health Metrics</h6>
                            <p class="text-muted small mb-2">Data Sheet • XLSX</p>
                            <p class="file-size">0.8 MB</p>
                            <div class="mb-2">
                                <span class="badge bg-warning">Lab Results</span>
                            </div>
                            <small class="text-muted">Uploaded: Jan 8, 2024</small>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100 action-buttons">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewDocument(4)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="downloadDocument(4)">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="shareDocument(4)">
                                    <i class="fas fa-share"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteDocument(4)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="row d-none" id="emptyState">
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
                        <h4>No documents found</h4>
                        <p class="text-muted">Upload your first medical document to get started.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload me-2"></i>Upload Document
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Medical Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <!-- Drag & Drop Area -->
                    <div class="upload-area" id="dropArea">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                        <h5>Drag & Drop Files Here</h5>
                        <p class="text-muted">or click to browse</p>
                        <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xls,.xlsx" style="display: none;">
                        <small class="text-muted">Max file size: 10MB • Supported: PDF, DOC, JPG, PNG, XLS</small>
                    </div>

                    <!-- Selected Files Preview -->
                    <div id="filePreview" class="mt-4" style="display: none;">
                        <h6>Selected Files:</h6>
                        <div id="fileList" class="list-group"></div>
                    </div>

                    <!-- Document Details -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Document Category</label>
                                <select class="form-select" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="prescription">Prescription</option>
                                    <option value="lab_results">Lab Results</option>
                                    <option value="medical_report">Medical Report</option>
                                    <option value="insurance">Insurance</option>
                                    <option value="medical_history">Medical History</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Privacy Level</label>
                                <select class="form-select" name="privacy">
                                    <option value="private">Private (Only Me)</option>
                                    <option value="doctors">My Doctors</option>
                                    <option value="shared">Shared with Specific</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Add a description for this document..."></textarea>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="encryptFile">
                        <label class="form-check-label" for="encryptFile">
                            Encrypt document for added security
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadDocuments()">Upload Documents</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // File upload drag and drop
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('dragover');
        }

        function unhighlight() {
            dropArea.classList.remove('dragover');
        }

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', handleFiles);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files } });
        }

        function handleFiles(e) {
            const files = e.target.files;
            if (files.length > 0) {
                showFilePreview(files);
            }
        }

        function showFilePreview(files) {
            const fileList = document.getElementById('fileList');
            const filePreview = document.getElementById('filePreview');
            
            fileList.innerHTML = '';
            filePreview.style.display = 'block';

            Array.from(files).forEach(file => {
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.innerHTML = `
                    <div>
                        <i class="fas fa-file ${getFileIconClass(file.name)} me-2"></i>
                        ${file.name}
                    </div>
                    <div>
                        <small class="text-muted me-2">${formatFileSize(file.size)}</small>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                fileList.appendChild(listItem);
            });
        }
    });

    function getFileIconClass(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        if (['pdf'].includes(ext)) return 'file-type-pdf';
        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'file-type-image';
        if (['doc', 'docx'].includes(ext)) return 'file-type-word';
        if (['xls', 'xlsx'].includes(ext)) return 'file-type-excel';
        return 'file-type-generic';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function removeFile(button) {
        button.closest('.list-group-item').remove();
        const fileList = document.getElementById('fileList');
        if (fileList.children.length === 0) {
            document.getElementById('filePreview').style.display = 'none';
        }
    }

    function uploadDocuments() {
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const files = fileInput.files;
        
        if (!files.length) {
            alert('Please select at least one file to upload');
            return;
        }
        
        const appointmentId = getAppointmentIdFromContext();
        if (!appointmentId) {
            alert('No appointment context found. Please navigate from a messaging window.');
            return;
        }
        
        const submitBtn = document.querySelector('#uploadModal .btn-primary');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
        submitBtn.disabled = true;
        
        uploadFilesSequentially(files, appointmentId, 0, submitBtn, form);
    }
    
    function uploadFilesSequentially(files, appointmentId, index, submitBtn, form) {
        if (index >= files.length) {
            alert('All documents uploaded successfully!');
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            form.reset();
            document.getElementById('filePreview').style.display = 'none';
            submitBtn.innerHTML = 'Upload Documents';
            submitBtn.disabled = false;
            return;
        }
        
        const file = files[index];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('appointment_id', appointmentId);
        
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        
        fetch('/api/upload-file', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`Uploaded: ${data.filename}`);
                uploadFilesSequentially(files, appointmentId, index + 1, submitBtn, form);
            } else {
                alert(`Failed to upload ${file.name}: ${data.error}`);
                submitBtn.innerHTML = 'Upload Documents';
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            alert(`Error uploading ${file.name}: ${error.message}`);
            submitBtn.innerHTML = 'Upload Documents';
            submitBtn.disabled = false;
        });
    }
    
    function getAppointmentIdFromContext() {
        const params = new URLSearchParams(window.location.search);
        if (params.has('appointment_id')) return params.get('appointment_id');
        
        const stored = sessionStorage.getItem('current_appointment_id');
        if (stored) return stored;
        
        return null;
    }

    function viewDocument(docId) {
        alert(`View document: ${docId}`);
        // Implement document viewing
    }

    function downloadDocument(docId) {
        alert(`Download document: ${docId}`);
        // Implement document download
    }

    function shareDocument(docId) {
        alert(`Share document: ${docId}`);
        // Implement document sharing
    }

    function deleteDocument(docId) {
        if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
            alert(`Delete document: ${docId}`);
            // Implement document deletion
        }
    }

    function createNewFolder() {
        const folderName = prompt('Enter folder name:');
        if (folderName) {
            alert(`Created folder: ${folderName}`);
            // Implement folder creation
        }
    }

    function shareDocuments() {
        alert('Share multiple documents functionality');
        // Implement multi-document sharing
    }

    function downloadAll() {
        alert('Download all documents functionality');
        // Implement bulk download
    }
</script>
{% endblock %}