{% extends "base.html" %}

{% block title %}My Patients - Doctor Dashboard{% endblock %}

{% block extra_css %}
<style>
    .patient-tabs .nav-link {
        border: none;
        padding: 1rem 1.5rem;
        font-weight: 500;
    }
    .patient-tabs .nav-link.active {
        border-bottom: 3px solid #007bff;
        color: #007bff;
        background: transparent;
    }
    .patient-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    .patient-card:hover {
        transform: translateY(-2px);
    }
    .patient-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2em;
    }
    .appointment-badge {
        font-size: 0.75em;
    }
    .medical-info {
        font-size: 0.9em;
    }
    .action-buttons .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">My Patients</h1>
                    <p class="text-muted">Manage your patients and their appointments.</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPatientModal">
                        <i class="fas fa-user-plus me-2"></i>Add Patient
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-tabs patient-tabs" id="patientTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" 
                                    data-bs-target="#upcoming" type="button" role="tab">
                                <i class="fas fa-clock me-2"></i>Upcoming Appointments
                                <span class="badge bg-primary ms-2">{{ upcoming|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pending-tab" data-bs-toggle="tab" 
                                    data-bs-target="#pending" type="button" role="tab">
                                <i class="fas fa-hourglass-half me-2"></i>Pending
                                <span class="badge bg-warning ms-2">{{ pending|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" 
                                    data-bs-target="#completed" type="button" role="tab">
                                <i class="fas fa-check-circle me-2"></i>Completed
                                <span class="badge bg-success ms-2">{{ completed|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="rescheduled-tab" data-bs-toggle="tab" 
                                    data-bs-target="#rescheduled" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-2"></i>Rescheduled
                                <span class="badge bg-info ms-2">{{ rescheduled|length }}</span>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="patientTabsContent">
        <!-- Upcoming Appointments Tab -->
        <div class="tab-pane fade show active" id="upcoming" role="tabpanel">
            <div class="row">
                {% if upcoming %}
                    {% for appointment in upcoming %}
                    <div class="col-xl-6 col-lg-12 mb-4">
                        <div class="card patient-card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <div class="patient-avatar">
                                            {{ appointment.patient.user.first_name[0] }}{{ appointment.patient.user.last_name[0] }}
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h5 class="card-title mb-1">
                                            {{ appointment.patient.user.first_name }} {{ appointment.patient.user.last_name }}
                                        </h5>
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ appointment.appointment_date.strftime('%B %d, %Y at %H:%M') }}
                                        </p>
                                        <div class="medical-info">
                                            {% if appointment.symptoms %}
                                            <p class="mb-1"><strong>Symptoms:</strong> {{ appointment.symptoms }}</p>
                                            {% endif %}
                                            {% if appointment.patient.blood_type %}
                                            <span class="badge appointment-badge bg-danger me-1">
                                                Blood: {{ appointment.patient.blood_type }}
                                            </span>
                                            {% endif %}
                                            {% if appointment.patient.allergies %}
                                            <span class="badge appointment-badge bg-warning me-1">
                                                Allergies
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge bg-{{ 'success' if appointment.consultation_type == 'video' else 'primary' if appointment.consultation_type == 'voice' else 'info' }} appointment-badge">
                                            {{ appointment.consultation_type|title if appointment.consultation_type else 'Message' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100 action-buttons">
                                        <button class="btn btn-outline-primary" 
                                            onclick="startConsultation('{{ appointment.id }}')">
                                        <i class="fas fa-play me-1"></i>Start Consultation
                                    </button>
                                        <button class="btn btn-outline-info" 
                                            onclick="sendMessage('{{ appointment.id }}')">
                                        <i class="fas fa-comment me-1"></i>Message
                                    </button>
                                        <button class="btn btn-outline-secondary" 
                                            onclick="rescheduleAppointment('{{ appointment.id }}')">
                                        <i class="fas fa-calendar-alt me-1"></i>Reschedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h4>No upcoming appointments</h4>
                        <p class="text-muted">Your upcoming appointments with patients will appear here.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Pending Appointments Tab -->
        <div class="tab-pane fade" id="pending" role="tabpanel">
            <div class="row">
                {% if pending %}
                    {% for appointment in pending %}
                    <div class="col-xl-6 col-lg-12 mb-4">
                        <div class="card patient-card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <div class="patient-avatar">
                                            {{ appointment.patient.user.first_name[0] }}{{ appointment.patient.user.last_name[0] }}
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h5 class="card-title mb-1">
                                            {{ appointment.patient.user.first_name }} {{ appointment.patient.user.last_name }}
                                        </h5>
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ appointment.appointment_date.strftime('%B %d, %Y at %H:%M') if appointment.appointment_date else 'Date pending' }}
                                        </p>
                                        <div class="medical-info">
                                            {% if appointment.symptoms %}
                                            <p class="mb-1"><strong>Symptoms:</strong> {{ appointment.symptoms|truncate(100) }}</p>
                                            {% endif %}
                                            {% if appointment.patient.blood_type %}
                                            <span class="badge appointment-badge bg-danger me-1">
                                                Blood: {{ appointment.patient.blood_type }}
                                            </span>
                                            {% endif %}
                                            {% if appointment.patient.allergies %}
                                            <span class="badge appointment-badge bg-warning me-1">
                                                Allergies
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge bg-warning appointment-badge">
                                            Pending
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100 action-buttons">
                                        <button class="btn btn-outline-primary" 
                                            onclick="confirmAppointment('{{ appointment.id }}')">
                                        <i class="fas fa-check me-1"></i>Confirm
                                    </button>
                                        <button class="btn btn-outline-info" 
                                            onclick="sendMessage('{{ appointment.id }}')">
                                        <i class="fas fa-comment me-1"></i>Message
                                    </button>
                                        <button class="btn btn-outline-secondary" 
                                            onclick="rescheduleAppointment('{{ appointment.id }}')">
                                        <i class="fas fa-calendar-alt me-1"></i>Reschedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-hourglass-half fa-3x text-muted mb-3"></i>
                        <h4>No pending appointments</h4>
                        <p class="text-muted">Pending appointment requests will appear here.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Completed Appointments Tab -->
        <div class="tab-pane fade" id="completed" role="tabpanel">
            <div class="row">
                {% if completed %}
                    {% for appointment in completed %}
                    <div class="col-xl-4 col-lg-6 mb-4">
                        <div class="card patient-card">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <div class="patient-avatar mx-auto mb-3">
                                        {{ appointment.patient.user.first_name[0] }}{{ appointment.patient.user.last_name[0] }}
                                    </div>
                                    <h5 class="card-title mb-1">
                                        {{ appointment.patient.user.first_name }} {{ appointment.patient.user.last_name }}
                                    </h5>
                                    <p class="text-muted mb-2">
                                        {{ appointment.appointment_date.strftime('%b %d, %Y') }}
                                    </p>
                                </div>
                                
                                <div class="medical-info mb-3">
                                    {% if appointment.symptoms %}
                                    <p class="mb-2"><strong>Presented with:</strong> {{ appointment.symptoms|truncate(80) }}</p>
                                    {% endif %}
                                    {% if appointment.notes %}
                                    <p class="mb-2"><strong>Notes:</strong> {{ appointment.notes|truncate(100) }}</p>
                                    {% endif %}
                                </div>

                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-success">Completed</span>
                                    <small class="text-muted">Duration: 25 min</small>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100 action-buttons">
                                        <button class="btn btn-outline-primary btn-sm" 
                                            onclick="viewConsultationDetails('{{ appointment.id }}')">
                                        <i class="fas fa-eye me-1"></i>Details
                                    </button>
                                        <button class="btn btn-outline-info btn-sm" 
                                            onclick="createFollowUp('{{ appointment.id }}')">
                                        <i class="fas fa-plus me-1"></i>Follow-up
                                    </button>
                                        <button class="btn btn-outline-success btn-sm" 
                                            onclick="downloadReport('{{ appointment.id }}')">
                                        <i class="fas fa-download me-1"></i>Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
                        <h4>No completed appointments</h4>
                        <p class="text-muted">Completed consultations will appear here.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Rescheduled Appointments Tab -->
        <div class="tab-pane fade" id="rescheduled" role="tabpanel">
            <div class="row">
                {% if rescheduled %}
                    {% for appointment in rescheduled %}
                    <div class="col-12 mb-3">
                        <div class="card patient-card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <div class="patient-avatar">
                                            {{ appointment.patient.user.first_name[0] }}{{ appointment.patient.user.last_name[0] }}
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h5 class="card-title mb-1">
                                            {{ appointment.patient.user.first_name }} {{ appointment.patient.user.last_name }}
                                        </h5>
                                        <p class="text-muted mb-1">
                                            <strong>Original:</strong> {{ appointment.appointment_date.strftime('%B %d, %Y at %H:%M') }}
                                        </p>
                                        <p class="text-muted mb-0">
                                            <strong>New Date:</strong> 
                                            <span class="text-warning">To be confirmed</span>
                                        </p>
                                    </div>
                                    <div class="col-auto">
                                        <span class="badge bg-warning">Rescheduled</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100 action-buttons">
                                        <button class="btn btn-outline-primary" 
                                            onclick="confirmNewTime('{{ appointment.id }}')">
                                        <i class="fas fa-calendar-check me-1"></i>Confirm Time
                                    </button>
                                        <button class="btn btn-outline-info" 
                                            onclick="contactPatient('{{ appointment.patient.id }}')">
                                        <i class="fas fa-phone me-1"></i>Contact
                                    </button>
                                        <button class="btn btn-outline-danger" 
                                            onclick="cancelAppointment('{{ appointment.id }}')">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                        <h4>No rescheduled appointments</h4>
                        <p class="text-muted">Rescheduled appointments will appear here.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Patient Modal -->
<div class="modal fade" id="addPatientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPatientForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label class="form-label">Search Existing Patient</label>
                        <input type="text" class="form-control" placeholder="Enter patient name or email...">
                        <small class="text-muted">Search for existing patients in the system</small>
                    </div>
                    <div class="text-center my-3">OR</div>
                    <div class="mb-3">
                        <label class="form-label">Create New Patient Record</label>
                        <input type="email" class="form-control" placeholder="Patient email address">
                        <small class="text-muted">An invitation will be sent to the patient</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Add Patient</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function startConsultation(appointmentId) {
        window.location.href = `/communication/appointment/${appointmentId}`;
    }

    function sendMessage(appointmentId) {
        window.location.href = `/communication/appointment/${appointmentId}`;
    }

    function rescheduleAppointment(appointmentId) {
        alert('Reschedule appointment: ' + appointmentId);
        // Implement reschedule functionality
    }

    function viewConsultationDetails(appointmentId) {
        alert('View consultation details: ' + appointmentId);
        // Implement view details functionality
    }

    function createFollowUp(appointmentId) {
        alert('Create follow-up: ' + appointmentId);
        // Implement follow-up creation
    }

    function downloadReport(appointmentId) {
        alert('Download report: ' + appointmentId);
        // Implement report download
    }

    function confirmNewTime(appointmentId) {
        alert('Confirm new time: ' + appointmentId);
        // Implement time confirmation
    }

    function contactPatient(patientId) {
        alert('Contact patient: ' + patientId);
        // Implement patient contact
    }

    function cancelAppointment(appointmentId) {
        if (confirm('Are you sure you want to cancel this appointment?')) {
            alert('Cancel appointment: ' + appointmentId);
            // Implement cancellation
        }
    }
</script>
{% endblock %}