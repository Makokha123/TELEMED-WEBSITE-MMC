{% extends "base.html" %}

{% block title %}Doctor Communications - MAKOKHA MEDICAL CENTRE{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background: linear-gradient(135deg, #00a884 0%, #1e2a3a 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .whatsapp-container {
        display: flex;
        height: 90vh;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 5px 40px 16px rgba(82, 98, 130, 0.1);
    }

    /* Left Sidebar - Appointments List */
    .appointments-sidebar {
        width: 380px;
        background: #f0f2f5;
        border-right: 1px solid #e5e5e5;
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 20px 16px;
        background: #f0f2f5;
        border-bottom: 1px solid #e5e5e5;
    }

    .sidebar-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .sidebar-header-top h5 {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        color: #111b21;
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .profile-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-avatar.initials {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .online-indicator {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 14px;
        height: 14px;
        background: #31a24c;
        border: 2px solid white;
        border-radius: 50%;
    }

    .online-indicator.offline {
        background: #a0a0a0;
    }

    .sidebar-actions {
        display: flex;
        gap: 8px;
    }

    .sidebar-action-btn {
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #54656f;
        font-size: 20px;
        transition: background-color 0.2s;
    }

    .sidebar-action-btn:hover {
        background-color: #e9ecef;
    }

    .search-container {
        padding: 8px 12px;
    }

    .search-box {
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 24px;
        padding: 10px 16px;
        width: 100%;
        font-size: 14px;
        color: #111b21;
    }

    .search-box::placeholder {
        color: #999;
    }

    .appointments-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        background: white;
    }

    .appointments-list::-webkit-scrollbar {
        width: 6px;
    }

    .appointments-list::-webkit-scrollbar-track {
        background: transparent;
    }

    .appointments-list::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    .appointment-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f5f5f5;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    .appointment-item:hover {
        background-color: #f5f5f5;
    }

    .appointment-item.active {
        background-color: #e7f3ff;
    }

    .appointment-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
    }

    .appointment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .appointment-avatar.initials {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
    }

    .appointment-content {
        flex: 1;
        min-width: 0;
    }

    .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .appointment-name {
        font-weight: 600;
        color: #111b21;
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .appointment-time {
        font-size: 12px;
        color: #999;
        flex-shrink: 0;
    }

    .appointment-preview {
        font-size: 13px;
        color: #667781;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .unread-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #25d366;
        color: white;
        font-size: 12px;
        font-weight: 600;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 4px;
        display: inline-block;
    }

    .status-indicator.online {
        background: #31a24c;
    }

    .status-indicator.offline {
        background: #a0a0a0;
    }

    /* Right Chat Area */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #efeae2;
        position: relative;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2300a884' fill-opacity='0.04' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    .chat-header {
        padding: 10px 16px;
        background: #f0f2f5;
        border-bottom: 1px solid #e5e5e5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 60px;
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        min-width: 0;
    }

    .chat-header-info {
        min-width: 0;
    }

    .chat-header-name {
        font-weight: 600;
        color: #111b21;
        font-size: 16px;
        margin: 0;
    }

    .chat-header-status {
        font-size: 13px;
        color: #667781;
        margin: 0;
    }

    .chat-header-actions {
        display: flex;
        gap: 10px;
    }

    .chat-action-btn {
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #54656f;
        font-size: 20px;
        transition: background-color 0.2s;
    }

    .chat-action-btn:hover {
        background-color: #e9ecef;
    }

    /* Chat Messages Area */
    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    /* Message Bubbles */
    .message-wrapper {
        display: flex;
        margin-bottom: 8px;
        max-width: 100%;
    }

    .message-wrapper.sent {
        justify-content: flex-end;
    }

    .message-wrapper.received {
        justify-content: flex-start;
    }

    .message-container {
        max-width: 65%;
        display: flex;
        flex-direction: column;
    }

    .message-bubble {
        padding: 8px 12px;
        border-radius: 7.5px;
        font-size: 14.2px;
        line-height: 19px;
        word-wrap: break-word;
        position: relative;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }

    .message-bubble.sent {
        background: #d9fdd3;
        color: #111b21;
        border-radius: 7.5px 7.5px 0 7.5px;
        margin-left: auto;
        border: 1px solid #d1f7c4;
    }

    .message-bubble.received {
        background: white;
        color: #111b21;
        border-radius: 7.5px 7.5px 7.5px 0;
        margin-right: auto;
        border: 1px solid #e9edef;
    }

    .message-time {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
        margin-top: 2px;
        font-size: 11px;
        color: #667781;
        padding: 0 4px;
    }

    .message-status {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .tick {
        font-size: 14px;
        line-height: 1;
    }

    .tick.single {
        color: #667781;
    }

    .tick.double.grey {
        color: #667781;
    }

    .tick.double.blue {
        color: #53bdeb;
    }

    /* Message Content Types */
    .message-text {
        white-space: pre-wrap;
        word-break: break-word;
    }

    .message-file {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 5px;
        margin-top: 4px;
    }

    .message-file i {
        font-size: 24px;
        color: #54656f;
    }

    .message-file a {
        color: #007bff;
        text-decoration: none;
        font-weight: 500;
    }

    .message-file a:hover {
        text-decoration: underline;
    }

    .voice-message {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 5px;
    }

    .voice-message i {
        font-size: 20px;
        color: #54656f;
        cursor: pointer;
    }

    .voice-waveform {
        flex: 1;
        height: 20px;
        background: linear-gradient(90deg, #54656f 0%, #54656f 50%, transparent 50%);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }

    .voice-duration {
        font-size: 12px;
        color: #54656f;
        font-weight: 500;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: white;
        border-radius: 7.5px 7.5px 7.5px 0;
        width: fit-content;
        border: 1px solid #e9edef;
        margin-bottom: 8px;
    }

    .typing-text {
        font-size: 12px;
        color: #667781;
        font-style: italic;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 6px;
        height: 6px;
        background: #667781;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    /* Chat Input Area */
    .chat-input-area {
        padding: 10px 16px;
        background: #f0f2f5;
        border-top: 1px solid #e5e5e5;
        display: flex;
        gap: 10px;
        align-items: center;
        min-height: 62px;
    }

    .input-action-btn {
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #54656f;
        font-size: 22px;
        transition: background-color 0.2s;
    }

    .input-action-btn:hover {
        background-color: #e9ecef;
    }

    .input-action-btn.recording {
        color: #f44336;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .message-input-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        background: white;
        border-radius: 24px;
        padding: 5px 12px;
        border: 1px solid #e5e5e5;
    }

    .message-input {
        flex: 1;
        border: none;
        padding: 10px 8px;
        font-size: 15px;
        font-family: inherit;
        resize: none;
        max-height: 100px;
        outline: none;
        background: transparent;
        color: #111b21;
    }

    .message-input::placeholder {
        color: #999;
    }

    .input-emoji-btn {
        background: none;
        border: none;
        color: #54656f;
        font-size: 22px;
        cursor: pointer;
        padding: 0 8px;
    }

    .send-btn {
        background: #25d366;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    .send-btn:hover {
        background: #1da851;
    }

    .send-btn:disabled {
        background: #a0a0a0;
        cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #667781;
        gap: 16px;
        text-align: center;
        padding: 40px;
    }

    .empty-state-icon {
        font-size: 80px;
        color: #ddd;
    }

    .empty-state-text {
        font-size: 16px;
        font-weight: 500;
        color: #667781;
    }

    .empty-state-subtext {
        font-size: 14px;
        color: #999;
    }
    .doctor-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
    }
    
    .prescription-btn {
        background: #ffc107;
        color: #333;
    }
    
    .prescription-btn:hover {
        background: #e0a800;
    }
    
    .medical-record-btn {
        background: #17a2b8;
        color: white;
    }
    
    .medical-record-btn:hover {
        background: #138496;
    }
    /* Recording UI */
    .recording-ui {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 16px;
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
    }

    .recording-timer {
        font-size: 14px;
        font-weight: 600;
        color: #f44336;
    }

    .recording-wave {
        flex: 1;
        height: 30px;
        background: linear-gradient(90deg, #f44336 0%, #f44336 50%, transparent 50%);
        border-radius: 15px;
        position: relative;
        overflow: hidden;
    }

    .recording-actions {
        display: flex;
        gap: 8px;
    }

    .recording-action-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: #54656f;
        font-size: 18px;
    }

    .recording-action-btn.send {
        color: #25d366;
    }

    .recording-action-btn.cancel {
        color: #f44336;
    }

    /* Payment Overlay */
    .payment-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 40px;
        text-align: center;
    }

    .payment-icon {
        font-size: 64px;
        color: #ffc107;
        margin-bottom: 20px;
    }

    .payment-message {
        max-width: 400px;
    }

    .payment-message h4 {
        color: #333;
        margin-bottom: 12px;
    }

    .payment-message p {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
    }

    /* Date Separator */
    .date-separator {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 16px 0;
    }

    .date-label {
        background: rgba(0, 0, 0, 0.1);
        padding: 4px 12px;
        border-radius: 14px;
        font-size: 12px;
        color: #667781;
        font-weight: 500;
    }

    /* Loading Animation */
    .loading-messages {
        display: flex;
        justify-content: center;
        padding: 20px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #25d366;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .whatsapp-container {
            height: calc(100vh - 40px);
        }
        
        .appointments-sidebar {
            width: 100%;
        }
        
        .chat-area {
            display: none;
        }
        
        .chat-area.active {
            display: flex;
        }
        
        .back-to-list {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
        }
    }

</style>
{% endblock %}

{% block content %}
<div class="whatsapp-container">
    <!-- Left Sidebar - Patients List -->
    <div class="appointments-sidebar" id="appointmentsSidebar">
        <div class="sidebar-header">
            <div class="sidebar-header-top">
                <h5>My Patients <span class="doctor-badge">DR</span></h5>
                <div class="sidebar-actions">
                    <div class="user-profile">
                        <div class="profile-avatar" id="userProfileAvatar">
                            <!-- Profile picture will be loaded here -->
                        </div>
                    </div>
                    <button class="sidebar-action-btn" title="Contact Admin" id="contactAdminBtn">
                        <i class="fas fa-shield-alt"></i>
                    </button>
                    <button class="sidebar-action-btn" title="Status">
                        <i class="fas fa-circle"></i>
                    </button>
                    <button class="sidebar-action-btn" title="New consultation">
                        <i class="fas fa-comment-medical"></i>
                    </button>
                    <button class="sidebar-action-btn" title="Menu">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
            <div class="search-container">
                <input type="text" class="search-box" id="searchPatients" placeholder="Search patients...">
            </div>
        </div>

        <div class="appointments-list" id="patientsList">
            <!-- Patients will be loaded here -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-user-injured"></i>
                </div>
                <div class="empty-state-text">No patients yet</div>
                <div class="empty-state-subtext">Your patient consultations will appear here</div>
            </div>
        </div>
    </div>

    <!-- Right Chat Area -->
    <div class="chat-area" id="chatArea">
        <!-- Chat Header -->
        <div class="chat-header" id="chatHeader">
            <div class="chat-header-left">
                <div class="back-to-list" id="backToList" style="display: none;">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="profile-avatar" id="chatAvatar">
                    <!-- Patient profile picture will be loaded here -->
                </div>
                <div class="chat-header-info">
                    <h6 class="chat-header-name" id="chatHeaderName">Select a patient</h6>
                    <p class="chat-header-status" id="chatHeaderStatus">Start a consultation</p>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="chat-action-btn prescription-btn" id="prescriptionBtn" title="Create prescription">
                    <i class="fas fa-prescription"></i>
                </button>
                <button class="chat-action-btn medical-record-btn" id="medicalRecordBtn" title="Add medical record">
                    <i class="fas fa-file-medical"></i>
                </button>
                <button class="chat-action-btn" id="openCallLogsHeaderBtn" title="Call logs" data-bs-toggle="modal" data-bs-target="#callLogsModal" style="margin-right:6px; background: linear-gradient(135deg,#198754 0%,#157347 100%); color: #fff; border: none;">
                    <i class="fas fa-list"></i>
                </button>
                <button class="chat-action-btn" id="voiceCallBtn" title="Voice call">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="chat-action-btn" id="videoCallBtn" title="Video call">
                    <i class="fas fa-video"></i>
                </button>
                <button class="chat-action-btn" id="infoBtn" title="Patient info">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <div class="empty-state-text">Select a patient to start consultation</div>
                <div class="empty-state-subtext">Send messages, prescriptions, and medical notes securely</div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span class="typing-text" id="typingUser">Patient is typing...</span>
        </div>

        <!-- Message Input Area -->
        <div class="chat-input-area" id="chatInputArea">
            <button class="input-action-btn" id="emojiBtn" title="Emoji">
                <i class="far fa-smile"></i>
            </button>
            
            <button class="input-action-btn" id="attachBtn" title="Attach file">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt,.xlsx,.mp3,.wav,.mp4">
            
            <div class="message-input-wrapper">
                <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." disabled>
                <button class="input-emoji-btn" id="emojiPickerBtn">
                    <i class="far fa-smile"></i>
                </button>
            </div>
            
            <button class="input-action-btn" id="voiceRecordBtn" title="Record voice note">
                <i class="fas fa-microphone"></i>
            </button>
            
            <button class="send-btn" id="sendMessageBtn" title="Send message" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

        <!-- Recording UI -->
        <div class="recording-ui" id="recordingUI" style="display: none;">
            <div class="recording-timer" id="recordingTimer">00:00</div>
            <div class="recording-wave" id="recordingWave"></div>
            <div class="recording-actions">
                <button class="recording-action-btn cancel" id="cancelRecordingBtn" title="Cancel">
                    <i class="fas fa-times"></i>
                </button>
                <button class="recording-action-btn send" id="sendRecordingBtn" title="Send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Call logs panel -->
        <div style="position: absolute; top: 24px; right: 24px; width: 360px; z-index: 40;">
            {% include 'communication/_call_logs_partial.html' %}
        </div>

<!-- Payment Overlay -->
<div class="payment-overlay" id="paymentOverlay" style="display: none;">
    <div class="payment-icon">
        <i class="fas fa-lock"></i>
    </div>
    <div class="payment-message">
        <h4>Complete Payment to Unlock Features</h4>
        <p>Please complete your payment to access messaging, voice calls, video calls, and file sharing for this consultation.</p>
        <button class="btn btn-primary" id="goToPaymentBtn">
            <i class="fas fa-credit-card me-2"></i>
            Complete Payment
        </button>
        <button class="btn btn-outline-secondary mt-2" id="checkPaymentStatusBtn">
            <i class="fas fa-sync me-2"></i>
            Check Payment Status
        </button>
        <button class="btn btn-link mt-2" id="backToDashboardBtn">
            <i class="fas fa-arrow-left me-2"></i>
            Back to Dashboard
        </button>
    </div>
</div>

<!-- Admin Contact Dropdown -->
<div class="admin-dropdown" id="adminDropdown" style="display: none; position: absolute; top: 60px; right: 20px; background: white; border: 1px solid #e5e5e5; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; min-width: 250px;">
    <div style="padding: 12px; border-bottom: 1px solid #e5e5e5;">
        <h6 style="margin: 0; font-weight: 600; color: #111b21;">Contact Support</h6>
    </div>
    <div id="adminListContainer" style="max-height: 300px; overflow-y: auto;">
        <div style="padding: 12px; text-align: center; color: #999;">
            <i class="fas fa-spinner fa-spin"></i> Loading admins...
        </div>
    </div>
</div>

<!-- Hidden elements for data -->
<input type="hidden" id="currentUserId" value="{{ current_user.id }}">
<input type="hidden" id="currentUserRole" value="{{ current_user.role }}">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

<!-- Server-provided ICE servers as JSON to avoid injecting Jinja braces directly into JS -->
<script type="application/json" id="iceServersData">{{ iceServers | tojson | safe }}</script>

<!-- Audio element for voice messages -->
<audio id="voicePlayer" style="display: none;"></audio>

<!-- Prescription Modal -->
<div class="modal fade" id="prescriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Prescription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="prescriptionForm">
                    <!-- Prescription form will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
            <!-- Patient info modal -->
            <div class="modal fade" id="patientInfoModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Patient Info</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="patientInfoBody">
                            <!-- Filled dynamically -->
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <a href="#" id="patientRecordsLink" class="btn btn-primary">View Medical Records</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outgoing Video Call Modal -->
            <div class="modal fade" id="outgoingVideoCallModal" tabindex="-1" aria-labelledby="outgoingVideoCallLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="modal-body text-center text-white py-5">
                            <div style="margin-bottom: 30px;">
                                <div class="avatar-large" id="outgoingVideoDoctorAvatar" style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">
                                    P
                                </div>
                                <h5 id="outgoingVideoDoctorName" style="margin-bottom: 10px;">Patient Name</h5>
                                <p style="margin: 0; opacity: 0.9;">Video call in progress...</p>
                            </div>
                            <div style="margin: 40px 0;">
                                <div class="spinner-border text-light" role="status" style="width: 60px; height: 60px;">
                                    <span class="visually-hidden">Calling...</span>
                                </div>
                            </div>
                            <div style="margin-top: 40px; display: flex; gap: 10px; justify-content: center;">
                                <button type="button" class="btn btn-danger btn-lg" id="rejectOutgoingVideoCallBtn" style="border-radius: 50%; width: 60px; height: 60px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-phone-slash" style="font-size: 24px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outgoing Voice Call Modal -->
            <div class="modal fade" id="outgoingVoiceCallModal" tabindex="-1" aria-labelledby="outgoingVoiceCallLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="modal-body text-center text-white py-5">
                            <div style="margin-bottom: 30px;">
                                <div class="avatar-large" id="outgoingVoiceDoctorAvatar" style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">
                                    P
                                </div>
                                <h5 id="outgoingVoiceDoctorName" style="margin-bottom: 10px;">Patient Name</h5>
                                <p style="margin: 0; opacity: 0.9;">Calling...</p>
                            </div>
                            <div style="margin: 40px 0;">
                                <div class="spinner-border text-light" role="status" style="width: 60px; height: 60px;">
                                    <span class="visually-hidden">Calling...</span>
                                </div>
                            </div>
                            <div style="margin-top: 40px; display: flex; gap: 10px; justify-content: center;">
                                <button type="button" class="btn btn-danger btn-lg" id="rejectOutgoingVoiceCallBtn" style="border-radius: 50%; width: 60px; height: 60px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-phone-slash" style="font-size: 24px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% endblock %}

{% block extra_js %}
<script type="module">
  // Gracefully load emoji-picker; fail silently if CDN unavailable
  try {
    await import('https://cdn.jsdelivr.net/npm/emoji-picker-element@latest/dist/index.js');
  } catch (e) {
    console.warn('Emoji picker CDN unavailable; emoji functionality disabled', e);
    // Emoji picker is optional; continue without it
  }
</script>

<!-- Real-time Communication Libraries -->
<script src="{{ url_for('static', filename='js/webrtc-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/signaling-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/call-manager.js') }}"></script>

<script>
const csrfToken = document.querySelector('input[name="csrf_token"]').value;
const currentUserId = parseInt(document.getElementById('currentUserId').value);
const currentUserRole = document.getElementById('currentUserRole').value;
const DEFAULT_TIMEZONE = 'Africa/Nairobi'; // EAT (East Africa Time)

// Global state
let selectedAppointmentId = null;
let selectedPatientId = null;
let selectedPatientData = null;
let isRecording = false;
let recordingStartTime = null;
let recordingTimer = null;
let mediaRecorder = null;
let recordedChunks = [];
let isTyping = false;
let typingTimeout = null;
let emojiPicker = null;

// SafeStorage utility for Tracking Prevention compatibility
const safeStorage = {
    getItem: function(key) {
        try {
            return sessionStorage.getItem(key);
        } catch (e) {
            return window[`__storage_${key}`] || null;
        }
    },
    setItem: function(key, value) {
        try {
            sessionStorage.setItem(key, value);
        } catch (e) {
            window[`__storage_${key}`] = value;
        }
    },
    removeItem: function(key) {
        try {
            sessionStorage.removeItem(key);
        } catch (e) {
            delete window[`__storage_${key}`];
        }
    }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadUserProfilePicture();
    loadPatients();
    setupEventListeners();
    setupAdminContact();
    setupSocketIO();
    setupEmojiPicker();
    initializeCallManager();
});

// Initialize CallManager for real-time communication
function initializeCallManager() {
    // Wait for socket to be ready
    if (!window.socket || !window.socket.connected) {
        setTimeout(initializeCallManager, 500);
        return;
    }
    
    // Initialize CallManager with WebRTC and signaling clients
    if (typeof CallManager !== 'undefined') {
        // Read ICE servers JSON injected in DOM to avoid JS parser errors in editors
        const iceServersEl = document.getElementById('iceServersData');
        const iceServersConfig = (iceServersEl && iceServersEl.textContent) ? JSON.parse(iceServersEl.textContent) : [];
        // Ensure we have a signaling client (reuse global if present)
        let _signaling = window.signalingClient || null;
        if (!_signaling) {
            if (typeof SignalingClient === 'function') {
                try {
                    _signaling = new SignalingClient(window.socket);
                    window.signalingClient = _signaling;
                } catch (e) {
                    console.error('Failed to construct SignalingClient, retrying...', e);
                    setTimeout(initializeCallManager, 500);
                    return;
                }
            } else {
                console.warn('SignalingClient not available yet; retrying...');
                setTimeout(initializeCallManager, 500);
                return;
            }
        }

        // Only create CallManager if signaling client exposes the expected interface
        if (!(typeof _signaling.addEventListener === 'function' || typeof _signaling.on === 'function')) {
            console.warn('Signaling client missing required interface; retrying...');
            setTimeout(initializeCallManager, 500);
            return;
        }

        window.callManager = new CallManager(
            _signaling,
            {
                iceServers: iceServersConfig,
                audioConstraints: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                },
                videoConstraints: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    frameRate: { ideal: 30 }
                }
            }
        );
        
        // Attach event handlers for CallManager
        window.callManager.onStateChange = function(state) {
            console.log('Call state changed:', state);
            updateCallUI(state);
        };
        
        window.callManager.onQualityUpdate = function(metrics) {
            console.log('Quality metrics:', metrics);
            updateQualityIndicator(metrics);
            // Send metrics to server
            if (window.socket) {
                const meta = (typeof window.callManager.getCallMetadata === 'function') ? window.callManager.getCallMetadata() : { callId: window.callManager.callId, appointmentId: window.callManager.appointmentId };
                const metricsData = Object.assign({ call_id: meta.callId, appointment_id: meta.appointmentId }, metrics);
                window.socket.emit('quality:metrics', metricsData);
            }
        };
        
        window.callManager.onError = function(error) {
            console.error('Call error:', error);
            showNotification('Call Error: ' + error, 'error');
        };
        
        console.log('CallManager initialized successfully');
    }
}

// Update call UI based on call manager state
function updateCallUI(state) {
    // This will be called as call state changes
    // state: idle, initiated, ringing, connecting, connected, ended, failed
    console.log('Call UI updated for state:', state);
    
    // Update UI elements based on state
    const statusEl = document.getElementById('callStatus');
    if (statusEl) {
        statusEl.textContent = state.toUpperCase();
    }
}

// Update quality indicator
function updateQualityIndicator(metrics) {
    const qualityEl = document.getElementById('qualityIndicator');
    if (qualityEl && metrics.audio_quality) {
        let qualityColor = 'green';
        if (metrics.audio_quality === 'poor') qualityColor = 'red';
        else if (metrics.audio_quality === 'fair') qualityColor = 'orange';
        else if (metrics.audio_quality === 'good') qualityColor = 'yellow';
        
        qualityEl.style.backgroundColor = qualityColor;
        qualityEl.title = `Quality: ${metrics.audio_quality}, RTT: ${metrics.rtt}ms`;
    }
}

// ============================================
// ADMIN CONTACT SETUP & FUNCTIONS
// ============================================

function setupAdminContact() {
    const contactAdminBtn = document.getElementById('contactAdminBtn');
    if (contactAdminBtn) {
        contactAdminBtn.addEventListener('click', toggleAdminDropdown);
    }
    
    // Close dropdown if clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('adminDropdown');
        const contactBtn = document.getElementById('contactAdminBtn');
        if (dropdown && !dropdown.contains(event.target) && !contactBtn.contains(event.target)) {
            dropdown.style.display = 'none';
        }
    });
}

function toggleAdminDropdown() {
    const dropdown = document.getElementById('adminDropdown');
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        dropdown.style.display = 'block';
        loadAdminsList();
    } else {
        dropdown.style.display = 'none';
    }
}

function loadAdminsList() {
    const adminList = document.getElementById('adminListContainer');
    if (!adminList) {
        console.error('Admin list container not found');
        return;
    }
    
    adminList.innerHTML = '<div class="loading">Loading admins...</div>';
    
    fetch('/api/admins-list', { credentials: 'same-origin' })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error('Network error: ' + response.status + ' - ' + text); });
            }
            const ct = response.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
                return response.json();
            }
            return response.text().then(text => { throw new Error('Unexpected response (not JSON): ' + text); });
        })
        .then(data => {
            if (data.admins && data.admins.length > 0) {
                adminList.innerHTML = '';
                data.admins.forEach(admin => {
                    const adminItem = document.createElement('div');
                    adminItem.className = 'admin-item';
                    adminItem.innerHTML = `
                        <img src="${admin.profile_picture_url || '/static/images/default_avatar.png'}" 
                             alt="${admin.first_name}" class="admin-avatar">
                        <div class="admin-info">
                            <div class="admin-name">${admin.first_name} ${admin.last_name}</div>
                            <div class="admin-role">Administrator</div>
                        </div>
                    `;
                    adminItem.addEventListener('click', () => {
                        contactAdmin(admin.id, admin);
                    });
                    adminList.appendChild(adminItem);
                });
            } else {
                adminList.innerHTML = '<div class="no-admins">No admins available</div>';
            }
        })
        .catch(error => {
            console.error('Error loading admins:', error);
            if (adminList) {
                adminList.innerHTML = '<div class="error">Error loading admins</div>';
            }
        });
}

function contactAdmin(adminId, adminData) {
    selectedPatientId = adminId;
    selectedPatientData = adminData;
    document.getElementById('adminDropdown').style.display = 'none';
    
    // Load admin conversation
    loadAdminConversation(adminId);
    
    // Update header with admin info
    const recipientHeader = document.getElementById('messageRecipientHeader');
    if (recipientHeader) {
        recipientHeader.innerHTML = `
            <img src="${adminData.profile_picture_url || '/static/images/default_avatar.png'}" 
                 alt="${adminData.first_name}" class="recipient-avatar">
            <div class="recipient-info">
                <div class="recipient-name">${adminData.first_name} ${adminData.last_name}</div>
                <div class="recipient-role">Administrator</div>
            </div>
        `;
    }
    
    // Show communication area
    const communicationArea = document.getElementById('communicationArea');
    if (communicationArea) {
        communicationArea.style.display = 'block';
    }
    
    // Unlock all features (admin chats are always available)
    unlockFeatures();
}

function loadAdminConversation(adminId) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    chatMessages.innerHTML = '<div class="loading-messages">Loading conversation...</div>';
    
    fetch(`/api/admin-conversation/${adminId}`)
        .then(response => response.json())
        .then(data => {
            chatMessages.innerHTML = '';
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    displayMessage(msg);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                chatMessages.innerHTML = '<div class="no-messages">Start the conversation by sending a message</div>';
            }
        })
        .catch(error => {
            console.error('Error loading conversation:', error);
            chatMessages.innerHTML = '<div class="error-messages">Error loading conversation</div>';
        });
    
    // Join admin chat room via Socket.IO
    if (socket && socket.connected) {
        socket.emit('join_admin_chat', {
            admin_id: adminId,
            user_id: currentUserId,
            user_role: currentUserRole
        });
    }
}

function backToDashboard() {
    window.location.href = '/doctor/dashboard';
}

// ============================================
// END ADMIN CONTACT SETUP & FUNCTIONS
// ============================================

// Load doctor's profile picture
function loadUserProfilePicture() {
    fetch(`/api/user/${currentUserId}/profile`)
        .then(response => response.json())
        .then(data => {
            const profileAvatar = document.getElementById('userProfileAvatar');
            if (data.profile_picture_url) {
                profileAvatar.innerHTML = `<img src="${data.profile_picture_url}" alt="Profile">`;
                profileAvatar.classList.remove('initials');
            } else {
                const initials = getInitials(data.name || 'DR');
                profileAvatar.textContent = initials;
                profileAvatar.classList.add('initials');
            }
        })
        .catch(error => {
            console.error('Error loading profile picture:', error);
            const profileAvatar = document.getElementById('userProfileAvatar');
            profileAvatar.textContent = 'DR';
            profileAvatar.classList.add('initials');
        });
}

// Get initials from name
function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// -------------------------
// In-page Voice Call UI
// -------------------------

let _ringAudioCtx_doc = null;
let _ringOsc_doc = null;
function playRingtone_doc(loop=true, frequency=440) {
    try {
        if (!_ringAudioCtx_doc) _ringAudioCtx_doc = new (window.AudioContext || window.webkitAudioContext)();
        _ringOsc_doc = _ringAudioCtx_doc.createOscillator();
        const gain = _ringAudioCtx_doc.createGain();
        _ringOsc_doc.type = 'sine';
        _ringOsc_doc.frequency.setValueAtTime(frequency, _ringAudioCtx_doc.currentTime);
        _ringOsc_doc.connect(gain);
        gain.connect(_ringAudioCtx_doc.destination);
        gain.gain.setValueAtTime(0.0001, _ringAudioCtx_doc.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.2, _ringAudioCtx_doc.currentTime + 0.02);
        _ringOsc_doc.start();
        if (loop) {
            let on = true;
            _ringOsc_doc._pulse = setInterval(() => {
                gain.gain.cancelScheduledValues(_ringAudioCtx_doc.currentTime);
                if (on) {
                    gain.gain.setValueAtTime(0.2, _ringAudioCtx_doc.currentTime);
                } else {
                    gain.gain.setValueAtTime(0.0001, _ringAudioCtx_doc.currentTime);
                }
                on = !on;
            }, 600);
        }
    } catch (e) {
        console.warn('Ringtone failed:', e);
    }
}

function stopRingtone_doc() {
    try {
        if (_ringOsc_doc) {
            if (_ringOsc_doc._pulse) clearInterval(_ringOsc_doc._pulse);
            _ringOsc_doc.stop();
            _ringOsc_doc.disconnect();
            _ringOsc_doc = null;
        }
    } catch(e){}
}

function showOutgoingVoiceOverlay_doc(callInfo) {
    closeVoiceOverlays_doc();
    const overlay = document.createElement('div');
    overlay.id = 'outgoingVoiceOverlay_doc';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2000;';
    overlay.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:28px;min-width:320px;max-width:420px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;"></div>
            <div id="voiceCalleeInfo_doc" style="font-weight:700;margin-bottom:6px;">Calling...</div>
            <div style="color:#666;margin-bottom:14px;">Voice call</div>
            <div id="voiceOutgoingStatus_doc" style="margin-bottom:16px;color:#999;">Ringing...</div>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="endOutgoingVoiceBtn_doc" class="btn btn-danger">End call</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    document.getElementById('endOutgoingVoiceBtn_doc').addEventListener('click', () => {
        stopRingtone_doc();
        if (socket && socket.connected) socket.emit('end_voice_call', { appointment_id: callInfo.appointment_id });
        closeVoiceOverlays_doc();
    });

    playRingtone_doc(true, 480);
    
    overlay._ringTimeout = setTimeout(() => {
        stopRingtone_doc();
        closeVoiceOverlays_doc();
        showNoAnswerVoiceOverlay_doc(callInfo);
    }, 60000);
}

function showIncomingVoiceOverlay_doc(callInfo) {
    closeVoiceOverlays_doc();
    const overlay = document.createElement('div');
    overlay.id = 'incomingVoiceOverlay_doc';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2000;';
    overlay.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:26px;min-width:320px;max-width:420px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;"></div>
            <div id="voiceCallerName_doc" style="font-weight:700;margin-bottom:6px;">${escapeHtml(callInfo.caller_name || 'Caller')}</div>
            <div style="color:#666;margin-bottom:14px;">Incoming voice call</div>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="acceptIncomingVoiceBtn_doc" class="btn btn-success">Accept</button>
                <button id="hangupIncomingVoiceBtn_doc" class="btn btn-danger">Hang up</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    playRingtone_doc(true, 380);

    document.getElementById('acceptIncomingVoiceBtn_doc').addEventListener('click', () => {
        stopRingtone_doc();
        if (socket && socket.connected) socket.emit('accept_voice_call', { appointment_id: callInfo.appointment_id });
        closeVoiceOverlays_doc();
    });

    document.getElementById('hangupIncomingVoiceBtn_doc').addEventListener('click', () => {
        stopRingtone_doc();
        if (socket && socket.connected) socket.emit('end_voice_call', { appointment_id: callInfo.appointment_id });
        closeVoiceOverlays_doc();
    });

    overlay._ringTimeout = setTimeout(() => {
        stopRingtone_doc();
        if (socket && socket.connected) socket.emit('end_voice_call', { appointment_id: callInfo.appointment_id });
        closeVoiceOverlays_doc();
    }, 60000);
}

function showNoAnswerVoiceOverlay_doc(callInfo) {
    closeVoiceOverlays_doc();
    const modal = document.createElement('div');
    modal.id = 'noAnswerVoiceOverlay_doc';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2100;';
    modal.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:24px;min-width:320px;text-align:center;">
            <h5 style="color:#c00;margin-bottom:8px;">No answer</h5>
            <p style="color:#666;margin-bottom:16px;">The call was not answered. Would you like to try again?</p>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="redialVoiceBtn_doc" class="btn btn-primary">Try again</button>
                <button id="cancelNoAnswerVoiceBtn_doc" class="btn btn-outline-secondary">Cancel</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('redialVoiceBtn_doc').addEventListener('click', () => {
        modal.remove();
        if (socket && socket.connected) socket.emit('initiate_voice_call', { appointment_id: callInfo.appointment_id });
    });
    document.getElementById('cancelNoAnswerVoiceBtn_doc').addEventListener('click', () => modal.remove());
}

function closeVoiceOverlays_doc() {
    ['outgoingVoiceOverlay_doc','incomingVoiceOverlay_doc','noAnswerVoiceOverlay_doc'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (el._ringTimeout) clearTimeout(el._ringTimeout);
            el.remove();
        }
    });
    stopRingtone_doc();
}

// Load patients with appointments - add error handling
function loadPatients() {
    fetch('/api/doctor/appointments')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const list = document.getElementById('patientsList');
            list.innerHTML = '';
            
            // Handle the API response structure: {appointments_by_patient: [...], total_patients: N}
            const appointmentsByPatient = data.appointments_by_patient || data || [];
            
            if (!appointmentsByPatient || appointmentsByPatient.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-user-injured"></i></div>
                        <div class="empty-state-text">No patients yet</div>
                        <div class="empty-state-subtext">Your patient consultations will appear here</div>
                    </div>
                `;
                return;
            }

            // Flatten appointments - create individual items for each appointment
            const allAppointments = [];
            appointmentsByPatient.forEach(patientGroup => {
                // Collect all appointments from all categories
                const categories = patientGroup.today || [];
                const upcoming = patientGroup.upcoming || [];
                const completed = patientGroup.completed || [];
                const rescheduled = patientGroup.rescheduled || [];
                const pending = patientGroup.pending || [];
                
                const appointments = [...categories, ...upcoming, ...completed, ...rescheduled, ...pending];
                
                appointments.forEach(appointment => {
                    allAppointments.push({
                        appointment: appointment,
                        patient: patientGroup.patient
                    });
                });
            });
            
            // Sort appointments by date (descending - closest upcoming first)
            allAppointments.sort((a, b) => {
                const dateA = new Date(a.appointment?.appointment_date || 0);
                const dateB = new Date(b.appointment?.appointment_date || 0);
                return dateB - dateA; // Descending order (newest first)
            });
            
            // Create appointment items - each appointment separately
            allAppointments.forEach(item => {
                const appointmentItem = createAppointmentItem(item.patient, item.appointment);
                if (appointmentItem) {
                    list.appendChild(appointmentItem);
                }
            });
            
            // Add scroll if more than 3 appointments
            if (allAppointments.length > 3) {
                list.style.maxHeight = '300px';
                list.style.overflowY = 'auto';
            } else {
                list.style.maxHeight = 'auto';
            }
        })
        .catch(error => {
            console.error('Error loading appointments:', error);
            const list = document.getElementById('patientsList');
            list.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="empty-state-text">Error loading appointments</div>
                    <div class="empty-state-subtext">Unable to load appointments. Please try again.</div>
                </div>
            `;
            
            // Log detailed error for debugging
            console.log('Detailed error:', error.message);
        });
}

// Create appointment item (each appointment separately)
function createAppointmentItem(patient, appointment) {
    try {
        const div = document.createElement('div');
        div.className = 'appointment-item';
        
        const appointmentId = appointment?.appointment_id || appointment?.id;
        const patientId = patient?.id;
        
        if (!appointmentId || !patientId) {
            console.warn('Missing appointment or patient data:', { appointment, patient });
            return null;
        }
        
        div.dataset.appointmentId = appointmentId;
        div.dataset.patientId = patientId;
        div.dataset.paymentStatus = appointment?.payment_status || 'pending';
        
        const name = `${patient.first_name} ${patient.last_name}`;
        const avatarText = getInitials(name);
        const profilePictureUrl = patient.profile_picture_url;
        
        // Format appointment date for display
        const appointmentDate = appointment?.appointment_date ? new Date(appointment.appointment_date) : null;
        let appointmentDateDisplay = '';
        if (appointmentDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (appointmentDate.toDateString() === today.toDateString()) {
                appointmentDateDisplay = 'Today ' + (appointment.appointment_time || '');
            } else if (appointmentDate.toDateString() === tomorrow.toDateString()) {
                appointmentDateDisplay = 'Tomorrow ' + (appointment.appointment_time || '');
            } else {
                appointmentDateDisplay = appointmentDate.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + (appointment.appointment_time || '');
            }
        }
        
        // Payment badge
        const paymentBadge = appointment?.payment_status === 'paid' ? 
            '<span class="badge bg-success ms-2">Paid</span>' : 
            '<span class="badge bg-warning ms-2">Pending</span>';
        
        div.innerHTML = `
            <div class="appointment-avatar ${profilePictureUrl ? '' : 'initials'}" 
                 data-profile-picture="${profilePictureUrl || ''}">
                ${profilePictureUrl ? `<img src="${profilePictureUrl}" alt="${name}">` : avatarText}
                <div class="online-indicator"></div>
            </div>
            <div class="appointment-content">
                <div class="appointment-header">
                    <span class="appointment-name">${name}</span>
                    <span class="appointment-time">${appointment?.last_message_time || ''}</span>
                </div>
                <div class="appointment-preview">${appointment?.last_message || 'No messages yet'}</div>
                <div class="appointment-details">
                    <small class="text-muted">
                        ${appointmentDateDisplay} ${paymentBadge}
                    </small>
                </div>
            </div>
            ${appointment?.unread_count > 0 ? `<div class="unread-badge">${appointment.unread_count}</div>` : ''}
        `;
        
        // Load profile picture if available
        if (profilePictureUrl) {
            setTimeout(() => {
                const avatar = div.querySelector('.appointment-avatar');
                if (avatar && avatar.dataset.profilePicture) {
                    const img = document.createElement('img');
                    img.src = avatar.dataset.profilePicture;
                    img.alt = name;
                    img.onload = () => {
                        if (avatar) {
                            avatar.innerHTML = '';
                            avatar.appendChild(img);
                            const indicator = document.createElement('div');
                            indicator.className = 'online-indicator';
                            avatar.appendChild(indicator);
                        }
                    };
                    img.onerror = () => {
                        if (avatar) {
                            avatar.textContent = avatarText;
                            avatar.classList.add('initials');
                            const indicator = document.createElement('div');
                            indicator.className = 'online-indicator';
                            avatar.appendChild(indicator);
                        }
                    };
                }
            }, 100);
        }
        
        div.addEventListener('click', () => selectAppointment(appointmentId, patient, appointment));
        return div;
    } catch (error) {
        console.error('Error creating appointment item:', error);
        return null;
    }
}

// Select appointment
function selectAppointment(appointmentId, patientData, appointmentData) {
    selectedAppointmentId = appointmentId;
    selectedPatientId = patientData?.id;
    selectedPatientData = patientData;
    
    // Update selected state
    document.querySelectorAll('.appointment-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.appointmentId === appointmentId.toString()) {
            item.classList.add('active');
            paymentStatus = item.dataset.paymentStatus;
        }
    });
    
    // Update UI for mobile
    if (window.innerWidth <= 768) {
        const patientsSidebar = document.getElementById('patientsSidebar');
        const chatArea = document.getElementById('chatArea');
        const backToList = document.getElementById('backToList');
        
        if (patientsSidebar) patientsSidebar.style.display = 'none';
        if (chatArea) chatArea.style.display = 'flex';
        if (backToList) backToList.style.display = 'flex';
    }
    
    // Load appointment details
    loadAppointmentDetails(appointmentId);
    
    // Check payment status
    checkPaymentStatus(appointmentId);
}

function loadAppointmentDetails(appointmentId) {
    fetch(`/api/appointment/${appointmentId}/details`)
        .then(response => response.json())
        .then(data => {
            // Update chat header
            const chatHeaderName = document.getElementById('chatHeaderName');
            const chatHeaderStatus = document.getElementById('chatHeaderStatus');
            const chatAvatar = document.getElementById('chatAvatar');
            
            const name = `${data.patient_first_name} ${data.patient_last_name}`;
            const avatarText = getInitials(name);
            
            chatHeaderName.textContent = name;
            chatHeaderStatus.innerHTML = `
                <span class="status-indicator online"></span>
                Patient  ${data.consultation_type || 'Consultation'}
            `;
            
            // Load profile picture
            if (data.patient_profile_picture) {
                chatAvatar.innerHTML = `<img src="${data.patient_profile_picture}" alt="${name}">`;
                chatAvatar.classList.remove('initials');
            } else {
                chatAvatar.textContent = avatarText;
                chatAvatar.classList.add('initials');
            }
            
            // Load messages
            loadMessages(appointmentId);
            
            // Enable input
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendMessageBtn').disabled = false;
            
            // Join socket room
            socket.emit('join_appointment', { appointment_id: appointmentId });
        })
        .catch(error => {
            console.error('Error loading appointment details:', error);
        });
}

// Load messages with WhatsApp-style formatting
function loadMessages(appointmentId) {
    const messagesArea = document.getElementById('chatMessages');
    messagesArea.innerHTML = '<div class="loading-messages"><div class="loading-spinner"></div></div>';
    
    fetch(`/api/appointment/${appointmentId}/messages`)
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error('HTTP ' + response.status + ': ' + text); });
            }
            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                return response.text().then(text => { throw new Error('Unexpected response (not JSON): ' + text); });
            }
            return response.json();
        })
        .then(data => {
            messagesArea.innerHTML = '';
            
            if (!data.messages || data.messages.length === 0) {
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-comment-dots"></i></div>
                        <div class="empty-state-text">No messages yet</div>
                        <div class="empty-state-subtext">Send a message to start the conversation</div>
                    </div>
                `;
                return;
            }
            
            let currentDate = null;
            
            data.messages.forEach(message => {
                const messageDate = new Date(message.timestamp);
                const messageDay = messageDate.toDateString();
                
                // Add date separator if new day
                if (currentDate !== messageDay) {
                    currentDate = messageDay;
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'date-separator';
                    dateSeparator.innerHTML = `<span class="date-label">${formatDate(messageDate)}</span>`;
                    messagesArea.appendChild(dateSeparator);
                }
                
                // Create message element
                const messageElement = createMessageElement(message);
                messagesArea.appendChild(messageElement);
            });
            
            // Scroll to bottom
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Mark messages as read
            markMessagesAsRead(appointmentId);
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            messagesArea.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="empty-state-text">Error loading messages</div>
                    <div class="empty-state-subtext">${escapeHtml(error.message || 'Unable to load messages')}</div>
                </div>
            `;
        });
}

// Create message element with WhatsApp styling
function createMessageElement(message) {
    const isSent = message.sender_id === currentUserId;
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    
    const container = document.createElement('div');
    container.className = 'message-container';
    
    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
    
    // Message content based on type
    if (message.message_type === 'text') {
        bubble.innerHTML = `<div class="message-text">${escapeHtml(message.content || '')}</div>`;
    } else if (message.message_type === 'voice_note') {
        bubble.innerHTML = createVoiceMessageHTML(message);
    } else if (message.message_type === 'document' || message.message_type === 'image') {
        bubble.innerHTML = createFileMessageHTML(message);
    } else if (message.message_type === 'prescription') {
        bubble.innerHTML = createPrescriptionMessageHTML(message);
    } else {
        bubble.innerHTML = `<div class="message-text">${escapeHtml(message.content || '')}</div>`;
    }
    
    // Message time and status
    const timeElement = document.createElement('div');
    timeElement.className = 'message-time';
    timeElement.setAttribute('data-timestamp', message.timestamp);
    timeElement.setAttribute('data-timestamp-format', 'timeonly');
    
    // Use LocalTime utility for formatting
    const timeString = window.LocalTime ? window.LocalTime.formatToLocalTime(message.timestamp, 'timeonly') : new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    let statusHTML = '';
    if (isSent) {
        statusHTML = getMessageStatusHTML(message.message_status || 'sent');
    }
    
    timeElement.innerHTML = `${timeString} ${statusHTML}`;
    
    container.appendChild(bubble);
    container.appendChild(timeElement);
    wrapper.appendChild(container);
    
    return wrapper;
}

// Create voice message HTML
function createVoiceMessageHTML(message) {
    const duration = message.duration || '0:00';
    return `
        <div class="voice-message">
            <i class="fas fa-play-circle play-voice" data-url="${message.file_url || ''}"></i>
            <div class="voice-waveform"></div>
            <span class="voice-duration">${duration}</span>
        </div>
    `;
}

// Create file message HTML
function createFileMessageHTML(message) {
    const fileName = message.file_name || 'File';
    const fileSize = message.file_size ? formatFileSize(message.file_size) : '';
    const isImage = message.message_type === 'image';
    
    if (isImage) {
        return `
            <div class="message-file">
                <img src="${message.file_url || ''}" alt="${fileName}" style="max-width: 200px; border-radius: 5px;" onerror="this.style.display='none'">
                <div>
                    <div><strong>${escapeHtml(fileName)}</strong></div>
                    ${fileSize ? `<div><small>${fileSize}</small></div>` : ''}
                </div>
            </div>
        `;
    } else {
        return `
            <div class="message-file">
                <i class="fas fa-file"></i>
                <div>
                    <div><a href="${message.file_url || '#'}" target="_blank">${escapeHtml(fileName)}</a></div>
                    ${fileSize ? `<div><small>${fileSize}</small></div>` : ''}
                </div>
            </div>
        `;
    }
}

// Create prescription message HTML
function createPrescriptionMessageHTML(message) {
    return `
        <div class="message-prescription">
            <div class="prescription-header">
                <i class="fas fa-prescription-bottle-alt"></i>
                <strong>New Prescription</strong>
            </div>
            <div class="prescription-content">
                ${message.content || 'Prescription details'}
            </div>
            <div class="prescription-actions">
                <button class="btn btn-sm btn-outline-primary view-prescription-btn" data-id="${message.prescription_id || ''}">
                    <i class="fas fa-eye me-1"></i>View Details
                </button>
                <button class="btn btn-sm btn-outline-success print-prescription-btn" data-id="${message.prescription_id || ''}">
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
        </div>
    `;
}

// Get message status HTML (WhatsApp-style ticks)
function getMessageStatusHTML(status) {
    switch(status) {
        case 'sent':
            return '<span class="tick single"></span>';
        case 'delivered':
            return '<span class="tick double grey"></span>';
        case 'read':
            return '<span class="tick double blue"></span>';
        default:
            return '<span class="tick single"></span>';
    }
}

// Format file size
function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Format date for separator
function formatDate(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) {
        return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
    } else {
        return date.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
    }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Mark messages as read
function markMessagesAsRead(appointmentId) {
    socket.emit('message_read', {
        appointment_id: appointmentId
    });
    
    // Update unread count in sidebar
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.patientId === selectedPatientId?.toString()) {
            const badge = item.querySelector('.unread-badge');
            if (badge) {
                badge.remove();
            }
        }
    });
}

// Show no appointment message
function showNoAppointmentMessage() {
    const messagesArea = document.getElementById('chatMessages');
    messagesArea.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-calendar-plus"></i></div>
            <div class="empty-state-text">No active consultation</div>
            <div class="empty-state-subtext">Start a new consultation with this patient</div>
            <button class="btn btn-primary mt-3" id="startConsultationBtn">
                <i class="fas fa-plus me-2"></i>Start Consultation
            </button>
        </div>
    `;
    
    document.getElementById('startConsultationBtn').addEventListener('click', startNewConsultation);
}

// Start new consultation
function startNewConsultation() {
    if (!selectedPatientId) return;
    
    fetch('/api/doctor/start-consultation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            patient_id: selectedPatientId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            selectedAppointmentId = data.appointment_id;
            loadAppointmentDetails(selectedAppointmentId);
            loadPatients(); // Refresh patient list
        }
    })
    .catch(error => {
        console.error('Error starting consultation:', error);
        alert('Error starting consultation');
    });
}

// Setup event listeners
function setupEventListeners() {
    // Send message
    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Typing indicator
    document.getElementById('messageInput').addEventListener('input', function(e) {
        if (!selectedAppointmentId) return;
        
        // Send typing indicator
        if (!isTyping) {
            isTyping = true;
            socket.emit('typing', {
                appointment_id: selectedAppointmentId
            });
        }
        
        // Clear existing timeout
        clearTimeout(typingTimeout);
        
        // Set timeout to stop typing indicator
        typingTimeout = setTimeout(() => {
            isTyping = false;
            socket.emit('stop_typing', {
                appointment_id: selectedAppointmentId
            });
        }, 1000);
    });
    
    // Voice recording
    document.getElementById('voiceRecordBtn').addEventListener('click', toggleRecording);
    document.getElementById('cancelRecordingBtn').addEventListener('click', cancelRecording);
    document.getElementById('sendRecordingBtn').addEventListener('click', sendRecording);
    
    // File attachment
    document.getElementById('attachBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
    
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    
    // Doctor-specific buttons
    document.getElementById('prescriptionBtn').addEventListener('click', openPrescriptionModal);
    document.getElementById('medicalRecordBtn').addEventListener('click', openMedicalRecordModal);
    document.getElementById('voiceCallBtn').addEventListener('click', initiateVoiceCall);
    document.getElementById('videoCallBtn').addEventListener('click', initiateVideoCall);
    document.getElementById('infoBtn').addEventListener('click', showPatientInfo);
    
    // Outgoing call rejection handlers
    document.getElementById('rejectOutgoingVideoCallBtn').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('outgoingVideoCallModal'));
        if (modal) modal.hide();
        if (typeof socket !== 'undefined') {
            socket.emit('end_video_call', {
                appointment_id: selectedAppointmentId
            });
        }
    });
    
    document.getElementById('rejectOutgoingVoiceCallBtn').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('outgoingVoiceCallModal'));
        if (modal) modal.hide();
        if (typeof socket !== 'undefined') {
            socket.emit('end_voice_call', {
                appointment_id: selectedAppointmentId
            });
        }
    });
    
    // Back to list (mobile)
    document.getElementById('backToList').addEventListener('click', () => {
        document.getElementById('appointmentsSidebar').style.display = 'flex';
        document.getElementById('chatArea').style.display = 'none';
        document.getElementById('backToList').style.display = 'none';
    });
    
    // Search
    document.getElementById('searchPatients').addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.appointment-item').forEach(item => {
            const name = item.querySelector('.appointment-name').textContent.toLowerCase();
            item.style.display = name.includes(query) ? 'flex' : 'none';
        });
    });
    
    // Play voice messages
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('play-voice')) {
            const audioUrl = e.target.dataset.url;
            if (audioUrl) {
                const player = document.getElementById('voicePlayer');
                player.src = audioUrl;
                player.play();
            }
        }
        
        // Prescription buttons
        if (e.target.closest('.view-prescription-btn')) {
            const prescriptionId = e.target.closest('.view-prescription-btn').dataset.id;
            viewPrescription(prescriptionId);
        }
        
        if (e.target.closest('.print-prescription-btn')) {
            const prescriptionId = e.target.closest('.print-prescription-btn').dataset.id;
            printPrescription(prescriptionId);
        }
    });
}

// Setup emoji picker
function setupEmojiPicker() {
    emojiPicker = document.createElement('emoji-picker');
    emojiPicker.style.position = 'absolute';
    emojiPicker.style.bottom = '70px';
    emojiPicker.style.right = '20px';
    emojiPicker.style.zIndex = '1000';
    emojiPicker.style.display = 'none';
    document.getElementById('chatArea').appendChild(emojiPicker);
    
    document.getElementById('emojiBtn').addEventListener('click', function() {
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });
    
    document.getElementById('emojiPickerBtn').addEventListener('click', function() {
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });
    
    emojiPicker.addEventListener('emoji-click', event => {
        const input = document.getElementById('messageInput');
        input.value += event.detail.unicode;
        input.focus();
        emojiPicker.style.display = 'none';
    });
    
    // Close picker when clicking outside
    document.addEventListener('click', function(e) {
        if (!emojiPicker.contains(e.target) && 
            e.target.id !== 'emojiBtn' && 
            e.target.id !== 'emojiPickerBtn' &&
            !e.target.closest('#emojiBtn') &&
            !e.target.closest('#emojiPickerBtn')) {
            emojiPicker.style.display = 'none';
        }
    });
}

// Send message
function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content || !selectedAppointmentId) return;
    
    // Clear typing indicator
    clearTimeout(typingTimeout);
    isTyping = false;
    socket.emit('stop_typing', { appointment_id: selectedAppointmentId });
    
    // Send via Socket.IO
    socket.emit('send_message', {
        appointment_id: selectedAppointmentId,
        content: content,
        message_type: 'text'
    });
    
    // Clear input
    input.value = '';
    
    // Add message to UI immediately (optimistic update)
    const messageData = {
        id: Date.now(), // Temporary ID
        sender_id: currentUserId,
        content: content,
        message_type: 'text',
        timestamp: new Date().toISOString(),
        message_status: 'sent'
    };
    
    addMessageToUI(messageData);
}

// Add message to UI
function addMessageToUI(messageData) {
    const messagesArea = document.getElementById('chatMessages');
    
    // Remove empty state if present
    const emptyState = messagesArea.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const messageElement = createMessageElement(messageData);
    messagesArea.appendChild(messageElement);
    
    // Scroll to bottom
    messagesArea.scrollTop = messagesArea.scrollHeight;
    
    // Update last message in sidebar
    updateSidebarPreview(messageData);
}

// Update sidebar preview
function updateSidebarPreview(messageData) {
    if (!selectedPatientId) return;
    
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.patientId === selectedPatientId.toString()) {
            const preview = item.querySelector('.appointment-preview');
            if (preview) {
                let previewText = '';
                if (messageData.message_type === 'text') {
                    previewText = messageData.content || '';
                } else if (messageData.message_type === 'voice_note') {
                    previewText = ' Voice message';
                } else if (messageData.message_type === 'image') {
                    previewText = ' Photo';
                } else if (messageData.message_type === 'document') {
                    previewText = ' ' + (messageData.file_name || 'Document');
                } else if (messageData.message_type === 'prescription') {
                    previewText = ' Prescription';
                }
                preview.textContent = previewText.length > 30 ? previewText.substring(0, 30) + '...' : previewText;
                
                // Update time
                const timeElement = item.querySelector('.appointment-time');
                if (timeElement) {
                    const now = new Date();
                    timeElement.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }
        }
    });
}

// Toggle voice recording
function toggleRecording() {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecording();
    }
}

// Start voice recording
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            // Convert to blob
            const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
            // Here you would upload the blob to server
            console.log('Recording stopped, blob size:', audioBlob.size);
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();
        
        // Update UI
        document.getElementById('voiceRecordBtn').classList.add('recording');
        document.getElementById('chatInputArea').style.display = 'none';
        document.getElementById('recordingUI').style.display = 'flex';
        
        // Start timer
        updateRecordingTimer();
        recordingTimer = setInterval(updateRecordingTimer, 1000);
        
    } catch (error) {
        console.error('Error starting recording:', error);
        alert('Unable to access microphone. Please check permissions.');
    }
}

// Stop recording
function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        clearInterval(recordingTimer);
        
        // Update UI
        document.getElementById('voiceRecordBtn').classList.remove('recording');
    }
}

// Cancel recording
function cancelRecording() {
    stopRecording();
    
    // Reset UI
    document.getElementById('chatInputArea').style.display = 'flex';
    document.getElementById('recordingUI').style.display = 'none';
    document.getElementById('recordingTimer').textContent = '00:00';
}

// Send recording
function sendRecording() {
    if (recordedChunks.length === 0 || !selectedAppointmentId) {
        cancelRecording();
        return;
    }
    
    const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
    const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
    
    // Create form data
    const formData = new FormData();
    formData.append('appointment_id', selectedAppointmentId);
    formData.append('audio', audioBlob, 'voice-note.webm');
    formData.append('duration', duration);
    
    // Send to server
    fetch('/api/send-voice-note', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add voice message to UI
            const messageData = {
                id: data.message_id,
                sender_id: currentUserId,
                content: 'Voice message',
                message_type: 'voice_note',
                timestamp: new Date().toISOString(),
                message_status: 'sent',
                duration: formatDuration(duration),
                file_url: data.file_url
            };
            
            addMessageToUI(messageData);
        }
    })
    .catch(error => {
        console.error('Error sending voice note:', error);
        alert('Error sending voice note');
    })
    .finally(() => {
        cancelRecording();
    });
}

// Update recording timer
function updateRecordingTimer() {
    if (!recordingStartTime) return;
    
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    document.getElementById('recordingTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Format duration
function formatDuration(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// Handle file upload
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file || !selectedAppointmentId) return;
    
    const formData = new FormData();
    formData.append('appointment_id', selectedAppointmentId);
    formData.append('file', file);
    
    // Determine file type
    const fileType = file.type.startsWith('image/') ? 'image' : 'document';
    
    fetch('/api/upload-file', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Send message about file
            socket.emit('send_message', {
                appointment_id: selectedAppointmentId,
                content: file.name,
                message_type: fileType,
                file_url: data.file_url,
                file_size: file.size
            });
            
            // Add to UI
            const messageData = {
                id: Date.now(),
                sender_id: currentUserId,
                content: file.name,
                message_type: fileType,
                timestamp: new Date().toISOString(),
                message_status: 'sent',
                file_url: data.file_url,
                file_size: file.size,
                file_name: file.name
            };
            
            addMessageToUI(messageData);
        }
    })
    .catch(error => {
        console.error('Error uploading file:', error);
        alert('Error uploading file');
    });
    
    // Clear file input
    event.target.value = '';
}

// Initiate voice call
function initiateVoiceCall() {
    if (!selectedAppointmentId) {
        alert('Please select a patient first');
        return;
    }
    
    if (typeof socket === 'undefined' || !socket.connected) {
        console.warn('Socket.IO not connected - cannot initiate voice call', { appointment_id: selectedAppointmentId });
        alert('Real-time connection not ready. Try again in a moment.');
        return;
    }
    console.log('Initiating voice call', { appointment_id: selectedAppointmentId, patient_id: selectedPatientId });
    socket.emit('initiate_voice_call', {
        appointment_id: selectedAppointmentId
    });
}

// Initiate video call
function initiateVideoCall() {
    if (!selectedAppointmentId) {
        alert('Please select a patient first');
        return;
    }
    if (typeof socket === 'undefined' || !socket.connected) {
        alert('Real-time connection not ready. Try again in a moment.');
        return;
    }
        const calleeId = selectedPatientData?.user_id || selectedPatientData?.id;
        // Open outgoing window for caller
        try {
            const params = new URLSearchParams();
            params.set('appointment_id', selectedAppointmentId);
            params.set('doctor_user_id', calleeId);
            params.set('callee_name', selectedPatientData?.first_name ? `${selectedPatientData.first_name} ${selectedPatientData.last_name || ''}`.trim() : '');
            params.set('caller_profile_pic', window.currentUserProfilePic || '');
            const popup = window.open(`/outgoing-call/${encodeURIComponent(selectedAppointmentId)}?${params.toString()}`, '_blank', 'width=420,height=640');
            console.info('Outgoing popup opened (doctor):', !!popup, popup);
        } catch (e) { console.warn('Could not open outgoing window', e); }

        socket.emit('initiate_video_call', {
            caller_id: currentUserId,
            callee_id: calleeId,
            appointment_id: selectedAppointmentId
        });

    
    
    // Show outgoing video call modal
    const modal = new bootstrap.Modal(document.getElementById('outgoingVideoCallModal'));
    
    // Update modal with patient name
    if (selectedPatientData) {
        document.getElementById('outgoingVideoDoctorName').textContent = `${selectedPatientData.first_name} ${selectedPatientData.last_name}`;
        document.getElementById('outgoingVideoDoctorAvatar').textContent = `${selectedPatientData.first_name[0]}${selectedPatientData.last_name[0]}`;
    }
    
    modal.show();
}

// Open prescription modal
function openPrescriptionModal() {
    if (!selectedPatientId || !selectedAppointmentId) {
        alert('Please select a patient first');
        return;
    }
    
    // Load prescription form
    fetch(`/api/prescription/form?patient_id=${selectedPatientId}&appointment_id=${selectedAppointmentId}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('prescriptionForm').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('prescriptionModal'));
            modal.show();
            
            // Setup form submission
            document.getElementById('savePrescriptionBtn').addEventListener('click', savePrescription);
        })
        .catch(error => {
            console.error('Error loading prescription form:', error);
            alert('Error loading prescription form');
        });
}

// Save prescription
function savePrescription() {
    const form = document.getElementById('prescriptionFormData');
    const formData = new FormData(form);
    
    fetch('/api/prescription/save', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('prescriptionModal')).hide();
            
            // Send prescription as message
            socket.emit('send_message', {
                appointment_id: selectedAppointmentId,
                content: 'New prescription added',
                message_type: 'prescription',
                prescription_id: data.prescription_id
            });
            
            // Add prescription message to UI
            const messageData = {
                id: Date.now(),
                sender_id: currentUserId,
                content: 'New prescription added',
                message_type: 'prescription',
                timestamp: new Date().toISOString(),
                message_status: 'sent',
                prescription_id: data.prescription_id
            };
            
            addMessageToUI(messageData);
            
            alert('Prescription saved successfully');
        }
    })
    .catch(error => {
        console.error('Error saving prescription:', error);
        alert('Error saving prescription');
    });
}

// View prescription
function viewPrescription(prescriptionId) {
    window.open(`/prescription/${prescriptionId}`, '_blank');
}

// Print prescription
function printPrescription(prescriptionId) {
    window.open(`/prescription/${prescriptionId}/print`, '_blank');
}

// Open medical record modal
function openMedicalRecordModal() {
    if (!selectedPatientId) {
        alert('Please select a patient first');
        return;
    }
    
    window.location.href = `/doctor/patient/${selectedPatientId}/medical-records`;
}

// Show patient info
function showPatientInfo() {
    if (!selectedAppointmentId) {
        alert('Please select a patient first');
        return;
    }

    fetch(`/api/appointment/${selectedAppointmentId}/details`)
        .then(res => res.json())
        .then(data => {
            const body = document.getElementById('patientInfoBody');
            const avatar = data.patient_profile_picture ? `<img src="${data.patient_profile_picture}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin-right:12px">` : `<div style="width:80px;height:80px;border-radius:50%;background:#ddd;display:inline-flex;align-items:center;justify-content:center;font-weight:bold;margin-right:12px">${(data.patient_first_name||'')[0]||'P'}</div>`;
            body.innerHTML = `
                <div style="display:flex;align-items:center">
                    ${avatar}
                    <div>
                        <h5 style="margin:0">${data.patient_first_name} ${data.patient_last_name}</h5>
                        <div class="text-muted">Patient ID: ${data.patient_id}</div>
                    </div>
                </div>
                <hr>
                <div><strong>Appointment:</strong> ${data.consultation_type || 'Consultation'}</div>
                <div><strong>Symptoms:</strong> ${data.symptoms || '-'}</div>
            `;
            document.getElementById('patientRecordsLink').href = `/doctor/patient/${data.patient_id}/medical-records`;
            const modal = new bootstrap.Modal(document.getElementById('patientInfoModal'));
            modal.show();
        })
        .catch(err => { console.error(err); alert('Could not load patient info'); });
}

// Check payment status and manage feature access
function checkPaymentStatus(appointmentId) {
    fetch(`/api/appointment/${appointmentId}/payment-status`)
        .then(response => response.json())
        .then(data => {
            const paymentOverlay = document.getElementById('paymentOverlay');
            const paymentRequired = data.payment_required;
            const paymentStatus = data.payment_status;
            
            if (paymentRequired && paymentStatus !== 'paid') {
                // Show payment overlay
                if (paymentOverlay) {
                    paymentOverlay.style.display = 'flex';
                }
                lockFeatures();
                
                // Set up payment button
                const goToPaymentBtn = document.getElementById('goToPaymentBtn');
                if (goToPaymentBtn) {
                    goToPaymentBtn.onclick = function() {
                        window.location.href = `/payment/appointment/${appointmentId}`;
                    };
                }
                
                // Set up check status button
                const checkPaymentStatusBtn = document.getElementById('checkPaymentStatusBtn');
                if (checkPaymentStatusBtn) {
                    checkPaymentStatusBtn.onclick = function() {
                        checkPaymentStatus(appointmentId);
                    };
                }
            } else {
                // Hide payment overlay and unlock features
                if (paymentOverlay) {
                    paymentOverlay.style.display = 'none';
                }
                unlockFeatures();
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
}

// Lock features (disable communication controls)
function lockFeatures() {
    document.getElementById('messageInput').disabled = true;
    document.getElementById('sendMessageBtn').disabled = true;
    document.getElementById('attachBtn').disabled = true;
    
    const voiceRecordBtn = document.getElementById('voiceRecordBtn');
    const voiceCallBtn = document.getElementById('voiceCallBtn');
    const videoCallBtn = document.getElementById('videoCallBtn');
    
    if (voiceRecordBtn) voiceRecordBtn.disabled = true;
    if (voiceCallBtn) voiceCallBtn.disabled = true;
    if (videoCallBtn) videoCallBtn.disabled = true;
}

// Unlock features (enable communication controls)
function unlockFeatures() {
    document.getElementById('messageInput').disabled = false;
    document.getElementById('sendMessageBtn').disabled = false;
    document.getElementById('attachBtn').disabled = false;
    
    const voiceRecordBtn = document.getElementById('voiceRecordBtn');
    const voiceCallBtn = document.getElementById('voiceCallBtn');
    const videoCallBtn = document.getElementById('videoCallBtn');
    
    if (voiceRecordBtn) voiceRecordBtn.disabled = false;
    if (voiceCallBtn) voiceCallBtn.disabled = false;
    if (videoCallBtn) videoCallBtn.disabled = false;
}

// Setup Socket.IO
window.socket = window.socket || null; // Initialize as null, will be set up in setupSocketIO
// Ensure a `socket` binding is available for legacy handlers
if (!window.socket) { try { window.socket = (typeof io !== 'undefined' ? io() : null); } catch(e) { console.error('Socket init failed', e); window.socket = null; } }
var socket = window.socket || null;

function setupSocketIO() {
    // Make sure socket.io library is loaded
    if (typeof io === 'undefined') {
        console.error('Socket.IO library not loaded');
        setTimeout(setupSocketIO, 1000);
        return;
    }
    
    // Prevent double initialization
    if (window.socket && window.socket.connected) {
        console.log('Socket.IO already connected');
        return;
    }
    
    // Connect with options - connect ONLY here with proper configuration
    window.socket = io({
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionAttempts: 10,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        autoConnect: true
    });
    
    socket.on('connect', function() {
        console.log('Connected to Socket.IO server');
        
        // Join any existing appointment room
        if (selectedAppointmentId) {
            socket.emit('join_appointment', { appointment_id: selectedAppointmentId });
        }
        
        // Register this socket with server and set user as online
        socket.emit('register_user', { user_id: currentUserId });
        socket.emit('user_online_status', { is_online: true });
    });
    
    // Handle incoming messages
    socket.on('message_received', function(data) {
        if (data.appointment_id === selectedAppointmentId) {
            addMessageToUI(data);
            
            // Mark as delivered
            if (data.sender_id !== currentUserId) {
                socket.emit('message_delivered', {
                    message_id: data.id,
                    appointment_id: data.appointment_id
                });
            }
        } else {
            // Update unread count for other appointments
            updateUnreadCount(data.appointment_id);
        }
    });
    
    // Handle message status updates
    socket.on('message_status_updated', function(data) {
        updateMessageStatus(data.message_id, data.status);
    });
    
    // Handle typing indicators
    socket.on('user_typing', function(data) {
        if (data.appointment_id === selectedAppointmentId && data.user_id !== currentUserId) {
            showTypingIndicator(data.user_name);
        }
    });
    
    socket.on('user_stop_typing', function(data) {
        if (data.appointment_id === selectedAppointmentId) {
            hideTypingIndicator();
        }
    });
    
    // Handle online/offline status
    socket.on('patient_online', function(data) {
        updatePatientOnlineStatus(data.patient_id, true);
    });
    
    socket.on('patient_offline', function(data) {
        updatePatientOnlineStatus(data.patient_id, false);
    });
    
    // Handle calls - these will be replaced with specific incoming_video_call and incoming_voice_call handlers below
    
    // When a call is accepted, hide doctor outgoing modals and navigate to call
    socket.on('video_call_accepted', function(data) {
        try {
            const modalEl = document.getElementById('outgoingVideoCallModal');
            const modalInst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInst.hide();
        } catch (e) {}
        if (data && data.appointment_id) {
            window.location.href = `/video-call/${data.appointment_id}`;
        }
    });

    socket.on('voice_call_accepted', function(data) {
        try {
            const modalEl = document.getElementById('outgoingVoiceCallModal');
            const modalInst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInst.hide();
        } catch (e) {}
        if (data && data.appointment_id) {
            window.location.href = `/voice-call/${data.appointment_id}`;
        }
    });
    
    // Handle payment status updates
    socket.on('payment_status_updated', function(data) {
        if (data.appointment_id === selectedAppointmentId) {
            updatePaymentBadge(data.status);
        }
    });
    
    // Handle connection errors
    socket.on('connect_error', function(error) {
        console.error('Socket.IO connection error:', error);
    });
    
    // Handle disconnection
    socket.on('disconnect', function() {
        console.log('Doctor disconnected from Socket.IO server');
        // Set doctor as offline
        socket.emit('user_online_status', { is_online: false });
    });

    // ===== CALL LIFECYCLE LISTENERS (attached to properly initialized socket) =====
    
    socket.on('outgoing_video_call_started', function(data) {
        console.log('Outgoing video call started:', data);
        const info = { 
            id: data.id, 
            caller: data.caller, 
            callee: data.callee, 
            appointment_id: data.appointment_id, 
            callee_name: data.callee_name, 
            callee_profile_picture: data.callee_profile_picture 
        };
        showOutgoingVideoOverlay_doc(info);
    });

    socket.on('call_accepted', function(data) {
        console.log('Call accepted:', data);
        closeVideoOverlays_doc();
        if (data && data.appointment_id) {
            const connectedStub = document.createElement('div');
            connectedStub.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2200;';
            connectedStub.innerHTML = `<div style="background:#fff;border-radius:12px;padding:20px;min-width:240px;text-align:center;"><h5>Connected</h5><p id=networkStrength_doc style=color:#666;>Network: Good</p></div>`;
            document.body.appendChild(connectedStub);
            setTimeout(()=>{ 
                connectedStub.remove(); 
                window.location.href = `/video-call/${data.appointment_id}`; 
            }, 900);
        }
    });

    socket.on('call_rejected', function(data) { 
        console.log('Call rejected:', data);
        closeVideoOverlays_doc(); 
        if (data && data.reason === 'no_answer') {
            showNoAnswerOverlay_doc(data); 
        }
    });

    socket.on('call_ended', function(data) { 
        console.log('Call ended:', data);
        closeVideoOverlays_doc(); 
        if (data && data.ended_by && data.ended_by !== currentUserId) { 
            setTimeout(()=>{ window.location.href = '/doctor/dashboard'; }, 600); 
        } 
    });

    // ===== VOICE CALL LIFECYCLE LISTENERS =====
    
    socket.on('call_ringing', function(data) {
        console.log('Call ringing (outgoing voice):', data);
        if (data.call_type === 'voice') {
            const info = {
                appointment_id: data.appointment_id,
                call_type: 'voice'
            };
            showOutgoingVoiceOverlay_doc(info);
        }
    });

    socket.on('incoming_voice_call', function(data) {
        console.log('Incoming voice call:', data);
        const info = {
            appointment_id: data.appointment_id,
            caller_id: data.caller_id,
            caller_name: data.caller_name || 'Caller',
            caller_role: data.caller_role || 'User',
            caller_profile_pic: data.caller_profile_pic,
            call_type: 'voice'
        };
        showIncomingVoiceOverlay_doc(info);
    });

    socket.on('voice_call_accepted', function(data) {
        console.log('Voice call accepted:', data);
        closeVoiceOverlays_doc();
        if (data && data.appointment_id) {
            const connectedStub = document.createElement('div');
            connectedStub.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2200;';
            connectedStub.innerHTML = `<div style="background:#fff;border-radius:12px;padding:20px;min-width:240px;text-align:center;"><h5>Connected</h5><p style="color:#666;">Voice call connected</p></div>`;
            document.body.appendChild(connectedStub);
            setTimeout(()=>{ 
                connectedStub.remove(); 
                window.location.href = `/voice-call/${data.appointment_id}`; 
            }, 900);
        }
    });

    socket.on('call_ended_voice', function(data) {
        console.log('Voice call ended:', data);
        closeVoiceOverlays_doc();
        if (data && data.appointment_id) {
            setTimeout(()=>{ window.location.href = `/doctor/dashboard`; }, 600);
        }
    });

    socket.on('missed_call', function(data) {
        console.log('Missed call notification:', data);
    });
}

// Show typing indicator
function showTypingIndicator(userName) {
    const indicator = document.getElementById('typingIndicator');
    const typingUser = document.getElementById('typingUser');
    
    typingUser.textContent = `${userName} is typing...`;
    indicator.style.display = 'flex';
    
    // Auto-hide after 3 seconds
    setTimeout(hideTypingIndicator, 3000);
}

// Hide typing indicator
function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    indicator.style.display = 'none';
}

// Update message status
function updateMessageStatus(messageId, status) {
    const messages = document.querySelectorAll('.message-wrapper');
    messages.forEach(wrapper => {
        const timeElement = wrapper.querySelector('.message-time');
        if (timeElement) {
            const statusHTML = getMessageStatusHTML(status);
            // Find and update the status span
            const statusSpan = timeElement.querySelector('.tick');
            if (statusSpan) {
                statusSpan.outerHTML = statusHTML;
            }
        }
    });
}

// Update unread count
function updateUnreadCount(appointmentId) {
    // This would update the unread badge for the appointment
    // Implementation depends on how appointments are structured
}

// Update patient online status
function updatePatientOnlineStatus(patientId, isOnline) {
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.patientId === patientId.toString()) {
            const indicator = item.querySelector('.online-indicator');
            if (indicator) {
                indicator.className = isOnline ? 'online-indicator' : 'online-indicator offline';
            }
        }
    });
    
    // Update chat header if this is the current patient
    if (selectedPatientId === patientId) {
        const statusElement = document.getElementById('chatHeaderStatus');
        if (statusElement) {
            const currentText = statusElement.textContent;
            const newText = currentText.replace(/Online|Offline/, isOnline ? 'Online' : 'Offline');
            statusElement.textContent = newText;
        }
    }
}

// Update payment badge
function updatePaymentBadge(status) {
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.patientId === selectedPatientId?.toString()) {
            const paymentBadge = item.querySelector('.badge');
            if (paymentBadge) {
                if (status === 'paid') {
                    paymentBadge.className = 'badge bg-success ms-2';
                    paymentBadge.textContent = 'Paid';
                } else {
                    paymentBadge.className = 'badge bg-warning ms-2';
                    paymentBadge.textContent = 'Pending';
                }
            }
        }
    });
}

// -------------------------
// In-page Video Call UI (doctor)
// -------------------------
function playRingtoneDoc(loop=true, frequency=440) {
    try {
        if (!_ringAudioCtx_doc) _ringAudioCtx_doc = new (window.AudioContext || window.webkitAudioContext)();
        _ringOsc_doc = _ringAudioCtx_doc.createOscillator();
        const gain = _ringAudioCtx_doc.createGain();
        _ringOsc_doc.type = 'sine';
        _ringOsc_doc.frequency.setValueAtTime(frequency, _ringAudioCtx_doc.currentTime);
        _ringOsc_doc.connect(gain);
        gain.connect(_ringAudioCtx_doc.destination);
        gain.gain.setValueAtTime(0.0001, _ringAudioCtx_doc.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.18, _ringAudioCtx_doc.currentTime + 0.02);
        _ringOsc_doc.start();
        if (loop) {
            let on = true;
            _ringOsc_doc._pulse = setInterval(() => {
                gain.gain.cancelScheduledValues(_ringAudioCtx_doc.currentTime);
                gain.gain.setValueAtTime(on ? 0.18 : 0.0001, _ringAudioCtx_doc.currentTime);
                on = !on;
            }, 600);
        }
    } catch(e) {}
}
function stopRingtoneDoc() {
    try {
        if (_ringOsc_doc) {
            if (_ringOsc_doc._pulse) clearInterval(_ringOsc_doc._pulse);
            _ringOsc_doc.stop();
            _ringOsc_doc.disconnect();
            _ringOsc_doc = null;
        }
    } catch(e){}
}

function showOutgoingVideoOverlay_doc(callInfo) {
    closeVideoOverlays_doc();
    const overlay = document.createElement('div');
    overlay.id = 'outgoingVideoOverlay_doc';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2000;';
    overlay.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:28px;min-width:320px;max-width:420px;text-align:center;">
            <div id="callieAvatar_doc" style="width:96px;height:96px;border-radius:50%;margin:0 auto 12px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:32px;"></div>
            <div id="callieName_doc" style="font-weight:700;margin-bottom:6px;">${escapeHtml(callInfo.callee_name || 'Recipient')}</div>
            <div style="color:#666;margin-bottom:14px;">Video call</div>
            <div id="outgoingCallStatus_doc" style="margin-bottom:16px;color:#999;">Ringing...</div>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="endOutgoingCallBtn_doc" class="btn btn-danger">End call</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);
    const avatar = document.getElementById('callieAvatar_doc');
    if (callInfo.callee_profile_picture) avatar.innerHTML = `<img src="${callInfo.callee_profile_picture}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`; else avatar.textContent = getInitials(callInfo.callee_name || 'User');
    document.getElementById('endOutgoingCallBtn_doc').addEventListener('click', () => {
        stopRingtoneDoc();
        if (socket && socket.connected) socket.emit('end_call', { appointment_id: callInfo.appointment_id, ended_by: currentUserId });
        showNoAnswerOverlay_doc(callInfo);
        closeVideoOverlays_doc();
    });
    playRingtoneDoc(true, 520);
    overlay._ringTimeout = setTimeout(() => {
        stopRingtoneDoc();
        if (socket && socket.connected) socket.emit('reject_video_call', { appointment_id: callInfo.appointment_id, reason: 'no_answer' });
        closeVideoOverlays_doc();
        showNoAnswerOverlay_doc(callInfo);
    }, 60000);
}

function showNoAnswerOverlay_doc(callInfo) {
    closeVideoOverlays_doc();
    const modal = document.createElement('div');
    modal.id = 'noAnswerOverlay_doc';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2100;';
    modal.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:24px;min-width:320px;text-align:center;">
            <h5 style="color:#c00;margin-bottom:8px;">No answer</h5>
            <p style="color:#666;margin-bottom:16px;">The call was not answered. Would you like to redial?</p>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="redialBtn_doc" class="btn btn-primary">Redial</button>
                <button id="cancelNoAnswerBtn_doc" class="btn btn-outline-secondary">Cancel</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('redialBtn_doc').addEventListener('click', () => {
        modal.remove();
        if (socket && socket.connected) socket.emit('initiate_video_call', { caller_id: currentUserId, callee_id: callInfo.callee, appointment_id: callInfo.appointment_id });
    });
    document.getElementById('cancelNoAnswerBtn_doc').addEventListener('click', () => modal.remove());
}

function showIncomingVideoOverlay_doc(callInfo) {
    closeVideoOverlays_doc();
    const overlay = document.createElement('div');
    overlay.id = 'incomingVideoOverlay_doc';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2000;';
    overlay.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:26px;min-width:320px;max-width:420px;text-align:center;">
            <div id="callerAvatar_doc" style="width:96px;height:96px;border-radius:50%;margin:0 auto 12px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:32px;"></div>
            <div id="callerName_doc" style="font-weight:700;margin-bottom:6px;">${escapeHtml(callInfo.caller_name || 'Caller')}</div>
            <div id="callerRole_doc" style="color:#666;margin-bottom:14px;">Incoming video call from ${escapeHtml(callInfo.caller_role || '')}</div>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="acceptIncomingVideoBtn_doc" class="btn btn-success">Accept</button>
                <button id="hangupIncomingVideoBtn_doc" class="btn btn-danger">Hang up</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);
    const avatar = document.getElementById('callerAvatar_doc');
    if (callInfo.caller_profile_picture) avatar.innerHTML = `<img src="${callInfo.caller_profile_picture}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`; else avatar.textContent = getInitials(callInfo.caller_name || 'User');
    playRingtoneDoc(true, 380);
    document.getElementById('acceptIncomingVideoBtn_doc').addEventListener('click', () => {
        stopRingtoneDoc();
        if (socket && socket.connected) socket.emit('accept_video_call', { appointment_id: callInfo.appointment_id });
        closeVideoOverlays_doc();
    });
    document.getElementById('hangupIncomingVideoBtn_doc').addEventListener('click', () => {
        stopRingtoneDoc();
        if (socket && socket.connected) socket.emit('reject_video_call', { appointment_id: callInfo.appointment_id, reason: 'hung_up' });
        closeVideoOverlays_doc();
        setTimeout(()=>{ window.location.href = '/doctor/dashboard'; }, 400);
    });
    overlay._ringTimeout = setTimeout(() => {
        stopRingtoneDoc();
        if (socket && socket.connected) socket.emit('reject_video_call', { appointment_id: callInfo.appointment_id, reason: 'no_answer' });
        closeVideoOverlays_doc();
    }, 60000);
}

function closeVideoOverlays_doc() {
    ['outgoingVideoOverlay_doc','incomingVideoOverlay_doc','noAnswerOverlay_doc'].forEach(id => { const el=document.getElementById(id); if(el){ if(el._ringTimeout) clearTimeout(el._ringTimeout); el.remove(); }});
    stopRingtoneDoc();
}

socket.on('incoming_video_call', function(data) {
    const info = { id: data.id || data.call_id, caller: data.caller, callee: data.callee, appointment_id: data.appointment_id, caller_name: data.caller_name, caller_role: data.caller_role, caller_profile_picture: data.caller_profile_picture };
    showIncomingVideoOverlay_doc(info);
});

socket.on('outgoing_video_call_started', function(data) {
    const info = { id: data.id, caller: data.caller, callee: data.callee, appointment_id: data.appointment_id, callee_name: data.callee_name, callee_profile_picture: data.callee_profile_picture };
    showOutgoingVideoOverlay_doc(info);
});

socket.on('call_accepted', function(data) {
    closeVideoOverlays_doc();
    if (data && data.appointment_id) {
        const connectedStub = document.createElement('div');
        connectedStub.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2200;';
        connectedStub.innerHTML = `<div style="background:#fff;border-radius:12px;padding:20px;min-width:240px;text-align:center;"><h5>Connected</h5><p id=networkStrength_doc style=color:#666;>Network: Good</p></div>`;
        document.body.appendChild(connectedStub);
        setTimeout(()=>{ connectedStub.remove(); window.location.href = `/video-call/${data.appointment_id}`; }, 900);
    }
});

socket.on('call_rejected', function(data) { closeVideoOverlays_doc(); if (data && data.reason === 'no_answer') showNoAnswerOverlay_doc(data); });

socket.on('call_ended', function(data) { closeVideoOverlays_doc(); if (data && data.ended_by && data.ended_by !== currentUserId) { setTimeout(()=>{ window.location.href = '/doctor/dashboard'; }, 600); } });
function handleIncomingCall(data, callType) {
    const info = {
        id: data.id || data.call_id || data.callId,
        caller: data.caller || data.caller_id || data.from,
        callee: data.callee || data.callee_id || data.to,
        appointment_id: data.appointment_id || data.appointmentId,
        caller_name: data.caller_name || data.callerName || 'Patient',
        caller_role: data.caller_role || data.callerRole || 'Patient',
        caller_profile_picture: data.caller_profile_picture || data.caller_profile_picture_url || null
    };

    if (callType === 'video') {
        try { showIncomingVideoOverlay_doc(info); } catch (e) { console.error('Incoming overlay failed', e); }
    } else {
        // fallback to video overlay for voice if voice-specific overlay not present
        try { showIncomingVideoOverlay_doc(info); } catch (e) { console.error('Incoming overlay failed', e); }
    }

    // The overlay handles ringtone, timeout, and emits accept/reject to the server.
}

function setupIncomingCallHandlers(data, callType) {
    // Listen for accept/reject from incoming call window
    const checkCallResponse = setInterval(() => {
        const callResponse = safeStorage.getItem('callResponse');
        
        if (callResponse) {
            clearInterval(checkCallResponse);
            
            if (callResponse === 'accepted') {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit(`accept_${callType}_call`, {
                        appointment_id: data.appointment_id
                    });
                }
                
                // Redirect based on call type
                setTimeout(() => {
                    if (callType === 'video') {
                        window.location.href = `/video-call/${data.appointment_id}`;
                    } else if (callType === 'voice') {
                        window.location.href = `/communication/${data.appointment_id}`;
                    }
                }, 500);
            } else if (callResponse === 'rejected') {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit(`reject_${callType}_call`, {
                        appointment_id: data.appointment_id
                    });
                }
            }
            
            safeStorage.removeItem('callResponse');
        }
    }, 100);
    
    // Timeout after 70 seconds (longer than call timeout)
    setTimeout(() => {
        clearInterval(checkCallResponse);
    }, 70000);
}
</script>
{% endblock %}