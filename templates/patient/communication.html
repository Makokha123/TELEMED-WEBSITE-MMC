
{% extends "base.html" %}

{% block title %}My Communications - MAKOKHA MEDICAL CENTRE{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background: linear-gradient(135deg, #00a884 0%, #1e2a3a 100%);
        min-height: 100vh;
        padding: 20px;
    }
    body { margin: 0; padding: 0; }

    .whatsapp-container {
        display: flex;
        height: 90vh;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 5px 40px 16px rgba(82, 98, 130, 0.1);
    }

    /* Left Sidebar - Appointments List */
    .appointments-sidebar {
        width: 380px;
        background: #f0f2f5;
        border-right: 1px solid #e5e5e5;
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 20px 16px;
        background: #f0f2f5;
        border-bottom: 1px solid #e5e5e5;
    }

    .sidebar-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .sidebar-header-top h5 {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        color: #111b21;
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .profile-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-avatar.initials {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .online-indicator {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 14px;
        height: 14px;
        background: #31a24c;
        border: 2px solid white;
        border-radius: 50%;
    }

    .online-indicator.offline {
        background: #a0a0a0;
    }

    .sidebar-actions {
        display: flex;
        gap: 8px;
    }

    .sidebar-action-btn {
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #54656f;
        font-size: 20px;
        transition: background-color 0.2s;
    }

    .sidebar-action-btn:hover {
        background-color: #e9ecef;
    }

    .search-container {
        padding: 8px 12px;
    }

    .search-box {
        background: white;
        border: 1px solid #e5e5e5;
        border-radius: 24px;
        padding: 10px 16px;
        width: 100%;
        font-size: 14px;
        color: #111b21;
    }

    .search-box::placeholder {
        color: #999;
    }

    .appointments-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        background: white;
    }

    .appointments-list::-webkit-scrollbar {
        width: 6px;
    }

    .appointments-list::-webkit-scrollbar-track {
        background: transparent;
    }

    .appointments-list::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    .appointment-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f5f5f5;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
    }

    .appointment-item:hover {
        background-color: #f5f5f5;
    }

    .appointment-item.active {
        background-color: #e7f3ff;
    }

    .appointment-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
    }

    .appointment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .appointment-avatar.initials {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
    }

    .appointment-content {
        flex: 1;
        min-width: 0;
    }

    .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }

    .appointment-name {
        font-weight: 600;
        color: #111b21;
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .appointment-time {
        font-size: 12px;
        color: #999;
        flex-shrink: 0;
    }

    .appointment-preview {
        font-size: 13px;
        color: #667781;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .unread-badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #25d366;
        color: white;
        font-size: 12px;
        font-weight: 600;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 4px;
        display: inline-block;
    }

    .status-indicator.online {
        background: #31a24c;
    }

    .status-indicator.offline {
        background: #a0a0a0;
    }

    /* Right Chat Area */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #efeae2;
        position: relative;
        background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2300a884' fill-opacity='0.04' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    .chat-header {
        padding: 10px 16px;
        background: #f0f2f5;
        border-bottom: 1px solid #e5e5e5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 60px;
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        min-width: 0;
    }

    .chat-header-info {
        min-width: 0;
    }

    .chat-header-name {
        font-weight: 600;
        color: #111b21;
        font-size: 16px;
        margin: 0;
    }

    .chat-header-status {
        font-size: 13px;
        color: #667781;
        margin: 0;
    }

    .chat-header-actions {
        display: flex;
        gap: 10px;
    }

    .chat-action-btn {
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #54656f;
        font-size: 20px;
        transition: background-color 0.2s;
    }

    .chat-action-btn:hover {
        background-color: #e9ecef;
    }

    /* Chat Messages Area */
    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    /* Message Bubbles */
    .message-wrapper {
        display: flex;
        margin-bottom: 8px;
        max-width: 100%;
    }

    .message-wrapper.sent {
        justify-content: flex-end;
    }

    .message-wrapper.received {
        justify-content: flex-start;
    }

    .message-container {
        max-width: 65%;
        display: flex;
        flex-direction: column;
    }

    .message-bubble {
        padding: 8px 12px;
        border-radius: 7.5px;
        font-size: 14.2px;
        line-height: 19px;
        word-wrap: break-word;
        position: relative;
        box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
    }

    .message-bubble.sent {
        background: #d9fdd3;
        color: #111b21;
        border-radius: 7.5px 7.5px 0 7.5px;
        margin-left: auto;
        border: 1px solid #d1f7c4;
    }

    .message-bubble.received {
        background: white;
        color: #111b21;
        border-radius: 7.5px 7.5px 7.5px 0;
        margin-right: auto;
        border: 1px solid #e9edef;
    }

    .message-time {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
        margin-top: 2px;
        font-size: 11px;
        color: #667781;
        padding: 0 4px;
    }

    .message-status {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .tick {
        font-size: 14px;
        line-height: 1;
    }

    .tick.single {
        color: #667781;
    }

    .tick.double.grey {
        color: #667781;
    }

    .tick.double.blue {
        color: #53bdeb;
    }

    /* Message Content Types */
    .message-text {
        white-space: pre-wrap;
        word-break: break-word;
    }

    .message-file {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 5px;
        margin-top: 4px;
    }

    .message-file i {
        font-size: 24px;
        color: #54656f;
    }

    .message-file a {
        color: #007bff;
        text-decoration: none;
        font-weight: 500;
    }

    .message-file a:hover {
        text-decoration: underline;
    }

    .voice-message {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 5px;
    }

    .voice-message i {
        font-size: 20px;
        color: #54656f;
        cursor: pointer;
    }

    .voice-waveform {
        flex: 1;
        height: 20px;
        background: linear-gradient(90deg, #54656f 0%, #54656f 50%, transparent 50%);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }

    .voice-duration {
        font-size: 12px;
        color: #54656f;
        font-weight: 500;
    }

    /* Typing Indicator */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: white;
        border-radius: 7.5px 7.5px 7.5px 0;
        width: fit-content;
        border: 1px solid #e9edef;
        margin-bottom: 8px;
    }

    .typing-text {
        font-size: 12px;
        color: #667781;
        font-style: italic;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dot {
        width: 6px;
        height: 6px;
        background: #667781;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    /* Chat Input Area */
    .chat-input-area {
        padding: 10px 16px;
        background: #f0f2f5;
        border-top: 1px solid #e5e5e5;
        display: flex;
        gap: 10px;
        align-items: center;
        min-height: 62px;
    }

    .input-action-btn {
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #54656f;
        font-size: 22px;
        transition: background-color 0.2s;
    }

    .input-action-btn:hover {
        background-color: #e9ecef;
    }

    .input-action-btn.recording {
        color: #f44336;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .message-input-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        background: white;
        border-radius: 24px;
        padding: 5px 12px;
        border: 1px solid #e5e5e5;
    }

    .message-input {
        flex: 1;
        border: none;
        padding: 10px 8px;
        font-size: 15px;
        font-family: inherit;
        resize: none;
        max-height: 100px;
        outline: none;
        background: transparent;
        color: #111b21;
    }

    .message-input::placeholder {
        color: #999;
    }

    .input-emoji-btn {
        background: none;
        border: none;
        color: #54656f;
        font-size: 22px;
        cursor: pointer;
        padding: 0 8px;
    }

    .send-btn {
        background: #25d366;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    .send-btn:hover {
        background: #1da851;
    }

    .send-btn:disabled {
        background: #a0a0a0;
        cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #667781;
        gap: 16px;
        text-align: center;
        padding: 40px;
    }

    .empty-state-icon {
        font-size: 80px;
        color: #ddd;
    }

    .empty-state-text {
        font-size: 16px;
        font-weight: 500;
        color: #667781;
    }

    .empty-state-subtext {
        font-size: 14px;
        color: #999;
    }

    /* Recording UI */
    .recording-ui {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 16px;
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
    }

    .recording-timer {
        font-size: 14px;
        font-weight: 600;
        color: #f44336;
    }

    .recording-wave {
        flex: 1;
        height: 30px;
        background: linear-gradient(90deg, #f44336 0%, #f44336 50%, transparent 50%);
        border-radius: 15px;
        position: relative;
        overflow: hidden;
    }

    .recording-actions {
        display: flex;
        gap: 8px;
    }

    .recording-action-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: #54656f;
        font-size: 18px;
    }

    .recording-action-btn.send {
        color: #25d366;
    }

    .recording-action-btn.cancel {
        color: #f44336;
    }
    .doctor-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
    }
    
    .payment-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 40px;
        text-align: center;
    }
    
    .payment-icon {
        font-size: 64px;
        color: #ffc107;
        margin-bottom: 20px;
    }
    
    .payment-message {
        max-width: 400px;
    }
    
    .payment-message h4 {
        color: #333;
        margin-bottom: 12px;
    }
    
    .payment-message p {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
    }
    /* Payment Overlay */
    .payment-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 40px;
        text-align: center;
    }

    .payment-icon {
        font-size: 64px;
        color: #ffc107;
        margin-bottom: 20px;
    }

    .payment-message {
        max-width: 400px;
    }

    .payment-message h4 {
        color: #333;
        margin-bottom: 12px;
    }

    .payment-message p {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
    }

    /* Date Separator */
    .date-separator {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 16px 0;
    }

    .date-label {
        background: rgba(0, 0, 0, 0.1);
        padding: 4px 12px;
        border-radius: 14px;
        font-size: 12px;
        color: #667781;
        font-weight: 500;
    }

    /* Loading Animation */
    .loading-messages {
        display: flex;
        justify-content: center;
        padding: 20px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #25d366;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .whatsapp-container {
            height: calc(100vh - 40px);
        }
        
        .appointments-sidebar {
            width: 100%;
        }
        
        .chat-area {
            display: none;
        }
        
        .chat-area.active {
            display: flex;
        }
        
        .back-to-list {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
        }
    }

</style>
{% endblock %}

{% block content %}
<div class="whatsapp-container">
    <!-- Left Sidebar - Doctors List -->
    <div class="appointments-sidebar" id="appointmentsSidebar">
        <div class="sidebar-header">
            <div class="sidebar-header-top">
                <h5>My Doctors</h5>
                <div class="sidebar-actions">
                    <div class="user-profile">
                        <div class="profile-avatar" id="userProfileAvatar">
                            <!-- Profile picture will be loaded here -->
                        </div>
                    </div>
                            <button class="sidebar-action-btn" title="Contact Admin" id="contactAdminBtn">
                                <i class="fas fa-shield-alt"></i>
                            </button>
                            <button class="sidebar-action-btn" title="Status" id="statusBtn">
                                <i class="fas fa-circle" id="statusIcon"></i>
                            </button>
                            <button class="sidebar-action-btn" title="Book appointment" id="bookBtn">
                                <i class="fas fa-calendar-plus"></i>
                            </button>
                            <button class="sidebar-action-btn" title="Menu" id="menuBtn">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                </div>
            </div>
            <div class="search-container">
                <input type="text" class="search-box" id="searchDoctors" placeholder="Search doctors...">
            </div>
        </div>

        <div class="appointments-list" id="doctorsList">
            <!-- Doctors will be loaded here -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="empty-state-text">No doctors yet</div>
                <div class="empty-state-subtext">Your doctor consultations will appear here</div>
            </div>
        </div>
    </div>

    <!-- Right Chat Area -->
    <div class="chat-area" id="chatArea">
        <!-- Chat Header -->
        <div class="chat-header" id="chatHeader">
            <div class="chat-header-left">
                <div class="back-to-list" id="backToList" style="display: none;">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="profile-avatar" id="chatAvatar">
                    <!-- Doctor profile picture will be loaded here -->
                </div>
                <div class="chat-header-info">
                    <h6 class="chat-header-name" id="chatHeaderName">Select a doctor</h6>
                    <p class="chat-header-status" id="chatHeaderStatus">Start a consultation</p>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="chat-action-btn" id="openCallLogsHeaderBtn" title="Call logs" data-bs-toggle="modal" data-bs-target="#callLogsModal" style="margin-right:6px; background: linear-gradient(135deg,#198754 0%,#157347 100%); color: #fff; border: none;">
                    <i class="fas fa-list"></i>
                </button>
                <button class="chat-action-btn" id="voiceCallBtn" title="Voice call">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="chat-action-btn" id="videoCallBtn" title="Video call">
                    <i class="fas fa-video"></i>
                </button>
                <button class="chat-action-btn" id="infoBtn" title="Doctor info">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <div class="empty-state-text">Select a doctor to start consultation</div>
                <div class="empty-state-subtext">Send messages, voice notes, and files securely</div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span class="typing-text" id="typingUser">Doctor is typing...</span>
        </div>

        <!-- Message Input Area -->
        <div class="chat-input-area" id="chatInputArea">
            <button class="input-action-btn" id="emojiBtn" title="Emoji">
                <i class="far fa-smile"></i>
            </button>
            
            <button class="input-action-btn" id="attachBtn" title="Attach file">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt,.xlsx,.mp3,.wav,.mp4">
            
            <div class="message-input-wrapper">
                <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." disabled>
                <button class="input-emoji-btn" id="emojiPickerBtn">
                    <i class="far fa-smile"></i>
                </button>
            </div>
            
            <button class="input-action-btn" id="voiceRecordBtn" title="Record voice note">
                <i class="fas fa-microphone"></i>
            </button>
            
            <button class="send-btn" id="sendMessageBtn" title="Send message" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

        <!-- Recording UI -->
        <div class="recording-ui" id="recordingUI" style="display: none;">
            <div class="recording-timer" id="recordingTimer">00:00</div>
            <div class="recording-wave" id="recordingWave"></div>
            <div class="recording-actions">
                <button class="recording-action-btn cancel" id="cancelRecordingBtn" title="Cancel">
                    <i class="fas fa-times"></i>
                </button>
                <button class="recording-action-btn send" id="sendRecordingBtn" title="Send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Payment Overlay -->
        <div class="payment-overlay" id="paymentOverlay" style="display: none;">
            <div class="payment-icon">
                <i class="fas fa-lock"></i>
            </div>
            <div class="payment-message">
                <h4>Complete Payment to Unlock Features</h4>
                <p>Please complete your payment to access messaging, voice calls, video calls, and file sharing for this consultation.</p>
                <button class="btn btn-primary" id="goToPaymentBtn">
                    <i class="fas fa-credit-card me-2"></i>
                    Complete Payment
                </button>
                <button class="btn btn-outline-secondary mt-2" id="checkPaymentStatusBtn">
                    <i class="fas fa-sync me-2"></i>
                    Check Payment Status
                </button>
                <button class="btn btn-link mt-2" id="backToDashboardBtn">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to Dashboard
                </button>
            </div>
        </div>

        <!-- Admin Contact Dropdown -->
        <div class="admin-dropdown" id="adminDropdown" style="display: none; position: absolute; top: 60px; right: 20px; background: white; border: 1px solid #e5e5e5; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; min-width: 250px;">
            <div style="padding: 12px; border-bottom: 1px solid #e5e5e5;">
                <h6 style="margin: 0; font-weight: 600; color: #111b21;">Contact Support</h6>
            </div>
            <div id="adminListContainer" style="max-height: 300px; overflow-y: auto;">
                <div style="padding: 12px; text-align: center; color: #999;">
                    <i class="fas fa-spinner fa-spin"></i> Loading admins...
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- Call logs panel -->
        <div style="position: absolute; top: 24px; right: 24px; width: 360px; z-index: 40;">
            {% include 'communication/_call_logs_partial.html' %}
        </div>

<!-- Outgoing Video Call Modal -->
<div class="modal fade" id="outgoingVideoCallModal" tabindex="-1" aria-labelledby="outgoingVideoCallLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="modal-body text-center text-white py-5">
                <div style="margin-bottom: 30px;">
                    <div class="avatar-large" id="outgoingVideoDoctorAvatar" style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">
                        D
                    </div>
                    <h5 id="outgoingVideoDoctorName" style="margin-bottom: 10px;">Doctor Name</h5>
                    <p style="margin: 0; opacity: 0.9;">Video call in progress...</p>
                </div>
                <div style="margin: 40px 0;">
                    <div class="spinner-border text-light" role="status" style="width: 60px; height: 60px;">
                        <span class="visually-hidden">Calling...</span>
                    </div>
                </div>
                <div style="margin-top: 40px; display: flex; gap: 10px; justify-content: center;">
                    <button type="button" class="btn btn-danger btn-lg" id="rejectOutgoingVideoCallBtn" style="border-radius: 50%; width: 60px; height: 60px; padding: 0; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-phone-slash" style="font-size: 24px;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Outgoing Voice Call Modal -->
<div class="modal fade" id="outgoingVoiceCallModal" tabindex="-1" aria-labelledby="outgoingVoiceCallLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="modal-body text-center text-white py-5">
                <div style="margin-bottom: 30px;">
                    <div class="avatar-large" id="outgoingVoiceDoctorAvatar" style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">
                        D
                    </div>
                    <h5 id="outgoingVoiceDoctorName" style="margin-bottom: 10px;">Doctor Name</h5>
                    <p style="margin: 0; opacity: 0.9;">Calling...</p>
                </div>
                <div style="margin: 40px 0;">
                    <div class="spinner-border text-light" role="status" style="width: 60px; height: 60px;">
                        <span class="visually-hidden">Calling...</span>
                    </div>
                </div>
                <div style="margin-top: 40px; display: flex; gap: 10px; justify-content: center;">
                    <button type="button" class="btn btn-danger btn-lg" id="rejectOutgoingVoiceCallBtn" style="border-radius: 50%; width: 60px; height: 60px; padding: 0; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-phone-slash" style="font-size: 24px;"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden elements for data -->
<input type="hidden" id="currentUserId" value="{{ current_user.id }}">
<input type="hidden" id="currentUserRole" value="{{ current_user.role }}">
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

<!-- Server-provided ICE servers as JSON to avoid injecting Jinja braces directly into JS -->
<script type="application/json" id="iceServersData">{{ iceServers | tojson | safe }}</script>

<!-- User menu (small) -->
<div class="dropdown" id="userMenuDropdown" style="position: absolute; z-index: 1050; display:none;">
    <div class="card p-2">
        <a href="/profile" class="d-block mb-1">View profile</a>
        <a href="/settings" class="d-block mb-1">Settings</a>
        <a href="/logout" class="d-block">Logout</a>
    </div>
</div>

<!-- Audio element for voice messages -->
<audio id="voicePlayer" style="display: none;"></audio>
{% endblock %}

{% block extra_js %}
<script type="module">
  // Gracefully load emoji-picker; fail silently if CDN unavailable
  try {
    await import('https://cdn.jsdelivr.net/npm/emoji-picker-element@latest/dist/index.js');
  } catch (e) {
    console.warn('Emoji picker CDN unavailable; emoji functionality disabled', e);
    // Emoji picker is optional; continue without it
  }
</script>

<!-- Real-time Communication Libraries -->
<script src="{{ url_for('static', filename='js/webrtc-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/signaling-client.js') }}"></script>
<script src="{{ url_for('static', filename='js/call-manager.js') }}"></script>

<script>
const csrfToken = document.querySelector('input[name="csrf_token"]').value;
const currentUserId = parseInt(document.getElementById('currentUserId').value);
const currentUserRole = document.getElementById('currentUserRole').value;
const DEFAULT_TIMEZONE = 'Africa/Nairobi'; // EAT (East Africa Time)

// Global state
let selectedAppointmentId = null;
let selectedDoctorId = null;
let selectedDoctorData = null;
let isRecording = false;
let recordingStartTime = null;
let recordingTimer = null;
let mediaRecorder = null;
let recordedChunks = [];
let isTyping = false;
let typingTimeout = null;
let emojiPicker = null;
let paymentStatus = 'pending';

// SafeStorage utility for Tracking Prevention compatibility
const safeStorage = {
    getItem: function(key) {
        try {
            return sessionStorage.getItem(key);
        } catch (e) {
            return window[`__storage_${key}`] || null;
        }
    },
    setItem: function(key, value) {
        try {
            sessionStorage.setItem(key, value);
        } catch (e) {
            window[`__storage_${key}`] = value;
        }
    },
    removeItem: function(key) {
        try {
            sessionStorage.removeItem(key);
        } catch (e) {
            delete window[`__storage_${key}`];
        }
    }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadUserProfilePicture();
    loadDoctorsWithAppointments(); // Changed from loadDoctors()
    setupEventListeners();
    setupAdminContact();
    setupSocketIO();
    setupEmojiPicker();
    initializeCallManager();
});

// Initialize CallManager for real-time communication
function initializeCallManager() {
    // Wait for socket to be ready
    if (!window.socket || !window.socket.connected) {
        setTimeout(initializeCallManager, 500);
        return;
    }
    
    // Initialize CallManager with WebRTC and signaling clients
    if (typeof CallManager !== 'undefined') {
        // Read ICE servers JSON injected in DOM to avoid JS parser errors in editors
        const iceServersEl = document.getElementById('iceServersData');
        const iceServersConfig = (iceServersEl && iceServersEl.textContent) ? JSON.parse(iceServersEl.textContent) : [];
        // Ensure we have a signaling client (reuse global if present)
        let _signaling = window.signalingClient || null;
        if (!_signaling) {
            if (typeof SignalingClient === 'function') {
                try {
                    _signaling = new SignalingClient(window.socket);
                    window.signalingClient = _signaling;
                } catch (e) {
                    console.error('Failed to construct SignalingClient, retrying...', e);
                    setTimeout(initializeCallManager, 500);
                    return;
                }
            } else {
                console.warn('SignalingClient not available yet; retrying...');
                setTimeout(initializeCallManager, 500);
                return;
            }
        }

        // Only create CallManager if signaling client exposes the expected interface
        if (!(typeof _signaling.addEventListener === 'function' || typeof _signaling.on === 'function')) {
            console.warn('Signaling client missing required interface; retrying...');
            setTimeout(initializeCallManager, 500);
            return;
        }

        window.callManager = new CallManager(
            _signaling,
            {
                iceServers: iceServersConfig,
                audioConstraints: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                },
                videoConstraints: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    frameRate: { ideal: 30 }
                }
            }
        );
        
        // Attach event handlers for CallManager
        window.callManager.onStateChange = function(state) {
            console.log('Call state changed:', state);
            updateCallUI(state);
        };
        
        window.callManager.onQualityUpdate = function(metrics) {
            console.log('Quality metrics:', metrics);
            updateQualityIndicator(metrics);
            // Send metrics to server
            if (window.socket) {
                const meta = (typeof window.callManager.getCallMetadata === 'function') ? window.callManager.getCallMetadata() : { callId: window.callManager.callId, appointmentId: window.callManager.appointmentId };
                const metricsData = Object.assign({ call_id: meta.callId, appointment_id: meta.appointmentId }, metrics);
                window.socket.emit('quality:metrics', metricsData);
            }
        };
        
        window.callManager.onError = function(error) {
            console.error('Call error:', error);
            showNotification('Call Error: ' + error, 'error');
        };
        
        console.log('CallManager initialized successfully');
    }
}

// Update call UI based on call manager state
function updateCallUI(state) {
    // This will be called as call state changes
    // state: idle, initiated, ringing, connecting, connected, ended, failed
    console.log('Call UI updated for state:', state);
    
    // Update UI elements based on state
    const statusEl = document.getElementById('callStatus');
    if (statusEl) {
        statusEl.textContent = state.toUpperCase();
    }
}

// Update quality indicator
function updateQualityIndicator(metrics) {
    const qualityEl = document.getElementById('qualityIndicator');
    if (qualityEl && metrics.audio_quality) {
        let qualityColor = 'green';
        if (metrics.audio_quality === 'poor') qualityColor = 'red';
        else if (metrics.audio_quality === 'fair') qualityColor = 'orange';
        else if (metrics.audio_quality === 'good') qualityColor = 'yellow';
        
        qualityEl.style.backgroundColor = qualityColor;
        qualityEl.title = `Quality: ${metrics.audio_quality}, RTT: ${metrics.rtt}ms`;
    }
}

// Setup admin contact functionality
function setupAdminContact() {
    const contactAdminBtn = document.getElementById('contactAdminBtn');
    if (contactAdminBtn) {
        contactAdminBtn.addEventListener('click', toggleAdminDropdown);
    }
    
    // Load admins list
    loadAdminsList();
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('adminDropdown');
        if (dropdown && !dropdown.contains(e.target) && e.target.id !== 'contactAdminBtn') {
            dropdown.style.display = 'none';
        }
    });
}

// Toggle admin dropdown
function toggleAdminDropdown() {
    const dropdown = document.getElementById('adminDropdown');
    if (dropdown.style.display === 'none') {
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
}

// Load admins list
function loadAdminsList() {
    const container = document.getElementById('adminListContainer');
    if (!container) {
        console.error('Admin list container not found');
        return;
    }
    
    fetch('/api/admins-list', { credentials: 'same-origin' })
        .then(response => {
            if (!response.ok) {
                // Try to read text for debugging (could be HTML login page on redirect)
                return response.text().then(text => { throw new Error('Network error: ' + response.status + ' - ' + text); });
            }
            const ct = response.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
                return response.json();
            }
            // Unexpected content-type (likely HTML) - fetch text for debugging
            return response.text().then(text => { throw new Error('Unexpected response (not JSON): ' + text); });
        })
        .then(data => {
            container.innerHTML = '';
            
            if (!data.admins || data.admins.length === 0) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: #999;">No admins available</div>';
                return;
            }
            
            data.admins.forEach(admin => {
                const adminItem = document.createElement('div');
                adminItem.style.cssText = 'padding: 12px; border-bottom: 1px solid #e5e5e5; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s;';
                adminItem.onmouseover = () => adminItem.style.background = '#f0f0f0';
                adminItem.onmouseout = () => adminItem.style.background = 'transparent';
                
                const avatar = document.createElement('div');
                avatar.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;';
                avatar.textContent = getInitials(`${admin.first_name} ${admin.last_name}`);
                
                const info = document.createElement('div');
                info.style.cssText = 'flex: 1;';
                info.innerHTML = `<div style="font-weight: 500; color: #111b21;">${admin.first_name} ${admin.last_name}</div><div style="font-size: 12px; color: #999;">${admin.email}</div>`;
                
                adminItem.appendChild(avatar);
                adminItem.appendChild(info);
                adminItem.addEventListener('click', () => contactAdmin(admin.id, admin));
                container.appendChild(adminItem);
            });
        })
        .catch(error => {
            console.error('Error loading admins:', error);
            if (container) {
                container.innerHTML = '<div style="padding: 12px; text-align: center; color: #999;">Error loading admins</div>';
            }
        });
}

// Contact admin
function contactAdmin(adminId, adminData) {
    selectedAppointmentId = null;
    selectedDoctorId = adminId;
    selectedDoctorData = adminData;
    
    // Update chat header
    const chatHeaderName = document.getElementById('chatHeaderName');
    const chatHeaderStatus = document.getElementById('chatHeaderStatus');
    const chatAvatar = document.getElementById('chatAvatar');
    
    const name = `${adminData.first_name} ${adminData.last_name}`;
    const avatarText = getInitials(name);
    
    chatHeaderName.textContent = `${name} (Support)`;
    chatHeaderStatus.innerHTML = `<span class="status-indicator online"></span>Online â€¢ Support`;
    chatAvatar.textContent = avatarText;
    chatAvatar.classList.add('initials');
    
    // Show chat area
    if (window.innerWidth <= 768) {
        document.getElementById('appointmentsSidebar').style.display = 'none';
        document.getElementById('chatArea').style.display = 'flex';
        document.getElementById('backToList').style.display = 'flex';
    }
    
    // Unlock chat features (admin chats are always free)
    const paymentOverlay = document.getElementById('paymentOverlay');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    
    paymentOverlay.style.display = 'none';
    messageInput.disabled = false;
    sendMessageBtn.disabled = false;
    
    // Load admin conversation
    loadAdminConversation(adminId);
    
    // Close dropdown
    document.getElementById('adminDropdown').style.display = 'none';
}

// Load admin conversation
function loadAdminConversation(adminId) {
    fetch(`/api/admin-conversation/${adminId}`)
        .then(response => response.json())
        .then(data => {
            const messagesArea = document.getElementById('chatMessages');
            messagesArea.innerHTML = '';
            
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    const messageEl = createMessageElement(msg);
                    messagesArea.appendChild(messageEl);
                });
            }
            
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Join socket room for admin
            if (typeof socket !== 'undefined') {
                socket.emit('join_admin_chat', { admin_id: adminId });
            }
        })
        .catch(error => {
            console.error('Error loading admin conversation:', error);
        });
}

// Back to dashboard function
function backToDashboard() {
    window.location.href = '/patient/dashboard';
}

// Load patient's profile picture (same as doctor version but for patient)
function loadUserProfilePicture() {
    fetch(`/api/user/${currentUserId}/profile`)
        .then(response => response.json())
        .then(data => {
            const profileAvatar = document.getElementById('userProfileAvatar');
            if (data.profile_picture_url) {
                profileAvatar.innerHTML = `<img src="${data.profile_picture_url}" alt="Profile">`;
                profileAvatar.classList.remove('initials');
            } else {
                const initials = getInitials(data.name || 'PT');
                profileAvatar.textContent = initials;
                profileAvatar.classList.add('initials');
            }
        })
        .catch(error => {
            console.error('Error loading profile picture:', error);
            const profileAvatar = document.getElementById('userProfileAvatar');
            profileAvatar.textContent = 'PT';
            profileAvatar.classList.add('initials');
        });
}

// Load doctors with appointments (similar to loadPatients() in doctor version)
function loadDoctorsWithAppointments() {
    fetch('/api/patient/appointments')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const list = document.getElementById('doctorsList');
            list.innerHTML = '';
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-user-md"></i></div>
                        <div class="empty-state-text">No doctors yet</div>
                        <div class="empty-state-subtext">Your doctor consultations will appear here</div>
                    </div>
                `;
                return;
            }

            // Sort appointments by appointment date (descending - closest upcoming first)
            const sortedAppointments = [...data].sort((a, b) => {
                const dateA = new Date(a.appointment_date || 0);
                const dateB = new Date(b.appointment_date || 0);
                return dateB - dateA; // Descending order (newest first)
            });

            // Create appointment items - each appointment separately
            sortedAppointments.forEach(appointmentData => {
                const item = createAppointmentItem(appointmentData);
                if (item) {
                    list.appendChild(item);
                }
            });
            
            // Add scroll if more than 3 appointments
            if (sortedAppointments.length > 3) {
                list.style.maxHeight = '300px';
                list.style.overflowY = 'auto';
            } else {
                list.style.maxHeight = 'auto';
            }
        })
        .catch(error => {
            console.error('Error loading appointments:', error);
            const list = document.getElementById('doctorsList');
            list.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="empty-state-text">Error loading appointments</div>
                    <div class="empty-state-subtext">${error.message}</div>
                    <button class="btn btn-sm btn-primary mt-2" onclick="location.reload()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
            `;
        });
}

// Create appointment item (each appointment separately)
function createAppointmentItem(appointmentData) {
    try {
        const div = document.createElement('div');
        div.className = 'appointment-item';
        
        const appointmentId = appointmentData?.appointment_id;
        const doctor = appointmentData?.doctor;
        
        if (!appointmentId || !doctor) {
            console.warn('Missing appointment or doctor data:', appointmentData);
            return null;
        }
        
        div.dataset.appointmentId = appointmentId;
        div.dataset.doctorId = doctor.id;
        div.dataset.paymentStatus = appointmentData?.payment_status || 'pending';
        
        const name = `Dr. ${doctor.first_name} ${doctor.last_name}`;
        const avatarText = getInitials(name);
        const profilePictureUrl = doctor.profile_picture_url;
        
        // Format appointment date for display
        const appointmentDate = appointmentData?.appointment_date ? new Date(appointmentData.appointment_date) : null;
        let appointmentDateDisplay = '';
        if (appointmentDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (appointmentDate.toDateString() === today.toDateString()) {
                appointmentDateDisplay = 'Today ' + appointmentData.appointment_time;
            } else if (appointmentDate.toDateString() === tomorrow.toDateString()) {
                appointmentDateDisplay = 'Tomorrow ' + appointmentData.appointment_time;
            } else {
                appointmentDateDisplay = appointmentDate.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + appointmentData.appointment_time;
            }
        }
        
        // Payment badge
        const paymentBadge = appointmentData?.payment_status === 'paid' ? 
            '<span class="badge bg-success ms-2">Paid</span>' : 
            '<span class="badge bg-warning ms-2">Pending</span>';
        
        div.innerHTML = `
            <div class="appointment-avatar ${profilePictureUrl ? '' : 'initials'}" 
                 data-profile-picture="${profilePictureUrl || ''}">
                ${profilePictureUrl ? `<img src="${profilePictureUrl}" alt="${name}">` : avatarText}
                <div class="online-indicator ${doctor.is_online ? '' : 'offline'}"></div>
            </div>
            <div class="appointment-content">
                <div class="appointment-header">
                    <span class="appointment-name">${name}</span>
                    <span class="appointment-time">${appointmentData?.last_message_time || ''}</span>
                </div>
                <div class="appointment-preview">${appointmentData?.last_message || 'No messages yet'}</div>
                <div class="appointment-details">
                    <small class="text-muted">
                        ${doctor.specialization || 'General Practitioner'} â€¢ ${appointmentDateDisplay} ${paymentBadge}
                    </small>
                </div>
            </div>
            ${appointmentData?.unread_count > 0 ? `<div class="unread-badge">${appointmentData.unread_count}</div>` : ''}
        `;
        
        // Load profile picture if available
        if (profilePictureUrl) {
            setTimeout(() => {
                const avatar = div.querySelector('.appointment-avatar');
                if (avatar && avatar.dataset.profilePicture) {
                    const img = document.createElement('img');
                    img.src = avatar.dataset.profilePicture;
                    img.alt = name;
                    img.onload = () => {
                        if (avatar) {
                            avatar.innerHTML = '';
                            avatar.appendChild(img);
                            const indicator = document.createElement('div');
                            indicator.className = doctor.is_online ? 'online-indicator' : 'online-indicator offline';
                            avatar.appendChild(indicator);
                        }
                    };
                    img.onerror = () => {
                        if (avatar) {
                            avatar.textContent = avatarText;
                            avatar.classList.add('initials');
                            const indicator = document.createElement('div');
                            indicator.className = doctor.is_online ? 'online-indicator' : 'online-indicator offline';
                            avatar.appendChild(indicator);
                        }
                    };
                }
            }, 100);
        }
        
        div.addEventListener('click', () => selectAppointment(appointmentId, doctor, appointmentData));
        return div;
    } catch (error) {
        console.error('Error creating appointment item:', error);
        return null;
    }
}

// Select appointment
function selectAppointment(appointmentId, doctorData, appointmentData) {
    selectedAppointmentId = appointmentId;
    selectedDoctorId = doctorData?.id;
    selectedDoctorData = doctorData;
    
    // Update selected state
    document.querySelectorAll('.appointment-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.appointmentId === appointmentId.toString()) {
            item.classList.add('active');
            paymentStatus = item.dataset.paymentStatus;
        }
    });
    
    // Update UI for mobile
    if (window.innerWidth <= 768) {
        document.getElementById('appointmentsSidebar').style.display = 'none';
        document.getElementById('chatArea').style.display = 'flex';
        document.getElementById('backToList').style.display = 'flex';
    }
    
    // Load appointment details
    loadAppointmentDetails(appointmentId);
}

// Load appointment details
function loadAppointmentDetails(appointmentId) {
    fetch(`/api/appointment/${appointmentId}/details`)
        .then(response => response.json())
        .then(data => {
            // Update chat header
            const chatHeaderName = document.getElementById('chatHeaderName');
            const chatHeaderStatus = document.getElementById('chatHeaderStatus');
            const chatAvatar = document.getElementById('chatAvatar');
            
            const name = `Dr. ${data.doctor_first_name} ${data.doctor_last_name}`;
            const avatarText = getInitials(name);
            
            chatHeaderName.textContent = name;
            chatHeaderStatus.innerHTML = `
                <span class="status-indicator ${data.doctor_online ? 'online' : 'offline'}"></span>
                ${data.doctor_online ? 'Online' : 'Offline'} â€¢ ${data.consultation_type || 'Consultation'}
            `;
            
            // Load profile picture
            if (data.doctor_profile_picture) {
                chatAvatar.innerHTML = `<img src="${data.doctor_profile_picture}" alt="${name}">`;
                chatAvatar.classList.remove('initials');
            } else {
                chatAvatar.textContent = avatarText;
                chatAvatar.classList.add('initials');
            }
            
            // Check payment status
            checkPaymentStatus(appointmentId);
            
            // Load messages
            loadMessages(appointmentId);
            
            // Enable input
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendMessageBtn').disabled = false;
            
            // Join socket room
            socket.emit('join_appointment', { appointment_id: appointmentId });
        })
        .catch(error => {
            console.error('Error loading appointment details:', error);
        });
}

// Check payment status
function checkPaymentStatus(appointmentId) {
    fetch(`/api/appointment/${appointmentId}/payment-status`)
        .then(response => response.json())
        .then(data => {
            paymentStatus = data.payment_status || 'pending';
            
            const paymentOverlay = document.getElementById('paymentOverlay');
            const messageInput = document.getElementById('messageInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const attachBtn = document.getElementById('attachBtn');
            const voiceRecordBtn = document.getElementById('voiceRecordBtn');
            const voiceCallBtn = document.getElementById('voiceCallBtn');
            const videoCallBtn = document.getElementById('videoCallBtn');
            
            if (data.payment_required && paymentStatus !== 'paid') {
                paymentOverlay.style.display = 'flex';
                messageInput.disabled = true;
                sendMessageBtn.disabled = true;
                attachBtn.disabled = true;
                voiceRecordBtn.disabled = true;
                voiceCallBtn.disabled = true;
                videoCallBtn.disabled = true;
                
                // Set payment URL
                document.getElementById('goToPaymentBtn').onclick = () => {
                    window.open(data.payment_url || `/payment/appointment/${appointmentId}`, '_blank');
                };
                
                // Check payment status button
                document.getElementById('checkPaymentStatusBtn').onclick = () => {
                    checkPaymentStatus(appointmentId);
                };
                
                // Back to dashboard button
                document.getElementById('backToDashboardBtn').onclick = backToDashboard;
            } else {
                paymentOverlay.style.display = 'none';
                messageInput.disabled = false;
                sendMessageBtn.disabled = false;
                attachBtn.disabled = false;
                voiceRecordBtn.disabled = false;
                voiceCallBtn.disabled = false;
                videoCallBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
}

// Load messages with WhatsApp-style formatting
function loadMessages(appointmentId) {
    const messagesArea = document.getElementById('chatMessages');
    messagesArea.innerHTML = '<div class="loading-messages"><div class="loading-spinner"></div></div>';
    
    fetch(`/api/appointment/${appointmentId}/messages`)
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error('HTTP ' + response.status + ': ' + text); });
            }
            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                return response.text().then(text => { throw new Error('Unexpected response (not JSON): ' + text); });
            }
            return response.json();
        })
        .then(data => {
            messagesArea.innerHTML = '';
            
            if (!data.messages || data.messages.length === 0) {
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-comment-dots"></i></div>
                        <div class="empty-state-text">No messages yet</div>
                        <div class="empty-state-subtext">Send a message to start the conversation</div>
                    </div>
                `;
                return;
            }
            
            let currentDate = null;
            
            data.messages.forEach(message => {
                const messageDate = new Date(message.timestamp);
                const messageDay = messageDate.toDateString();
                
                // Add date separator if new day
                if (currentDate !== messageDay) {
                    currentDate = messageDay;
                    const dateSeparator = document.createElement('div');
                    dateSeparator.className = 'date-separator';
                    dateSeparator.innerHTML = `<span class="date-label">${formatDate(messageDate)}</span>`;
                    messagesArea.appendChild(dateSeparator);
                }
                
                // Create message element
                const messageElement = createMessageElement(message);
                messagesArea.appendChild(messageElement);
            });
            
            // Scroll to bottom
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Mark messages as read
            markMessagesAsRead(appointmentId);
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            messagesArea.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="empty-state-text">Error loading messages</div>
                    <div class="empty-state-subtext">${escapeHtml(error.message || 'Unable to load messages')}</div>
                </div>
            `;
        });
}

// Create message element with WhatsApp styling
function createMessageElement(message) {
    const isSent = message.sender_id === currentUserId;
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    
    const container = document.createElement('div');
    container.className = 'message-container';
    
    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
    
    // Message content based on type
    if (message.message_type === 'text') {
        bubble.innerHTML = `<div class="message-text">${escapeHtml(message.content || '')}</div>`;
    } else if (message.message_type === 'voice_note') {
        bubble.innerHTML = createVoiceMessageHTML(message);
    } else if (message.message_type === 'document' || message.message_type === 'image') {
        bubble.innerHTML = createFileMessageHTML(message);
    } else if (message.message_type === 'prescription') {
        bubble.innerHTML = createPrescriptionMessageHTML(message);
    } else {
        bubble.innerHTML = `<div class="message-text">${escapeHtml(message.content || '')}</div>`;
    }
    
    // Message time and status
    const timeElement = document.createElement('div');
    timeElement.className = 'message-time';
    timeElement.setAttribute('data-timestamp', message.timestamp);
    timeElement.setAttribute('data-timestamp-format', 'timeonly');
    
    // Use LocalTime utility for formatting
    const timeString = window.LocalTime ? window.LocalTime.formatToLocalTime(message.timestamp, 'timeonly') : new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    let statusHTML = '';
    if (isSent) {
        statusHTML = getMessageStatusHTML(message.message_status || 'sent');
    }
    
    timeElement.innerHTML = `${timeString} ${statusHTML}`;
    
    container.appendChild(bubble);
    container.appendChild(timeElement);
    wrapper.appendChild(container);
    
    return wrapper;
}

function createVoiceMessageHTML(message) {
    const duration = message.duration || '0:00';
    return `
        <div class="voice-message">
            <i class="fas fa-play-circle play-voice" data-url="${message.file_url || ''}"></i>
            <div class="voice-waveform"></div>
            <span class="voice-duration">${duration}</span>
        </div>
    `;
}

function createFileMessageHTML(message) {
    const fileName = message.file_name || 'File';
    const fileSize = message.file_size ? formatFileSize(message.file_size) : '';
    const isImage = message.message_type === 'image';
    
    if (isImage) {
        return `
            <div class="message-file">
                <img src="${message.file_url || ''}" alt="${fileName}" style="max-width: 200px; border-radius: 5px;" onerror="this.style.display='none'">
                <div>
                    <div><strong>${escapeHtml(fileName)}</strong></div>
                    ${fileSize ? `<div><small>${fileSize}</small></div>` : ''}
                </div>
            </div>
        `;
    } else {
        return `
            <div class="message-file">
                <i class="fas fa-file"></i>
                <div>
                    <div><a href="${message.file_url || '#'}" target="_blank">${escapeHtml(fileName)}</a></div>
                    ${fileSize ? `<div><small>${fileSize}</small></div>` : ''}
                </div>
            </div>
        `;
    }
}

function createPrescriptionMessageHTML(message) {
    return `
        <div class="message-prescription">
            <div class="prescription-header">
                <i class="fas fa-prescription-bottle-alt"></i>
                <strong>New Prescription</strong>
            </div>
            <div class="prescription-content">
                ${message.content || 'Prescription details'}
            </div>
            <div class="prescription-actions">
                <button class="btn btn-sm btn-outline-primary view-prescription-btn" data-id="${message.prescription_id || ''}">
                    <i class="fas fa-eye me-1"></i>View Details
                </button>
                <button class="btn btn-sm btn-outline-success print-prescription-btn" data-id="${message.prescription_id || ''}">
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
        </div>
    `;
}

function getMessageStatusHTML(status) {
    switch(status) {
        case 'sent':
            return '<span class="tick single">âœ“</span>';
        case 'delivered':
            return '<span class="tick double grey">âœ“âœ“</span>';
        case 'read':
            return '<span class="tick double blue">âœ“âœ“</span>';
        default:
            return '<span class="tick single">âœ“</span>';
    }
}

// Format file size
function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) {
        return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
    } else {
        return date.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
    }
}


// Show no appointment message
function showNoAppointmentMessage() {
    const messagesArea = document.getElementById('chatMessages');
    messagesArea.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-calendar-plus"></i></div>
            <div class="empty-state-text">No active consultation</div>
            <div class="empty-state-subtext">Book an appointment with this doctor</div>
            <button class="btn btn-primary mt-3" id="bookAppointmentBtn">
                <i class="fas fa-calendar me-2"></i>Book Appointment
            </button>
        </div>
    `;
    
    document.getElementById('bookAppointmentBtn').addEventListener('click', bookAppointment);
}

// Book appointment
function bookAppointment() {
    if (!selectedDoctorId) return;
    
    window.location.href = `/patient/appointment?doctor_id=${selectedDoctorId}`;
}

// Setup event listeners with patient-specific features
function setupEventListeners() {
    // Send message (same as doctor)
    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Typing indicator (same as doctor)
    document.getElementById('messageInput').addEventListener('input', function(e) {
        if (!selectedAppointmentId) return;
        
        // Send typing indicator
        if (!isTyping) {
            isTyping = true;
            socket.emit('typing', {
                appointment_id: selectedAppointmentId
            });
        }
        
        // Clear existing timeout
        clearTimeout(typingTimeout);
        
        // Set timeout to stop typing indicator
        typingTimeout = setTimeout(() => {
            isTyping = false;
            socket.emit('stop_typing', {
                appointment_id: selectedAppointmentId
            });
        }, 1000);
    });

    // Topbar actions
    const statusBtn = document.getElementById('statusBtn');
    const statusIcon = document.getElementById('statusIcon');
    const bookBtn = document.getElementById('bookBtn');
    const menuBtn = document.getElementById('menuBtn');
    const userMenu = document.getElementById('userMenuDropdown');

    // Toggle availability (simple UX: toggle persistent show_availability)
    statusBtn.addEventListener('click', async function(){
        try{
            // Flip current state locally
            const currentlyOnline = statusIcon.classList.contains('fa-circle') && !statusIcon.classList.contains('text-muted');
            const newState = !currentlyOnline;
            // optimistic UI
            if (newState) { statusIcon.classList.remove('text-muted'); statusIcon.style.color = '#31a24c'; }
            else { statusIcon.classList.add('text-muted'); statusIcon.style.color = '#a0a0a0'; }

            const res = await fetch(`/api/user/${currentUserId}/set-availability`, { method: 'POST', headers: {'Content-Type':'application/json','X-CSRFToken': csrfToken}, body: JSON.stringify({available: newState})});
            const j = await res.json(); if (!j.success) {
                alert('Could not update availability');
            }
        }catch(e){ console.error(e); alert('Failed to update availability'); }
    });

    // Book appointment - go to booking page
    bookBtn.addEventListener('click', function(){
        window.location.href = '/patient/appointment';
    });

    // Menu button
    menuBtn.addEventListener('click', function(e){
        const rect = menuBtn.getBoundingClientRect();
        userMenu.style.left = (rect.right - 160) + 'px';
        userMenu.style.top = (rect.bottom + 8) + 'px';
        userMenu.style.display = userMenu.style.display === 'none' ? 'block' : 'none';
    });

    // Close menu on outside click
    document.addEventListener('click', function(ev){
        if (!menuBtn.contains(ev.target) && !userMenu.contains(ev.target)) userMenu.style.display = 'none';
    });
    
    // Voice recording (same as doctor)
    document.getElementById('voiceRecordBtn').addEventListener('click', toggleRecording);
    document.getElementById('cancelRecordingBtn').addEventListener('click', cancelRecording);
    document.getElementById('sendRecordingBtn').addEventListener('click', sendRecording);
    
    // File attachment (same as doctor)
    document.getElementById('attachBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
    
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    
    // Patient-specific buttons
    document.getElementById('voiceCallBtn').addEventListener('click', initiateVoiceCall);
    document.getElementById('videoCallBtn').addEventListener('click', initiateVideoCall);
    document.getElementById('infoBtn').addEventListener('click', showDoctorInfo);
    
    // Outgoing call rejection handlers
    document.getElementById('rejectOutgoingVideoCallBtn').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('outgoingVideoCallModal'));
        if (modal) modal.hide();
        if (typeof socket !== 'undefined') {
            socket.emit('end_video_call', {
                appointment_id: selectedAppointmentId
            });
        }
    });
    
    document.getElementById('rejectOutgoingVoiceCallBtn').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('outgoingVoiceCallModal'));
        if (modal) modal.hide();
        if (typeof socket !== 'undefined') {
            socket.emit('end_voice_call', {
                appointment_id: selectedAppointmentId
            });
        }
    });
    
    // Back to list (mobile) - same as doctor
    document.getElementById('backToList').addEventListener('click', () => {
        document.getElementById('appointmentsSidebar').style.display = 'flex';
        document.getElementById('chatArea').style.display = 'none';
        document.getElementById('backToList').style.display = 'none';
    });
    
    // Search (same as doctor)
    document.getElementById('searchDoctors').addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.appointment-item').forEach(item => {
            const name = item.querySelector('.appointment-name').textContent.toLowerCase();
            item.style.display = name.includes(query) ? 'flex' : 'none';
        });
    });
    
    // Play voice messages (same as doctor)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('play-voice')) {
            const audioUrl = e.target.dataset.url;
            if (audioUrl) {
                const player = document.getElementById('voicePlayer');
                player.src = audioUrl;
                player.play();
            }
        }
        
        // Prescription buttons (for viewing prescriptions sent by doctors)
        if (e.target.closest('.view-prescription-btn')) {
            const prescriptionId = e.target.closest('.view-prescription-btn').dataset.id;
            viewPrescription(prescriptionId);
        }
        
        if (e.target.closest('.print-prescription-btn')) {
            const prescriptionId = e.target.closest('.print-prescription-btn').dataset.id;
            printPrescription(prescriptionId);
        }
    });
}

// Show doctor info with profile and reviews
async function showDoctorInfo() {
    if (!selectedDoctorId) {
        alert('Please select a doctor first');
        return;
    }
    
    try {
        const response = await fetch(`/api/doctors/${selectedDoctorId}/profile-with-reviews`);
        if (!response.ok) throw new Error('Failed to load doctor profile');
        
        const data = await response.json();
        showDoctorProfileModalCommunication(data.doctor);
    } catch (error) {
        console.error('Error loading doctor profile:', error);
        alert('Unable to load doctor profile. Please try again.');
    }
}

// Show doctor profile modal in communication page
function showDoctorProfileModalCommunication(doctor) {
    const modalHtml = `
    <div id="doctorProfileCommunicationModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Doctor Profile & Reviews</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Doctor Info -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Doctor Information</h6>
                        <div class="card p-3">
                            <h5 class="mb-2">${doctor.name}</h5>
                            <p class="mb-2"><strong>${doctor.specialization}</strong></p>
                            <p class="text-muted mb-2"><i class="fas fa-briefcase me-2"></i>${doctor.experience_years || 0} years experience</p>
                            <div class="mb-3">
                                <span class="badge bg-warning text-dark me-2">${doctor.average_rating}â˜…</span>
                                <span class="text-muted small">(${doctor.testimonials_count} review${doctor.testimonials_count !== 1 ? 's' : ''})</span>
                            </div>
                            ${doctor.bio ? `<p class="text-muted small mb-2">${escapeHtml(doctor.bio)}</p>` : ''}
                            ${doctor.qualifications ? `
                                <div class="mt-2">
                                    <strong class="small">Qualifications:</strong>
                                    <p class="text-muted small mb-0">${escapeHtml(doctor.qualifications)}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Reviews Section -->
                    ${doctor.testimonials && doctor.testimonials.length > 0 ? `
                        <div>
                            <h6 class="text-muted mb-3">Patient Reviews (${doctor.testimonials.length})</h6>
                            <div class="space-y-3">
                                ${doctor.testimonials.map(review => `
                                    <div class="card p-3 border-start border-warning border-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong class="small">${escapeHtml(review.patient_name)}</strong>
                                                <br>
                                                <small class="text-muted">${new Date(review.created_at).toLocaleDateString()}</small>
                                            </div>
                                            <span class="badge bg-warning text-dark">${review.rating}â˜…</span>
                                        </div>
                                        <p class="small mb-0 text-dark">${escapeHtml(review.content)}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No reviews yet. Be the first to review this doctor!
                        </div>
                    `}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    `;
    
    // Remove existing modal if any
    const existing = document.getElementById('doctorProfileCommunicationModal');
    if (existing) existing.remove();
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('doctorProfileCommunicationModal'));
    modal.show();
}

// View prescription (patient)
function viewPrescription(prescriptionId) {
    window.open(`/prescription/${prescriptionId}`, '_blank');
}

// Print prescription (patient)
function printPrescription(prescriptionId) {
    window.open(`/prescription/${prescriptionId}/print`, '_blank');
}

// Setup emoji picker
function setupEmojiPicker() {
    const picker = document.createElement('emoji-picker');
    picker.style.position = 'absolute';
    picker.style.bottom = '70px';
    picker.style.right = '20px';
    picker.style.zIndex = '1000';
    picker.style.display = 'none';
    document.getElementById('chatArea').appendChild(picker);
    
    document.getElementById('emojiBtn').addEventListener('click', function() {
        picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
    });
    
    document.getElementById('emojiPickerBtn').addEventListener('click', function() {
        picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
    });
    
    picker.addEventListener('emoji-click', event => {
        const input = document.getElementById('messageInput');
        input.value += event.detail.unicode;
        input.focus();
        picker.style.display = 'none';
    });
    
    // Close picker when clicking outside
    document.addEventListener('click', function(e) {
        if (!picker.contains(e.target) && 
            e.target.id !== 'emojiBtn' && 
            e.target.id !== 'emojiPickerBtn' &&
            !e.target.closest('#emojiBtn') &&
            !e.target.closest('#emojiPickerBtn')) {
            picker.style.display = 'none';
        }
    });
}

// Send message
// Send message (same as doctor version)
function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content || !selectedAppointmentId) return;
    
    // Clear typing indicator
    clearTimeout(typingTimeout);
    isTyping = false;
    socket.emit('stop_typing', { appointment_id: selectedAppointmentId });
    
    // Send via Socket.IO
    socket.emit('send_message', {
        appointment_id: selectedAppointmentId,
        content: content,
        message_type: 'text'
    });
    
    // Clear input
    input.value = '';
    
    // Add message to UI immediately (optimistic update)
    const messageData = {
        id: Date.now(), // Temporary ID
        sender_id: currentUserId,
        content: content,
        message_type: 'text',
        timestamp: new Date().toISOString(),
        message_status: 'sent'
    };
    
    addMessageToUI(messageData);
}

// Toggle voice recording
function toggleRecording() {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecording();
    }
}

// Start voice recording
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();
        
        // Update UI
        document.getElementById('voiceRecordBtn').classList.add('recording');
        document.getElementById('chatInputArea').style.display = 'none';
        document.getElementById('recordingUI').style.display = 'flex';
        
        // Start timer
        updateRecordingTimer();
        recordingTimer = setInterval(updateRecordingTimer, 1000);
        
    } catch (error) {
        console.error('Error starting recording:', error);
        alert('Unable to access microphone. Please check permissions.');
    }
}

// Stop recording
function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        clearInterval(recordingTimer);
        
        // Update UI
        document.getElementById('voiceRecordBtn').classList.remove('recording');
    }
}

// Cancel recording
function cancelRecording() {
    stopRecording();
    
    // Reset UI
    document.getElementById('chatInputArea').style.display = 'flex';
    document.getElementById('recordingUI').style.display = 'none';
    document.getElementById('recordingTimer').textContent = '00:00';
}

// Send recording
function sendRecording() {
    if (recordedChunks.length === 0 || !selectedAppointmentId) {
        cancelRecording();
        return;
    }
    
    const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
    const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
    
    // Create form data
    const formData = new FormData();
    formData.append('appointment_id', selectedAppointmentId);
    formData.append('audio', audioBlob, 'voice-note.webm');
    formData.append('duration', duration);
    
    // Send to server
    fetch('/api/send-voice-note', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add voice message to UI
            const messageData = {
                id: data.message_id,
                sender_id: currentUserId,
                content: 'Voice message',
                message_type: 'voice_note',
                timestamp: new Date().toISOString(),
                message_status: 'sent',
                duration: formatDuration(duration),
                file_url: data.file_url
            };
            
            addMessageToUI(messageData);
        }
    })
    .catch(error => {
        console.error('Error sending voice note:', error);
        alert('Error sending voice note');
    })
    .finally(() => {
        cancelRecording();
    });
}

// Update recording timer
function updateRecordingTimer() {
    if (!recordingStartTime) return;
    
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    document.getElementById('recordingTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Format duration
function formatDuration(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}
// Handle file upload
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file || !selectedAppointmentId) return;
    
    const formData = new FormData();
    formData.append('appointment_id', selectedAppointmentId);
    formData.append('file', file);
    
    // Determine file type
    const fileType = file.type.startsWith('image/') ? 'image' : 'document';
    
    fetch('/api/upload-file', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Send message about file
            if (typeof socket !== 'undefined') {
                socket.emit('send_message', {
                    appointment_id: selectedAppointmentId,
                    content: file.name,
                    message_type: fileType,
                    file_url: data.file_url,
                    file_size: file.size
                });
            }
            
            // Add to UI
            const messageData = {
                id: Date.now(),
                sender_id: currentUserId,
                content: file.name,
                message_type: fileType,
                timestamp: new Date().toISOString(),
                message_status: 'sent',
                file_url: data.file_url,
                file_size: file.size,
                file_name: file.name
            };
            
            addMessageToUI(messageData);
        }
    })
    .catch(error => {
        console.error('Error uploading file:', error);
        alert('Error uploading file');
    });
    
    // Clear file input
    event.target.value = '';
}

// Initiate voice call
function initiateVoiceCall() {
    if (!selectedAppointmentId) {
        alert('Please select an appointment first');
        return;
    }
    
    if (typeof socket === 'undefined' || !socket.connected) {
        console.warn('Socket.IO not connected - cannot initiate voice call', { appointment_id: selectedAppointmentId });
        alert('Real-time connection not ready. Try again in a moment.');
        return;
    }
    console.log('Initiating voice call (patient)', { appointment_id: selectedAppointmentId });
    socket.emit('initiate_voice_call', {
        appointment_id: selectedAppointmentId
    });
}

// Initiate video call
function initiateVideoCall() {
    if (!selectedAppointmentId) {
        alert('Please select an appointment first');
        return;
    }
    if (typeof socket === 'undefined' || !socket.connected) {
        alert('Real-time connection not ready. Try again in a moment.');
        return;
    }

    const calleeId = selectedDoctorData?.user_id || selectedDoctorData?.id;
    // Open outgoing call window for caller UX
    try {
        const params = new URLSearchParams();
        params.set('appointment_id', selectedAppointmentId);
        params.set('doctor_user_id', calleeId);
        params.set('callee_name', selectedDoctorData?.first_name ? `${selectedDoctorData.first_name} ${selectedDoctorData.last_name || ''}`.trim() : '');
        params.set('caller_profile_pic', window.currentUserProfilePic || '');
        const popup = window.open(`/outgoing-call/${encodeURIComponent(selectedAppointmentId)}?${params.toString()}`, '_blank', 'width=420,height=640');
        console.info('Outgoing popup opened (patient):', !!popup, popup);
    } catch (e) {
        console.warn('Could not open outgoing window', e);
    }

    socket.emit('initiate_video_call', {
        caller_id: currentUserId,
        callee_id: calleeId,
        appointment_id: selectedAppointmentId
    });
}

// Add message to UI
function addMessageToUI(messageData) {
    const messagesArea = document.getElementById('chatMessages');
    
    // Remove empty state if present
    const emptyState = messagesArea.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const messageElement = createMessageElement(messageData);
    messagesArea.appendChild(messageElement);
    
    // Scroll to bottom
    messagesArea.scrollTop = messagesArea.scrollHeight;
    
    // Update last message in sidebar
    updateSidebarPreview(messageData);
}

// Update sidebar preview
function updateSidebarPreview(messageData) {
    if (!selectedDoctorId) return;
    
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === selectedDoctorId.toString()) {
            const preview = item.querySelector('.appointment-preview');
            if (preview) {
                let previewText = '';
                if (messageData.message_type === 'text') {
                    previewText = messageData.content || '';
                } else if (messageData.message_type === 'voice_note') {
                    previewText = 'ðŸŽ¤ Voice message';
                } else if (messageData.message_type === 'image') {
                    previewText = 'ðŸ“· Photo';
                } else if (messageData.message_type === 'document') {
                    previewText = 'ðŸ“„ ' + (messageData.file_name || 'Document');
                } else if (messageData.message_type === 'prescription') {
                    previewText = 'ðŸ’Š Prescription';
                }
                preview.textContent = previewText.length > 30 ? previewText.substring(0, 30) + '...' : previewText;
                
                // Update time
                const timeElement = item.querySelector('.appointment-time');
                if (timeElement) {
                    const now = new Date();
                    timeElement.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }
        }
    });
}

// Setup Socket.IO with patient-specific handlers
window.socket = window.socket || null; // Initialize as null, will be set up in setupSocketIO
// Ensure `socket` binding exists for handlers
if (!window.socket) { try { window.socket = (typeof io !== 'undefined' ? io() : null); } catch(e) { console.error('Socket init failed', e); window.socket = null; } }
var socket = window.socket;

function setupSocketIO() {
    // Make sure socket.io library is loaded
    if (typeof io === 'undefined') {
        console.error('Socket.IO library not loaded');
        setTimeout(setupSocketIO, 1000);
        return;
    }
    
    // Prevent double initialization
    if (window.socket && window.socket.connected) {
        console.log('Socket.IO already connected');
        return;
    }
    
    // Connect with options - connect ONLY here with proper configuration
    window.socket = io({
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionAttempts: 10,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        autoConnect: true
    });
    
    socket.on('connect', function() {
        console.log('Connected to Socket.IO server');
        
        // Join any existing appointment room
        if (selectedAppointmentId) {
            socket.emit('join_appointment', { appointment_id: selectedAppointmentId });
        }
        
        // Register this socket with server and set user as online
        socket.emit('register_user', { user_id: currentUserId });
        socket.emit('user_online_status', { is_online: true });
    });
    
    // Handle incoming messages (same as doctor version)
    socket.on('message_received', function(data) {
        if (data.appointment_id === selectedAppointmentId) {
            addMessageToUI(data);
            
            // Mark as delivered
            if (data.sender_id !== currentUserId) {
                socket.emit('message_delivered', {
                    message_id: data.id,
                    appointment_id: data.appointment_id
                });
            }
        } else {
            // Update unread count for other appointments
            updateUnreadCount(data.appointment_id);
        }
    });
    
    // Handle message status updates (same as doctor version)
    socket.on('message_status_updated', function(data) {
        updateMessageStatus(data.message_id, data.status);
    });
    
    // Handle typing indicators (same as doctor version)
    socket.on('user_typing', function(data) {
        if (data.appointment_id === selectedAppointmentId && data.user_id !== currentUserId) {
            showTypingIndicator(data.user_name);
        }
    });
    
    socket.on('user_stop_typing', function(data) {
        if (data.appointment_id === selectedAppointmentId) {
            hideTypingIndicator();
        }
    });
    
    // Handle online/offline status (patient-specific)
    socket.on('doctor_online', function(data) {
        updateDoctorOnlineStatus(data.doctor_id, true);
    });
    
    socket.on('doctor_offline', function(data) {
        updateDoctorOnlineStatus(data.doctor_id, false);
    });
    
    // Handle calls - specific listeners will be set up below
    
    // When a call is accepted, hide any outgoing modals and navigate to the call page
    socket.on('video_call_accepted', function(data) {
        try {
            const modalEl = document.getElementById('outgoingVideoCallModal');
            const modalInst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInst.hide();
        } catch (e) {}
        if (data && data.appointment_id) {
            window.location.href = `/video-call/${data.appointment_id}`;
        }
    });

    socket.on('voice_call_accepted', function(data) {
        try {
            const modalEl = document.getElementById('outgoingVoiceCallModal');
            const modalInst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInst.hide();
        } catch (e) {}
        if (data && data.appointment_id) {
            window.location.href = `/voice-call/${data.appointment_id}`;
        }
    });
    
    // Listen for payment status updates
    socket.on('payment_status_updated', function(data) {
        if (data.appointment_id === selectedAppointmentId) {
            paymentStatus = data.status;
            checkPaymentStatus(selectedAppointmentId);
            
            // Update payment badge in sidebar
            updatePaymentBadge(data.status);
        }
    });
    
    // Handle connection errors
    socket.on('connect_error', function(error) {
        console.error('Socket.IO connection error:', error);
    });
    
    // Handle disconnection
    socket.on('disconnect', function() {
        console.log('Patient disconnected from Socket.IO server');
        // Set patient as offline
        socket.emit('user_online_status', { is_online: false });
    });

    // ===== CALL LIFECYCLE LISTENERS (attached to properly initialized socket) =====
    
    socket.on('outgoing_video_call_started', function(data) {
        console.log('Outgoing video call started:', data);
        const info = {
            id: data.id,
            caller: data.caller,
            callee: data.callee,
            appointment_id: data.appointment_id,
            callee_name: data.callee_name || data.calleeName || 'Recipient',
            callee_profile_picture: data.callee_profile_picture || data.callee_profile_picture_url
        };
        showOutgoingVideoOverlay(info);
    });

    socket.on('call_accepted', function(data) {
        console.log('Call accepted:', data);
        // both sides should navigate to call page or show connected state
        closeVideoOverlays();
        if (data && data.appointment_id) {
            // show connected briefly then go to call
            const connectedStub = document.createElement('div');
            connectedStub.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2200;';
            connectedStub.innerHTML = `<div style="background:#fff;border-radius:12px;padding:20px;min-width:240px;text-align:center;"><h5>Connected</h5><p id=networkStrength style=color:#666;>Network: Good</p></div>`;
            document.body.appendChild(connectedStub);
            setTimeout(()=>{ 
                connectedStub.remove(); 
                window.location.href = `/video-call/${data.appointment_id}`; 
            }, 900);
        }
    });

    socket.on('call_rejected', function(data) {
        console.log('Call rejected:', data);
        closeVideoOverlays();
        // notify caller if they were waiting
        if (data && data.reason === 'no_answer') {
            showNoAnswerOverlay(data);
        }
    });

    socket.on('call_ended', function(data) {
        console.log('Call ended:', data);
        closeVideoOverlays();
        // if doctor ended and appointment needs marking complete, show testimonial prompt on patient side
        if (data && data.ended_by && data.ended_by !== currentUserId) {
            // if appointment exists, redirect to dashboard and later testimonial flow will be triggered by server or next page
            setTimeout(()=>{ window.location.href = '/patient/dashboard'; }, 600);
        }
    });

    socket.on('prompt_testimonial', function(data) {
        console.log('Testimonial prompt:', data);
        // data: { appointment_id, doctor_id }
        if (!data || !data.appointment_id) return;
        showTestimonialPrompt(data.appointment_id, data.doctor_id);
    });

    // ===== VOICE CALL LIFECYCLE LISTENERS =====
    
    socket.on('call_ringing', function(data) {
        console.log('Call ringing (outgoing voice):', data);
        // Caller sees ringing status for voice call
        if (data.call_type === 'voice') {
            // Show outgoing voice overlay
            const info = {
                appointment_id: data.appointment_id,
                call_type: 'voice'
            };
            showOutgoingVoiceOverlay(info);
        }
    });

    socket.on('incoming_video_call', function(data) {
        console.log('Incoming video call:', data);
        // Callee receives incoming video call
        const info = {
            appointment_id: data.appointment_id,
            caller_id: data.caller_id,
            caller_name: data.caller_name || 'Doctor',
            caller_role: data.caller_role || 'doctor',
            caller_profile_pic: data.caller_profile_pic,
            call_type: 'video'
        };
        showIncomingVideoOverlay(info);
    });

    socket.on('incoming_voice_call', function(data) {
        console.log('Incoming voice call:', data);
        // Callee receives incoming voice call
        const info = {
            appointment_id: data.appointment_id,
            caller_id: data.caller_id,
            caller_name: data.caller_name || 'Caller',
            caller_role: data.caller_role || 'User',
            caller_profile_pic: data.caller_profile_pic,
            call_type: 'voice'
        };
        showIncomingVoiceOverlay(info);
    });

    socket.on('voice_call_accepted', function(data) {
        console.log('Voice call accepted:', data);
        // Both sides navigate to voice call page
        closeVoiceOverlays();
        if (data && data.appointment_id) {
            const connectedStub = document.createElement('div');
            connectedStub.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2200;';
            connectedStub.innerHTML = `<div style="background:#fff;border-radius:12px;padding:20px;min-width:240px;text-align:center;"><h5>Connected</h5><p style="color:#666;">Voice call connected</p></div>`;
            document.body.appendChild(connectedStub);
            setTimeout(()=>{ 
                connectedStub.remove(); 
                window.location.href = `/voice-call/${data.appointment_id}`; 
            }, 900);
        }
    });

    socket.on('call_ended', function(data) {
        console.log('Call ended:', data);
        closeVoiceOverlays();
        if (data && data.appointment_id) {
            // Redirect to communication page
            setTimeout(()=>{ window.location.href = `/communication/${data.appointment_id}`; }, 600);
        }
    });

    socket.on('missed_call', function(data) {
        console.log('Missed call notification:', data);
        // Optional: show missed call notification
    });
}

// Mark messages as read
function markMessagesAsRead(appointmentId) {
    socket.emit('message_read', {
        appointment_id: appointmentId
    });
    
    // Update unread count in sidebar
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === selectedDoctorId?.toString()) {
            const badge = item.querySelector('.unread-badge');
            if (badge) {
                badge.remove();
            }
        }
    });
}

// Show typing indicator
function showTypingIndicator(userName) {
    const indicator = document.getElementById('typingIndicator');
    const typingUser = document.getElementById('typingUser');
    
    typingUser.textContent = `${userName} is typing...`;
    indicator.style.display = 'flex';
    
    // Auto-hide after 3 seconds
    setTimeout(hideTypingIndicator, 3000);
}

// Hide typing indicator
function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    indicator.style.display = 'none';
}

// Update message status
function updateMessageStatus(messageId, status) {
    const messages = document.querySelectorAll('.message-wrapper');
    messages.forEach(wrapper => {
        const timeElement = wrapper.querySelector('.message-time');
        if (timeElement && timeElement.textContent.includes(messageId)) {
            // Update status in time element
            const statusHTML = getMessageStatusHTML(status);
            timeElement.innerHTML = timeElement.innerHTML.replace(
                /<span class="tick[^>]*>[^<]*<\/span>/,
                statusHTML
            );
        }
    });
}

// Update unread count
function updateUnreadCount(appointmentId) {
    // Since we group by doctor, we need to handle this differently
    // This is a simplified implementation
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === selectedDoctorId?.toString()) {
            let badge = item.querySelector('.unread-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'unread-badge';
                badge.textContent = '1';
                item.appendChild(badge);
            } else {
                const count = parseInt(badge.textContent) + 1;
                badge.textContent = count;
            }
        }
    });
}

// Handle incoming call (show in-page overlay instead of opening a new window)
function handleIncomingCall(data, callType) {
    // Normalize info used by the overlay functions
    const info = {
        id: data.id || data.call_id || data.callId,
        caller: data.caller || data.caller_id || data.from,
        callee: data.callee || data.callee_id || data.to,
        appointment_id: data.appointment_id || data.appointmentId,
        caller_name: data.caller_name || data.callerName || 'Doctor',
        caller_role: data.caller_role || data.callerRole || 'Doctor',
        caller_profile_picture: data.caller_profile_picture || data.caller_profile_picture_url || null
    };

    // Use the in-page overlay (the overlay handles ringtone, timeout, accept/reject)
    if (callType === 'video') {
        try { showIncomingVideoOverlay(info); } catch (e) { console.error('Incoming overlay failed', e); }
    } else {
        // For voice calls we reuse the same overlay for now
        try { showIncomingVideoOverlay(info); } catch (e) { console.error('Incoming overlay failed', e); }
    }

    // No new window is opened. The overlay itself will emit accept/reject events to the server.
}

function setupIncomingCallHandlers(data, callType) {
    // Listen for accept/reject from incoming call window
    const checkCallResponse = setInterval(() => {
        const callResponse = safeStorage.getItem('callResponse');
        
        if (callResponse) {
            clearInterval(checkCallResponse);
            
            if (callResponse === 'accepted') {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit(`accept_${callType}_call`, {
                        appointment_id: data.appointment_id
                    });
                }
                
                // Redirect based on call type
                setTimeout(() => {
                    if (callType === 'video') {
                        window.location.href = `/video-call/${data.appointment_id}`;
                    } else if (callType === 'voice') {
                        window.location.href = `/communication/${data.appointment_id}`;
                    }
                }, 500);
            } else if (callResponse === 'rejected') {
                if (typeof socket !== 'undefined' && socket.connected) {
                    socket.emit(`reject_${callType}_call`, {
                        appointment_id: data.appointment_id
                    });
                }
            }
            
            safeStorage.removeItem('callResponse');
        }
    }, 100);
    
    // Timeout after 70 seconds (longer than call timeout)
    setTimeout(() => {
        clearInterval(checkCallResponse);
    }, 70000);
}

// Update doctor online status
function updateDoctorOnlineStatus(doctorId, isOnline) {
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === doctorId.toString()) {
            const indicator = item.querySelector('.online-indicator');
            if (indicator) {
                indicator.className = isOnline ? 'online-indicator' : 'online-indicator offline';
            }
        }
    });
    
    // Update chat header if this is the current doctor
    if (selectedDoctorId === doctorId) {
        const statusElement = document.getElementById('chatHeaderStatus');
        if (statusElement) {
            const currentText = statusElement.textContent;
            const newText = currentText.replace(/Online|Offline/, isOnline ? 'Online' : 'Offline');
            statusElement.textContent = newText;
        }
    }
}

// Update payment badge
function updatePaymentBadge(status) {
    document.querySelectorAll('.appointment-item').forEach(item => {
        if (item.dataset.doctorId === selectedDoctorId?.toString()) {
            const paymentBadge = item.querySelector('.payment-badge');
            if (paymentBadge) {
                if (status === 'paid') {
                    paymentBadge.className = 'payment-badge ms-2 paid';
                    paymentBadge.textContent = 'âœ“ Paid';
                } else {
                    paymentBadge.className = 'payment-badge ms-2 pending';
                    paymentBadge.textContent = 'Payment Pending';
                }
            }
        }
    });
}

// Helper functions
function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// -------------------------
// In-page Voice Call UI
// -------------------------

function showOutgoingVoiceOverlay(callInfo) {
    closeVoiceOverlays();
    const overlay = document.createElement('div');
    overlay.id = 'outgoingVoiceOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2000;';
    overlay.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:28px;min-width:320px;max-width:420px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">ðŸ“ž</div>
            <div id="voiceCalleeInfo" style="font-weight:700;margin-bottom:6px;">Calling...</div>
            <div style="color:#666;margin-bottom:14px;">Voice call</div>
            <div id="voiceOutgoingStatus" style="margin-bottom:16px;color:#999;">Ringing...</div>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="endOutgoingVoiceBtn" class="btn btn-danger">End call</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    document.getElementById('endOutgoingVoiceBtn').addEventListener('click', () => {
        stopRingtone();
        if (socket && socket.connected) socket.emit('end_voice_call', { appointment_id: callInfo.appointment_id });
        closeVoiceOverlays();
    });

    playRingtone(true, 480);
    
    // Voice call timeout 60 seconds
    overlay._ringTimeout = setTimeout(() => {
        stopRingtone();
        closeVoiceOverlays();
        showNoAnswerVoiceOverlay(callInfo);
    }, 60000);
}

function showIncomingVoiceOverlay(callInfo) {
    closeVoiceOverlays();
    const overlay = document.createElement('div');
    overlay.id = 'incomingVoiceOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2000;';
    overlay.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:26px;min-width:320px;max-width:420px;text-align:center;">
            <div style="font-size:48px;margin-bottom:16px;">ðŸ“ž</div>
            <div id="voiceCallerName" style="font-weight:700;margin-bottom:6px;">${escapeHtml(callInfo.caller_name || 'Caller')}</div>
            <div style="color:#666;margin-bottom:14px;">Incoming voice call</div>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="acceptIncomingVoiceBtn" class="btn btn-success">Accept</button>
                <button id="hangupIncomingVoiceBtn" class="btn btn-danger">Hang up</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    playRingtone(true, 380);

    document.getElementById('acceptIncomingVoiceBtn').addEventListener('click', () => {
        stopRingtone();
        if (socket && socket.connected) socket.emit('accept_voice_call', { appointment_id: callInfo.appointment_id });
        closeVoiceOverlays();
    });

    document.getElementById('hangupIncomingVoiceBtn').addEventListener('click', () => {
        stopRingtone();
        if (socket && socket.connected) socket.emit('end_voice_call', { appointment_id: callInfo.appointment_id });
        closeVoiceOverlays();
    });

    // voice timeout - after 60s treat as missed
    overlay._ringTimeout = setTimeout(() => {
        stopRingtone();
        if (socket && socket.connected) socket.emit('end_voice_call', { appointment_id: callInfo.appointment_id });
        closeVoiceOverlays();
    }, 60000);
}

function showNoAnswerVoiceOverlay(callInfo) {
    closeVoiceOverlays();
    const modal = document.createElement('div');
    modal.id = 'noAnswerVoiceOverlay';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2100;';
    modal.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:24px;min-width:320px;text-align:center;">
            <h5 style="color:#c00;margin-bottom:8px;">No answer</h5>
            <p style="color:#666;margin-bottom:16px;">The call was not answered. Would you like to try again?</p>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="redialVoiceBtn" class="btn btn-primary">Try again</button>
                <button id="cancelNoAnswerVoiceBtn" class="btn btn-outline-secondary">Cancel</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('redialVoiceBtn').addEventListener('click', () => {
        modal.remove();
        if (socket && socket.connected) socket.emit('initiate_voice_call', { appointment_id: callInfo.appointment_id });
    });
    document.getElementById('cancelNoAnswerVoiceBtn').addEventListener('click', () => modal.remove());
}

function closeVoiceOverlays() {
    ['outgoingVoiceOverlay','incomingVoiceOverlay','noAnswerVoiceOverlay'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (el._ringTimeout) clearTimeout(el._ringTimeout);
            el.remove();
        }
    });
    stopRingtone();
}

// -------------------------
// In-page Video Call UI
// -------------------------

// Create tone-based ringtone using Web Audio API (no external file required)
let _ringAudioCtx = null;
let _ringOsc = null;
function playRingtone(loop=true, frequency=440) {
    try {
        if (!_ringAudioCtx) _ringAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        _ringOsc = _ringAudioCtx.createOscillator();
        const gain = _ringAudioCtx.createGain();
        _ringOsc.type = 'sine';
        _ringOsc.frequency.setValueAtTime(frequency, _ringAudioCtx.currentTime);
        _ringOsc.connect(gain);
        gain.connect(_ringAudioCtx.destination);
        gain.gain.setValueAtTime(0.0001, _ringAudioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.2, _ringAudioCtx.currentTime + 0.02);
        _ringOsc.start();
        // optional pulsing
        if (loop) {
            let on = true;
            _ringOsc._pulse = setInterval(() => {
                gain.gain.cancelScheduledValues(_ringAudioCtx.currentTime);
                if (on) {
                    gain.gain.setValueAtTime(0.2, _ringAudioCtx.currentTime);
                } else {
                    gain.gain.setValueAtTime(0.0001, _ringAudioCtx.currentTime);
                }
                on = !on;
            }, 600);
        }
    } catch (e) {
        console.warn('Ringtone failed:', e);
    }
}

function stopRingtone() {
    try {
        if (_ringOsc) {
            if (_ringOsc._pulse) clearInterval(_ringOsc._pulse);
            _ringOsc.stop();
            _ringOsc.disconnect();
            _ringOsc = null;
        }
    } catch(e){}
}

// Outgoing video overlay (caller)
function showOutgoingVideoOverlay(callInfo) {
    closeVideoOverlays();
    const overlay = document.createElement('div');
    overlay.id = 'outgoingVideoOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2000;';
    overlay.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:28px;min-width:320px;max-width:420px;text-align:center;">
            <div id="callieAvatar" style="width:96px;height:96px;border-radius:50%;margin:0 auto 12px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:32px;"></div>
            <div id="callieName" style="font-weight:700;margin-bottom:6px;">${escapeHtml(callInfo.callee_name || 'Caller')}</div>
            <div style="color:#666;margin-bottom:14px;">Video call</div>
            <div id="outgoingCallStatus" style="margin-bottom:16px;color:#999;">Ringing...</div>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="endOutgoingCallBtn" class="btn btn-danger">End call</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    // populate avatar
    const avatar = document.getElementById('callieAvatar');
    if (callInfo.callee_profile_picture) {
        avatar.innerHTML = `<img src="${callInfo.callee_profile_picture}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    } else {
        avatar.textContent = getInitials(callInfo.callee_name || 'User');
    }

    // handlers
    document.getElementById('endOutgoingCallBtn').addEventListener('click', () => {
        stopRingtone();
        if (socket && socket.connected) socket.emit('end_call', { appointment_id: callInfo.appointment_id, ended_by: currentUserId });
        showNoAnswerOverlay(callInfo);
        closeVideoOverlays();
    });

    // play ringtone for caller
    playRingtone(true, 480);

    // ring timeout 60 seconds
    overlay._ringTimeout = setTimeout(() => {
        stopRingtone();
        // end call due to no answer
        if (socket && socket.connected) socket.emit('reject_video_call', { appointment_id: callInfo.appointment_id, reason: 'no_answer' });
        closeVideoOverlays();
        showNoAnswerOverlay(callInfo);
    }, 60000);
}

function showNoAnswerOverlay(callInfo) {
    closeVideoOverlays();
    const modal = document.createElement('div');
    modal.id = 'noAnswerOverlay';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2100;';
    modal.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:24px;min-width:320px;text-align:center;">
            <h5 style="color:#c00;margin-bottom:8px;">No answer</h5>
            <p style="color:#666;margin-bottom:16px;">The call was not answered. Would you like to redial?</p>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="redialBtn" class="btn btn-primary">Redial</button>
                <button id="cancelNoAnswerBtn" class="btn btn-outline-secondary">Cancel</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('redialBtn').addEventListener('click', () => {
        modal.remove();
        if (socket && socket.connected) socket.emit('initiate_video_call', { caller_id: currentUserId, callee_id: callInfo.callee, appointment_id: callInfo.appointment_id });
    });
    document.getElementById('cancelNoAnswerBtn').addEventListener('click', () => modal.remove());
}

// Incoming video overlay (callie)
function showIncomingVideoOverlay(callInfo) {
    closeVideoOverlays();
    const overlay = document.createElement('div');
    overlay.id = 'incomingVideoOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2000;';
    overlay.innerHTML = `
        <div style="background:#fff;border-radius:12px;padding:26px;min-width:320px;max-width:420px;text-align:center;">
            <div id="callerAvatar" style="width:96px;height:96px;border-radius:50%;margin:0 auto 12px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:32px;"></div>
            <div id="callerName" style="font-weight:700;margin-bottom:6px;">${escapeHtml(callInfo.caller_name || 'Caller')}</div>
            <div id="callerRole" style="color:#666;margin-bottom:14px;">Incoming video call from ${escapeHtml(callInfo.caller_role || '')}</div>
            <div style="display:flex;gap:12px;justify-content:center;">
                <button id="acceptIncomingVideoBtn" class="btn btn-success">Accept</button>
                <button id="hangupIncomingVideoBtn" class="btn btn-danger">Hang up</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    const avatar = document.getElementById('callerAvatar');
    if (callInfo.caller_profile_picture) {
        avatar.innerHTML = `<img src="${callInfo.caller_profile_picture}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    } else {
        avatar.textContent = getInitials(callInfo.caller_name || 'User');
    }

    // play incoming ringtone
    playRingtone(true, 380);

    document.getElementById('acceptIncomingVideoBtn').addEventListener('click', () => {
        stopRingtone();
        if (socket && socket.connected) socket.emit('accept_video_call', { appointment_id: callInfo.appointment_id });
        // close overlay and navigate to call page when connected
        closeVideoOverlays();
    });

    document.getElementById('hangupIncomingVideoBtn').addEventListener('click', () => {
        stopRingtone();
        if (socket && socket.connected) socket.emit('reject_video_call', { appointment_id: callInfo.appointment_id, reason: 'hung_up' });
        closeVideoOverlays();
        // notify user and return to communication dashboard
        setTimeout(() => { window.location.href = '/patient/dashboard'; }, 400);
    });

    // auto-timeout - after 60s treat as missed
    overlay._ringTimeout = setTimeout(() => {
        stopRingtone();
        if (socket && socket.connected) socket.emit('reject_video_call', { appointment_id: callInfo.appointment_id, reason: 'no_answer' });
        closeVideoOverlays();
    }, 60000);
}

function closeVideoOverlays() {
    ['outgoingVideoOverlay','incomingVideoOverlay','noAnswerOverlay'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (el._ringTimeout) clearTimeout(el._ringTimeout);
            el.remove();
        }
    });
    stopRingtone();
}

// Call lifecycle listeners moved inside setupSocketIO() to ensure proper socket attachment

function showTestimonialPrompt(appointmentId, doctorId) {
    // render a small modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'testimonialOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2300;';
    overlay.innerHTML = `
        <div style="background:#fff;border-radius:10px;padding:20px;min-width:320px;max-width:600px;text-align:left;">
            <h5 style="margin-top:0;">Rate your doctor</h5>
            <p style="color:#666;margin-top:4px;margin-bottom:12px;">Please rate your consultation and leave feedback.</p>
            <div style="margin-bottom:12px;">
                <label style="font-weight:600;">Rating</label>
                <div id="testimonialStars" style="font-size:24px;color:#ffc107;">â­â­â­â­â­</div>
                <input type="range" id="testimonialRating" min="1" max="5" value="5" style="width:100%;">
            </div>
            <div style="margin-bottom:12px;">
                <label style="font-weight:600;">Feedback</label>
                <textarea id="testimonialContent" style="width:100%;height:100px;padding:8px;border:1px solid #ddd;border-radius:6px;"></textarea>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button id="submitTestimonialBtn" class="btn btn-primary">Submit</button>
                <button id="skipTestimonialBtn" class="btn btn-outline-secondary">Skip</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    const stars = document.getElementById('testimonialStars');
    const range = document.getElementById('testimonialRating');
    range.addEventListener('input', () => { stars.textContent = 'â˜…'.repeat(range.value) + 'â˜†'.repeat(5-range.value); });

    document.getElementById('submitTestimonialBtn').addEventListener('click', async () => {
        const rating = parseInt(range.value);
        const content = document.getElementById('testimonialContent').value;
        try {
            const res = await fetch(`/api/appointments/${appointmentId}/testimonial`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ rating: rating, content: content, is_public: true })
            });
            const j = await res.json();
            overlay.remove();
            // redirect to patient dashboard after feedback
            window.location.href = '/patient/dashboard';
        } catch (e) {
            console.error('Failed to submit testimonial', e);
            alert('Failed to submit testimonial');
        }
    });

    document.getElementById('skipTestimonialBtn').addEventListener('click', () => { overlay.remove(); window.location.href = '/patient/dashboard'; });
}

</script>
{% endblock %}
