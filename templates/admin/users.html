{% extends "base.html" %}

{% block title %}User Management - Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .status-badge {
        font-size: 0.75em;
    }
    .action-buttons .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .search-box {
        max-width: 300px;
    }
    .filter-dropdown {
        min-width: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">User Management</h1>
                    <p class="text-muted">Manage all users including admins, doctors, and patients.</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="fas fa-user-plus me-2"></i>Add New User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" placeholder="Search users..." id="searchInput">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="roleFilter">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="doctor">Doctor</option>
                                <option value="patient">Patient</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" id="resetFilters">
                                <i class="fas fa-refresh me-2"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">All Users ({{ users|length }} total)</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-3">
                                                {{ user.first_name[0] }}{{ user.last_name[0] }}
                                            </div>
                                            <div>
                                                <h6 class="mb-1">{{ user.first_name }} {{ user.last_name }}</h6>
                                                <small class="text-muted">@{{ user.username }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if user.role == 'admin' %}bg-danger
                                            {% elif user.role == 'doctor' %}bg-success
                                            {% else %}bg-info{% endif %}">
                                            {{ user.role|title }}
                                        </span>
                                    </td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.phone or 'N/A' }}</td>
                                    <td>
                                        <span class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %} status-badge">
                                            {{ 'Active' if user.is_active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ user.created_at.strftime('%Y-%m-%d') }}</small>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    data-bs-toggle="tooltip" 
                                                    title="Edit User"
                                                    data-action="edit"
                                                    data-user-id="{{ user.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" 
                                                    data-bs-toggle="tooltip" 
                                                    title="View Details"
                                                    data-action="view"
                                                    data-user-id="{{ user.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if user.id != current_user.id %}
                                            <button class="btn btn-sm btn-outline-{{ 'warning' if user.is_active else 'success' }} toggle-status" 
                                                    data-bs-toggle="tooltip" 
                                                    title="{{ 'Deactivate' if user.is_active else 'Activate' }}"
                                                    data-user-id="{{ user.id }}"
                                                    data-user-active="{{ 'true' if user.is_active else 'false' }}">
                                                <i class="fas fa-{{ 'ban' if user.is_active else 'check' }}"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger confirm-delete" 
                                                    data-bs-toggle="tooltip" 
                                                    title="Delete User"
                                                    data-user-id="{{ user.id }}"
                                                    data-user-name="{{ user.first_name }} {{ user.last_name }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <nav>
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <input type="hidden" name="user_id" id="userIdField">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-control" name="first_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-control" name="last_name" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Username *</label>
                                <input type="text" class="form-control" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Role *</label>
                                <select class="form-select" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="doctor">Doctor</option>
                                    <option value="patient">Patient</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" name="phone">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 position-relative">
                                <label class="form-label">Password *</label>
                                <input type="password" class="form-control" name="password" id="passwordField" required>
                                <button type="button" class="btn btn-sm btn-outline-secondary position-absolute" style="right:10px;top:38px;" id="togglePassword" tabindex="-1">Show</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3 position-relative">
                                <label class="form-label">Confirm Password *</label>
                                <input type="password" class="form-control" name="confirm_password" id="confirmPasswordField" required>
                                <button type="button" class="btn btn-sm btn-outline-secondary position-absolute" style="right:10px;top:38px;" id="toggleConfirmPassword" tabindex="-1">Show</button>
                            </div>
                        </div>
                    </div>
                    <div id="doctorFields" style="display: none;">
                        <hr>
                        <h6>Doctor Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Specialization *</label>
                                    <input type="text" class="form-control" name="specialization">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">License Number *</label>
                                    <input type="text" class="form-control" name="license_number">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addUserSubmitBtn" onclick="submitUserForm()">Add User</button>
            </div>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewUserBody">
                <!-- populated dynamically -->
                <p class="text-center text-muted">Loading...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Ensure Add New User button resets modal for creation
        $("button[data-bs-target='#addUserModal']").click(function() {
            const form = document.getElementById('addUserForm');
            form.reset();
            document.getElementById('userIdField').value = '';
            document.getElementById('addUserSubmitBtn').textContent = 'Add User';
            $('#doctorFields').hide();
        });

        // When modal is hidden, reset edit state
        $('#addUserModal').on('hidden.bs.modal', function () {
            const form = document.getElementById('addUserForm');
            form.reset();
            document.getElementById('userIdField').value = '';
            document.getElementById('addUserSubmitBtn').textContent = 'Add User';
            $('#doctorFields').hide();
        });

        // Show/hide doctor fields based on role selection
        $('select[name="role"]').change(function() {
            if ($(this).val() === 'doctor') {
                $('#doctorFields').show();
            } else {
                $('#doctorFields').hide();
            }
        });

        // Search functionality
        $('#searchInput').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('table tbody tr').each(function() {
                const text = $(this).text().toLowerCase();
                if (text.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Filter functionality
        $('#roleFilter, #statusFilter').change(function() {
            fetchUsers();
        });

        // Reset filters
        $('#resetFilters').click(function() {
            $('#searchInput').val('');
            $('#roleFilter').val('');
            $('#statusFilter').val('');
            $('table tbody tr').show();
        });

        // Delete confirmation
        $('.confirm-delete').click(function() {
            const userId = $(this).data('user-id');
            const userName = $(this).data('user-name');
            
            if (confirm(`Are you sure you want to delete ${userName}? This action cannot be undone.`)) {
                deleteUser(userId);
            }
        });

            });

    // Delegated handlers for edit/view and toggle status
    $(document).on('click', 'button[data-action][data-user-id]', function() {
        const userId = $(this).data('user-id');
        const action = $(this).data('action');
        if (action === 'edit') {
            editUser(userId);
        } else if (action === 'view') {
            viewUser(userId);
        }
    });
    $(document).on('click', 'button.toggle-status', function() {
        const userId = $(this).data('user-id');
        const isActiveRaw = $(this).data('user-active');
        const isActive = (isActiveRaw === true || isActiveRaw === 'true');
        toggleUserStatus(userId, isActive);
    });

    function filterUsers() {
        // legacy: replaced by server-side filtering via fetchUsers
        fetchUsers();
    }

    // Fetch users from server according to selected filters
    function fetchUsers() {
        const role = $('#roleFilter').val();
        const status = $('#statusFilter').val();
        const params = new URLSearchParams();
        if (role) params.append('role', role);
        if (status) params.append('status', status);

        fetch('/admin/users_data?' + params.toString(), {headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(r => r.json())
            .then(data => {
                if (data.error) { alert('Error: ' + data.error); return; }
                renderUsers(data.users || []);
            })
            .catch(err => { console.error('Failed to fetch users:', err); });
    }

    function renderUsers(users) {
        const tbody = document.querySelector('table tbody');
        tbody.innerHTML = '';
        users.forEach(u => {
            const statusBadge = u.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
            const roleBadgeClass = u.role === 'admin' ? 'bg-danger' : (u.role === 'doctor' ? 'bg-success' : 'bg-info');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-3">${(u.first_name||'')[0] || ''}${(u.last_name||'')[0] || ''}</div>
                        <div>
                            <h6 class="mb-1">${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')}</h6>
                            <small class="text-muted">@${escapeHtml(u.username || '')}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge ${roleBadgeClass}">${escapeHtml((u.role||'').charAt(0).toUpperCase() + (u.role||'').slice(1))}</span>
                </td>
                <td>${escapeHtml(u.email || '')}</td>
                <td>${escapeHtml(u.phone || 'N/A')}</td>
                <td>${statusBadge}</td>
                <td><small class="text-muted">${u.created_at ? (new Date(u.created_at)).toISOString().slice(0,10) : ''}</small></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="Edit User" data-action="edit" data-user-id="${u.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="View Details" data-action="view" data-user-id="${u.id}"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-outline-${u.is_active ? 'warning' : 'success'} toggle-status" data-bs-toggle="tooltip" title="${u.is_active ? 'Deactivate' : 'Activate'}" data-user-id="${u.id}" data-user-active="${u.is_active ? 'true' : 'false'}"><i class="fas fa-${u.is_active ? 'ban' : 'check'}"></i></button>
                        <button class="btn btn-sm btn-outline-danger confirm-delete" data-bs-toggle="tooltip" title="Delete User" data-user-id="${u.id}" data-user-name="${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')}"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // simple HTML escape for values inserted into the DOM
    function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/[&<>"']/g, function(c) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]; });
    }

    // initial load
    fetchUsers();

    function editUser(userId) {
        // Populate add/edit modal with user data
        fetch(`/admin/user/${userId}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) { alert('Error: ' + data.error); return; }
                const form = document.getElementById('addUserForm');
                form.querySelector('input[name="first_name"]').value = data.first_name || '';
                form.querySelector('input[name="last_name"]').value = data.last_name || '';
                form.querySelector('input[name="username"]').value = data.username || '';
                form.querySelector('input[name="email"]').value = data.email || '';
                form.querySelector('input[name="phone"]').value = data.phone || '';
                form.querySelector('select[name="role"]').value = data.role || '';
                // show/hide doctor fields
                if (data.role === 'doctor') { $('#doctorFields').show(); } else { $('#doctorFields').hide(); }
                document.getElementById('userIdField').value = data.id;
                document.getElementById('addUserSubmitBtn').textContent = 'Save Changes';
                $('#addUserModal').modal('show');
            })
            .catch(err => { console.error(err); alert('Failed to load user'); });
    }

    function viewUser(userId) {
        // Fetch and show user details in modal
        const modalBody = document.getElementById('viewUserBody');
        modalBody.innerHTML = '<p class="text-center text-muted">Loading...</p>';
        fetch(`/admin/user/${userId}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) { modalBody.innerHTML = '<p class="text-danger">' + data.error + '</p>'; return; }
                modalBody.innerHTML = `
                    <dl class="row">
                        <dt class="col-sm-4">Username</dt><dd class="col-sm-8">${data.username}</dd>
                        <dt class="col-sm-4">Name</dt><dd class="col-sm-8">${data.first_name} ${data.last_name}</dd>
                        <dt class="col-sm-4">Email</dt><dd class="col-sm-8">${data.email}</dd>
                        <dt class="col-sm-4">Phone</dt><dd class="col-sm-8">${data.phone || 'N/A'}</dd>
                        <dt class="col-sm-4">Role</dt><dd class="col-sm-8">${data.role}</dd>
                        <dt class="col-sm-4">Status</dt><dd class="col-sm-8">${data.is_active ? 'Active' : 'Inactive'}</dd>
                    </dl>
                `;
                $('#viewUserModal').modal('show');
            })
            .catch(err => { console.error(err); modalBody.innerHTML = '<p class="text-danger">Failed to load</p>'; });
    }

    function toggleUserStatus(userId, isActive) {
        const action = isActive ? 'deactivate' : 'activate';
        if (!confirm(`Are you sure you want to ${action} this user?`)) return;
        // include CSRF token
        const token = document.querySelector('input[name="csrf_token"]') ? document.querySelector('input[name="csrf_token"]').value : '';
        const params = new URLSearchParams({'user_id': userId});
        if (token) params.append('csrf_token', token);

        fetch('/admin/toggle_user_status', {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: params
        }).then(r => r.json()).then(data => {
            if (data.success) {
                // update button appearance
                const btn = document.querySelector(`button.toggle-status[data-user-id='${userId}']`);
                if (btn) {
                    const active = data.is_active;
                    btn.classList.remove(active ? 'btn-outline-success' : 'btn-outline-warning');
                    btn.classList.add(active ? 'btn-outline-warning' : 'btn-outline-success');
                    btn.setAttribute('data-user-active', active ? 'true' : 'false');
                    btn.setAttribute('title', active ? 'Deactivate' : 'Activate');
                    btn.querySelector('i').className = active ? 'fas fa-ban' : 'fas fa-check';
                }
            } else {
                alert('Error: ' + (data.error || 'Unknown'));
            }
        }).catch(err => { console.error(err); alert('Request failed'); });
    }

    function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
        const token = document.querySelector('input[name="csrf_token"]') ? document.querySelector('input[name="csrf_token"]').value : '';
        const params = new URLSearchParams({'user_id': userId});
        if (token) params.append('csrf_token', token);

        fetch('/admin/delete_user', {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: params
        }).then(r => r.json()).then(data => {
            if (data.success) {
                // remove row from table
                const row = document.querySelector(`button.confirm-delete[data-user-id='${userId}']`).closest('tr');
                if (row) row.remove();
            } else {
                alert('Error deleting user: ' + (data.error || 'Unknown'));
            }
        }).catch(err => { console.error(err); alert('Request failed'); });
    }

    function submitUserForm() {
        const form = document.getElementById('addUserForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const password = form.querySelector('input[name="password"]').value;
        const confirm = form.querySelector('input[name="confirm_password"]').value;
        if (password !== confirm) {
            alert('Passwords do not match');
            return;
        }
        // determine whether this is a create or update (edit sets user_id)
        const userId = document.getElementById('userIdField').value;
        const isEdit = userId && userId.trim() !== '';
        const url = isEdit ? '{{ url_for("admin_update_user") }}' : '{{ url_for("add_user") }}';

        const formData = new FormData(form);
        // ensure csrf present (form already contains hidden csrf_token)
        // for safety, also append if missing
        if (!formData.has('csrf_token')) {
            const tokenInput = document.querySelector('input[name="csrf_token"]');
            if (tokenInput) formData.append('csrf_token', tokenInput.value);
        }

        // If editing ensure user_id is sent
        if (isEdit) formData.set('user_id', userId);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.success) {
                // Reload to show new/updated user in the table
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            console.error('Error submitting user form:', err);
            alert('Error submitting form');
        });
    }

    // Password visibility toggles
    document.getElementById('togglePassword').addEventListener('click', function(e) {
        const p = document.getElementById('passwordField');
        if (p.type === 'password') { p.type = 'text'; this.textContent = 'Hide'; } else { p.type = 'password'; this.textContent = 'Show'; }
    });
    document.getElementById('toggleConfirmPassword').addEventListener('click', function(e) {
        const p = document.getElementById('confirmPasswordField');
        if (p.type === 'password') { p.type = 'text'; this.textContent = 'Hide'; } else { p.type = 'password'; this.textContent = 'Show'; }
    });
</script>
{% endblock %}